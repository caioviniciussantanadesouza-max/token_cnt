<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>CNT — Centro Natural TEC Amazônia</title>

<style>
:root{
  --bg0:#000;
  --bg1:#050b10;
  --hud: rgba(110,210,255,.92);
  --hud2: rgba(110,210,255,.45);
  --stroke: rgba(110,210,255,.18);
  --glass: rgba(2,12,24,.46);
  --glass2: rgba(2,12,24,.26);
  --text: #c8f3ff;
  --muted:#86dcff;
  --shadow: 0 0 22px rgba(110,210,255,.14), 0 0 70px rgba(0,200,255,.08);
}

*{ box-sizing:border-box; }
html,body{ height:100%; margin:0; background: radial-gradient(1200px 700px at 50% -10%, #0b2a3a 0%, #02070c 55%, #000 100%); color:var(--text); font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }

.wrap{ max-width: 1220px; margin: 18px auto; padding: 0 14px; }
.hero{
  border: 1px solid var(--stroke);
  border-radius: 26px;
  background: linear-gradient(180deg, rgba(0,0,0,.68), rgba(0,0,0,.40));
  box-shadow: var(--shadow);
  padding: 18px 18px 16px;
  text-align:center;
}
.hero h1{ margin: 2px 0 6px; font-size: clamp(26px, 3.2vw, 42px); letter-spacing: .6px; }
.hero .sub{ margin:0; color: var(--muted); font-size: 14px; opacity:.92; }

.pills{ margin-top: 12px; display:flex; flex-wrap:wrap; gap:10px; justify-content:center; }
.pill{
  padding: 8px 12px;
  border-radius: 999px;
  border: 1px solid var(--stroke);
  background: rgba(0,0,0,.35);
  color: var(--text);
  font-size: 13px;
  box-shadow: inset 0 0 0 1px rgba(110,210,255,.06);
}

.grid{
  margin-top: 14px;
  display: grid;
  grid-template-columns: 340px 1fr 320px;
  gap: 14px;
  align-items: start;
}

.card{
  border: 1px solid var(--stroke);
  border-radius: 22px;
  background: linear-gradient(180deg, rgba(0,0,0,.66), rgba(0,0,0,.42));
  box-shadow: var(--shadow);
  padding: 14px;
  min-height: 120px;
}

.card h3{ margin: 4px 0 10px; font-size: 13px; color: var(--muted); font-weight: 600; letter-spacing: .3px; }
.big{
  display:flex; align-items: baseline; gap:8px;
  margin: 0 0 4px;
}
.big .n{ font-size: 56px; font-weight: 300; letter-spacing: .5px; }
.big .u{ opacity:.8; }
.small{ color: var(--muted); font-size: 13px; opacity:.9; }

.row{
  margin-top: 10px;
  display:flex;
  flex-direction: column;
  gap:10px;
}
.kv{
  display:flex; justify-content: space-between; align-items:center;
  padding: 10px 12px;
  border-radius: 14px;
  border: 1px solid rgba(110,210,255,.16);
  background: rgba(0,0,0,.30);
}
.kv b{ font-weight:600; }
.kv span{ color: var(--text); opacity:.95; }

.subgrid{
  margin-top: 10px;
  display:grid;
  grid-template-columns: 1fr 1fr;
  gap:10px;
}
.badge{
  padding: 10px 12px;
  border-radius: 14px;
  border: 1px solid rgba(110,210,255,.16);
  background: rgba(0,0,0,.30);
  display:flex; justify-content: space-between; align-items: baseline;
}
.badge .k{ color: var(--muted); font-weight:600; letter-spacing:.2px; }
.badge .v{ color: var(--text); font-weight:700; }

.mapCard{ padding: 0; overflow:hidden; position: relative; }
.mapHead{
  padding: 12px 14px;
  display:flex; align-items:center; justify-content: space-between;
  border-bottom: 1px solid rgba(110,210,255,.14);
}
.mapHead .title{ font-weight:700; letter-spacing:.3px; }
.mapHead .meta{ color: var(--muted); font-size: 12px; opacity:.9; }

.mapWrap{
  position: relative;
  width: 100%;
  height: 520px;
  background: radial-gradient(900px 500px at 50% 30%, rgba(15,60,80,.45), rgba(0,0,0,.75));
}
canvas{ position:absolute; inset:0; width:100%; height:100%; display:block; }
#mapBase{ opacity: .95; filter: saturate(1.05) contrast(1.05); }
#hud{ mix-blend-mode: screen; }
#hudGlow{ filter: blur(8px); opacity:.55; mix-blend-mode: screen; }
#loadingOverlay{
  position:absolute; inset:0;
  display:flex; flex-direction:column; align-items:center; justify-content:center;
  gap:8px;
  color: var(--muted);
  background: radial-gradient(800px 500px at 50% 40%, rgba(0,0,0,.18), rgba(0,0,0,.66));
  text-align:center;
}
#loadingOverlay strong{ color: var(--text); font-size: 14px; }
#loadingOverlay small{ opacity:.9; }

.buyCard h2{ margin: 2px 0 6px; font-size: 22px; letter-spacing: .6px; }
.buyCard p{ margin: 0 0 12px; color: var(--muted); }

.field{ display:flex; gap:10px; align-items:center; }
input{
  width: 100%;
  padding: 12px 12px;
  border-radius: 14px;
  border: 1px solid rgba(110,210,255,.22);
  background: rgba(0,0,0,.35);
  color: var(--text);
  outline: none;
}
button{
  padding: 12px 14px;
  border-radius: 14px;
  border: 1px solid rgba(110,210,255,.30);
  background: linear-gradient(180deg, rgba(110,210,255,.15), rgba(0,0,0,.20));
  color: var(--text);
  font-weight: 700;
  cursor:pointer;
  box-shadow: inset 0 0 0 1px rgba(110,210,255,.10);
}
button:active{ transform: translateY(1px); }

.hr{ height:1px; background: rgba(110,210,255,.12); margin: 14px 0; }
.teleBox{ height: 140px; border-radius: 16px; border: 1px solid rgba(110,210,255,.14); background: rgba(0,0,0,.25); position: relative; overflow:hidden; }
.teleBox svg{ width:100%; height:100%; display:block; }

.footerNote{ margin-top: 8px; font-size: 12px; color: var(--muted); opacity:.85; }

@media (max-width: 980px){
  .grid{ grid-template-columns: 1fr; }
  .mapWrap{ height: 440px; }
}
</style>
</head>

<body>
<div class="wrap">
  <div class="hero">
    <h1>CNT — Centro Natural TEC Amazônia</h1>
    <p class="sub">Mapa ecológico real • Água (azul) • Vegetação (verde) • Transição (amarelo) • Desmatamento (vermelho)</p>
    <div class="pills">
      <div class="pill">Fonte: dados públicos governamentais</div>
      <div class="pill">Ano base: 2025</div>
      <div class="pill" id="pillPts">Pontos: iniciando…</div>
      <div class="pill">Compra: Pump.fun</div>
    </div>
  </div>

  <div class="grid">
    <!-- PAINEL ÍNDICES (ESQUERDA NO DESKTOP; NO MOBILE VEM PRIMEIRO POR CSS) -->
    <div class="card" id="cardIndex" style="order:1;">
      <h3><span style="color:var(--hud)">CNT</span> (índice único Brasil)</h3>

      <div class="big">
        <div class="n" id="cntMain">--</div>
        <div class="u">/100</div>
      </div>
      <div class="small">RAW auditável: <b id="cntRaw">--</b></div>

      <div class="row">
        <div class="kv"><b>A — Estado</b><span id="aEstado">--</span></div>
        <div class="kv"><b>B — Tendência</b><span id="bTend">--</span></div>
        <div class="kv"><b>C — Estabilidade</b><span id="cEstab">--</span></div>
        <div class="kv"><b>Grau</b><span id="grau">--</span></div>
      </div>

      <h3 style="margin-top:14px;">Sub-índices</h3>
      <div class="subgrid">
        <div class="badge"><span class="k">IBE</span><span class="v" id="ibe">--</span></div>
        <div class="badge"><span class="k">IAB</span><span class="v" id="iab">--</span></div>
        <div class="badge"><span class="k">IBI</span><span class="v" id="ibi">--</span></div>
        <div class="badge"><span class="k">HID</span><span class="v" id="hid">--</span></div>
        <div class="badge"><span class="k">ENT</span><span class="v" id="ent">--</span></div>
        <div class="badge"><span class="k">PAN</span><span class="v" id="pan">--</span></div>
      </div>

      <div class="footerNote" id="status">Status: iniciando…</div>
    </div>

    <!-- MAPA (CENTRO) -->
    <div class="card mapCard" style="order:2;">
      <div class="mapHead">
        <div class="title">HUD holográfico (pontilhado)</div>
        <div class="meta" id="metaInfo">base: mapa_base.png</div>
      </div>

      <div class="mapWrap">
        <canvas id="mapBase"></canvas>
        <canvas id="hudGlow"></canvas>
        <canvas id="hud"></canvas>

        <div id="loadingOverlay">
          <strong>Carregando mapa + pontos…</strong>
          <small id="loadMsg">Se demorar, é caminho errado no GitHub Pages. Este index já corrige isso.</small>
        </div>
      </div>
    </div>

    <!-- DIREITA (COMPRA + TELEMETRIA) -->
    <div class="card buyCard" id="cardBuy" style="order:3;">
      <h2>COMPRAR CNT</h2>
      <p>Abre o token no Pump.fun.</p>

      <div class="field">
        <input id="inpContrib" type="number" step="0.01" min="0" value="0.10" />
      </div>

      <div style="margin-top:10px;">
        <button id="btnBuy" style="width:100%;">Comprar no Pump</button>
      </div>

      <div class="small" style="margin-top:12px;">
        Estimativa: <b id="estCnt">-- CNT</b><br/>
        <span style="opacity:.8;">Estimativa demo (não é cotação real).</span>
      </div>

      <div class="hr"></div>

      <h3 style="margin:0 0 8px; font-size:14px;">TELEMETRIA — Série 10 anos</h3>
      <div class="teleBox" id="teleBox"></div>
      <div class="footerNote" id="teleNote">Histórico: 10 • Último (RAW): <span id="teleLast">--</span></div>
    </div>
  </div>
</div>

<script>
/* ================================
   CONFIG (troca só isso)
=================================== */
const PUMP_URL = "https://pump.fun/coin/GCVyjNaCbXkwGUuktyNxSXad4ozmTp2fzQr2jieSpump";

/* ================================
   BASE ROBUSTA (GitHub Pages safe)
   -> sempre a pasta do index.html
=================================== */
const BASE_URL = new URL("./", document.baseURI);
const fileURL = (name)=> new URL(name, BASE_URL).toString();

async function fetchJSON(name){
  const url = fileURL(name);
  const r = await fetch(url, { cache: "no-store" });
  if(!r.ok) throw new Error(`HTTP ${r.status} ao carregar: ${name}`);
  return await r.json();
}

/* ================================
   DEBUG NA TELA (para nunca mentir)
=================================== */
window.addEventListener("unhandledrejection", (e)=>{
  const msg = (e.reason && e.reason.message) ? e.reason.message : String(e.reason);
  const s = document.getElementById("status");
  if(s) s.textContent = "ERRO: " + msg;
});
window.addEventListener("error", (e)=>{
  const s = document.getElementById("status");
  if(s) s.textContent = "ERRO: " + (e.message || "desconhecido");
});

/* ================================
   HELPERS
=================================== */
const clamp=(v,a,b)=>Math.max(a,Math.min(b,v));
const lerp=(a,b,t)=>a+(b-a)*t;

function pickColor(cls){
  // cls pode ser string: "water" "veg" "trans" "defor"
  // ou número 0..3
  const c = (typeof cls==="string") ? cls : ["water","veg","trans","defor"][cls|0];
  if(c==="water") return { r: 80,  g:160, b:255 };   // azul
  if(c==="veg")   return { r: 60,  g:255, b:180 };   // verde neon
  if(c==="trans") return { r: 255, g:220, b:80  };   // amarelo
  return            { r: 255, g:90,  b:90  };        // vermelho
}

function fmt(n){
  if(n===null || n===undefined || Number.isNaN(n)) return "--";
  if(typeof n==="string") return n;
  const s = (Math.round(n*100)/100).toString().replace(".",",");
  return s;
}

/* ================================
   DADOS (fallback rápido)
=================================== */
const FALLBACK_INDICES = {
  cnt: 72.4,
  raw: 18.11,
  A: 72.44,
  B: -0.10,
  C: 0.49,
  grau: "E",
  IBE: 55.2,
  IAB: "N/D",
  IBI: 23.5,
  HID: 1.03,
  ENT: 86.2,
  PAN: 11.7
};

function updateIndices(d){
  document.getElementById("cntMain").textContent = fmt(d.cnt);
  document.getElementById("cntRaw").textContent = fmt(d.raw);
  document.getElementById("aEstado").textContent = fmt(d.A);
  document.getElementById("bTend").textContent = fmt(d.B);
  document.getElementById("cEstab").textContent = fmt(d.C);
  document.getElementById("grau").textContent = fmt(d.grau);

  document.getElementById("ibe").textContent = fmt(d.IBE);
  document.getElementById("iab").textContent = fmt(d.IAB);
  document.getElementById("ibi").textContent = fmt(d.IBI);
  document.getElementById("hid").textContent = fmt(d.HID);
  document.getElementById("ent").textContent = fmt(d.ENT);
  document.getElementById("pan").textContent = fmt(d.PAN);
}

function renderTele(values){
  const box = document.getElementById("teleBox");
  const w = box.clientWidth || 300, h = box.clientHeight || 140;
  const min = Math.min(...values), max = Math.max(...values);
  const pad = 14;

  const pts = values.map((v,i)=>{
    const x = lerp(pad, w-pad, i/(values.length-1));
    const t = (v-min)/(max-min || 1);
    const y = lerp(h-pad, pad, t);
    return [x,y];
  });

  let d = `M ${pts[0][0].toFixed(1)} ${pts[0][1].toFixed(1)}`;
  for(let i=1;i<pts.length;i++) d += ` L ${pts[i][0].toFixed(1)} ${pts[i][1].toFixed(1)}`;

  box.innerHTML = `
    <svg viewBox="0 0 ${w} ${h}" preserveAspectRatio="none">
      <path d="${d}" fill="none" stroke="rgba(110,210,255,.95)" stroke-width="2.2"/>
      <path d="${d}" fill="none" stroke="rgba(110,210,255,.25)" stroke-width="8" filter="url(#g)"/>
      <defs>
        <filter id="g">
          <feGaussianBlur stdDeviation="3.5" />
        </filter>
      </defs>
    </svg>
  `;
}

/* ================================
   MAPA BASE (imagem)
=================================== */
function drawBaseImage(img){
  const c = document.getElementById("mapBase");
  const ctx = c.getContext("2d", { alpha:true });

  const rect = c.getBoundingClientRect();
  c.width = Math.max(1, Math.floor(rect.width * devicePixelRatio));
  c.height = Math.max(1, Math.floor(rect.height * devicePixelRatio));

  ctx.clearRect(0,0,c.width,c.height);

  // fit contain
  const iw = img.naturalWidth, ih = img.naturalHeight;
  const cw = c.width, ch = c.height;
  const s = Math.min(cw/iw, ch/ih);
  const dw = iw*s, dh = ih*s;
  const dx = (cw-dw)/2, dy = (ch-dh)/2;

  ctx.drawImage(img, dx, dy, dw, dh);

  return { dx, dy, dw, dh, iw, ih, s };
}

/* ================================
   PONTOS HOLOGRÁFICOS
   Formato esperado (qualquer um):
   - [{lon,lat,cls}]   cls: "water|veg|trans|defor"
   - [{x,y,cls}]       x,y em 0..1 (normalizado)
   - GeoJSON FeatureCollection (Point) com properties.cls
=================================== */
function normalizePoints(raw){
  // GeoJSON
  if(raw && raw.type==="FeatureCollection" && Array.isArray(raw.features)){
    const pts=[];
    for(const f of raw.features){
      if(!f || !f.geometry) continue;
      if(f.geometry.type!=="Point") continue;
      const [lon,lat] = f.geometry.coordinates || [];
      const cls = (f.properties && (f.properties.cls || f.properties.class || f.properties.tipo)) || "veg";
      pts.push({ lon, lat, cls });
    }
    return pts;
  }
  // Array simples
  if(Array.isArray(raw)){
    return raw.map(p=>{
      if(p==null) return null;
      if(Array.isArray(p) && p.length>=2) return { lon:p[0], lat:p[1], cls:"veg" };
      if("lon" in p && "lat" in p) return { lon:p.lon, lat:p.lat, cls: p.cls || "veg" };
      if("x" in p && "y" in p) return { x:p.x, y:p.y, cls: p.cls || "veg" };
      return null;
    }).filter(Boolean);
  }
  return [];
}

// Projeção simples BR bounding box -> canvas (rápida e offline)
const BR_BBOX = { minLon:-74.0, maxLon:-34.0, minLat:-34.0, maxLat:  6.0 };

function lonLatToNorm(lon,lat){
  const x = (lon - BR_BBOX.minLon) / (BR_BBOX.maxLon - BR_BBOX.minLon);
  const y = 1 - (lat - BR_BBOX.minLat) / (BR_BBOX.maxLat - BR_BBOX.minLat);
  return { x: clamp(x,0,1), y: clamp(y,0,1) };
}

function startHologram(points, fit){
  const c = document.getElementById("hud");
  const g = document.getElementById("hudGlow");
  const ctx = c.getContext("2d", { alpha:true });
  const gtx = g.getContext("2d", { alpha:true });

  function resize(){
    const rect = c.getBoundingClientRect();
    c.width  = Math.max(1, Math.floor(rect.width * devicePixelRatio));
    c.height = Math.max(1, Math.floor(rect.height * devicePixelRatio));
    g.width = c.width; g.height = c.height;
  }
  resize();

  // Pré-calcula coordenadas (performance)
  const pts = points.map(p=>{
    let nx, ny;
    if("x" in p && "y" in p){ nx=p.x; ny=p.y; }
    else{
      const n = lonLatToNorm(p.lon, p.lat);
      nx=n.x; ny=n.y;
    }
    // encaixa na área do mapa base (fit contain)
    const x = (fit.dx + nx*fit.dw) * devicePixelRatio;
    const y = (fit.dy + ny*fit.dh) * devicePixelRatio;
    const cls = p.cls || "veg";
    return { x, y, cls };
  });

  const pill = document.getElementById("pillPts");
  pill.textContent = `Pontos: ${pts.length.toLocaleString("pt-BR")} (holograma)`;

  // animação pulsante
  let t0 = performance.now();
  function frame(now){
    const t = (now - t0) * 0.001;

    ctx.clearRect(0,0,c.width,c.height);
    gtx.clearRect(0,0,g.width,g.height);

    // pulsação global ligada ao "índice"
    const idx = parseFloat(String(document.getElementById("cntMain").textContent).replace(",",".")) || 70;
    const pulse = 0.55 + 0.45*Math.sin(t*2.2 + idx*0.02);

    // tamanho pontilhado (pequeno igual referência)
    const rBase = 0.9 * devicePixelRatio;
    const rGlow = 2.6 * devicePixelRatio;

    // desenha por classe para reduzir state changes
    for(const layer of ["water","veg","trans","defor"]){
      const col = pickColor(layer);
      // glow
      gtx.fillStyle = `rgba(${col.r},${col.g},${col.b},${0.12 + 0.18*pulse})`;
      // core
      ctx.fillStyle = `rgba(${col.r},${col.g},${col.b},${0.55 + 0.35*pulse})`;

      for(const p of pts){
        if((typeof p.cls==="string" ? p.cls : "veg") !== layer) continue;
        const jitter = 0.35 + 0.65*Math.sin(t*3.1 + (p.x||0)*0.01 + (p.y||0)*0.02);
        const r = rBase * (0.85 + 0.55*jitter);
        const rg = rGlow * (0.75 + 0.75*jitter);

        gtx.beginPath();
        gtx.arc(p.x, p.y, rg, 0, Math.PI*2);
        gtx.fill();

        ctx.beginPath();
        ctx.arc(p.x, p.y, r, 0, Math.PI*2);
        ctx.fill();
      }
    }

    // borda holográfica leve (sem “sólido”)
    ctx.save();
    ctx.globalCompositeOperation = "screen";
    ctx.strokeStyle = `rgba(110,210,255,${0.20 + 0.18*pulse})`;
    ctx.lineWidth = 1.2*devicePixelRatio;
    ctx.strokeRect(8*devicePixelRatio, 8*devicePixelRatio, c.width-16*devicePixelRatio, c.height-16*devicePixelRatio);
    ctx.restore();

    requestAnimationFrame(frame);
  }
  requestAnimationFrame(frame);

  window.addEventListener("resize", ()=>{ resize(); });
}

/* ================================
   PONTOS: tenta carregar arquivo real
   - preferir layers_points.json
   - senão vege_pts_sample.geojson
   - senão fallback (rápido)
=================================== */
function buildFallbackPoints(){
  // fallback rápido: pontos distribuídos, com mais veg e alguns trans/defor e água
  const pts=[];
  const N=6500;
  for(let i=0;i<N;i++){
    let cls="veg";
    const r=Math.random();
    if(r<0.08) cls="water";
    else if(r<0.22) cls="trans";
    else if(r<0.32) cls="defor";
    // distribuição levemente concentrada no centro-leste (parecido com referência)
    const x = clamp((Math.random()**0.65)*0.95 + 0.02, 0, 1);
    const y = clamp((Math.random()**0.85)*0.95 + 0.02, 0, 1);
    pts.push({ x, y, cls });
  }
  return pts;
}

/* ================================
   BOOT
=================================== */
async function boot(){
  const overlay = document.getElementById("loadingOverlay");
  const status = document.getElementById("status");
  const meta = document.getElementById("metaInfo");
  const pillPts = document.getElementById("pillPts");

  // botão Pump
  document.getElementById("btnBuy").addEventListener("click", ()=>{
    window.open(PUMP_URL, "_blank", "noopener,noreferrer");
  });

  // estimativa
  const inp = document.getElementById("inpContrib");
  function updateEst(){
    const v = parseFloat(inp.value || "0") || 0;
    const est = Math.floor(v * 147449130); // demo
    document.getElementById("estCnt").textContent = est.toLocaleString("pt-BR") + " CNT";
  }
  inp.addEventListener("input", updateEst);
  updateEst();

  // índices (tenta real; fallback se não tiver)
  updateIndices(FALLBACK_INDICES);
  try{
    const real = await fetchJSON("dados_cnt.json");
    // aceita vários formatos
    const d = {
      cnt: real.cnt ?? real.CNT ?? real.indice ?? real.index ?? FALLBACK_INDICES.cnt,
      raw: real.raw ?? real.RAW ?? FALLBACK_INDICES.raw,
      A: real.A ?? real.a ?? FALLBACK_INDICES.A,
      B: real.B ?? real.b ?? FALLBACK_INDICE
