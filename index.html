<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>MapBiomas 100M GPU</title>
<style>
body{margin:0;background:#000;overflow:hidden;}
canvas{display:block;}
</style>
</head>
<body>
<canvas id="gl"></canvas>

<script>
const canvas = document.getElementById("gl");
const gl = canvas.getContext("webgl2");
canvas.width = window.innerWidth;
canvas.height = window.innerHeight;
gl.viewport(0,0,canvas.width,canvas.height);

const vs = `#version 300 es
in vec2 position;
in float classe;
uniform float zoom;
out float vClasse;
void main(){
  gl_Position = vec4(position*zoom,0,1);
  gl_PointSize = 2.0;
  vClasse = classe;
}`;

const fs = `#version 300 es
precision highp float;
in float vClasse;
out vec4 fragColor;

vec3 color(float c){
  if(c==1.0) return vec3(0.0,1.0,0.5);
  if(c==2.0) return vec3(0.0,0.5,1.0);
  if(c==3.0) return vec3(1.0,0.1,0.1);
  return vec3(1.0,1.0,0.0);
}

void main(){
  float d = length(gl_PointCoord-vec2(0.5));
  float glow = smoothstep(0.5,0.0,d);
  fragColor = vec4(color(vClasse), glow);
}`;

function compile(type,src){
  const s=gl.createShader(type);
  gl.shaderSource(s,src);
  gl.compileShader(s);
  return s;
}

const program = gl.createProgram();
gl.attachShader(program,compile(gl.VERTEX_SHADER,vs));
gl.attachShader(program,compile(gl.FRAGMENT_SHADER,fs));
gl.linkProgram(program);
gl.useProgram(program);

let zoom=1;
window.addEventListener("wheel",e=>{
  zoom+=e.deltaY*-0.001;
  zoom=Math.max(0.5,Math.min(5,zoom));
});

fetch("points.bin")
.then(r=>r.arrayBuffer())
.then(buf=>{
  const data = new Float32Array(buf);

  const positions=[];
  const classes=[];

  for(let i=0;i<data.length;i+=3){
    positions.push(data[i],data[i+1]);
    classes.push(data[i+2]);
  }

  const posBuffer=gl.createBuffer();
  gl.bindBuffer(gl.ARRAY_BUFFER,posBuffer);
  gl.bufferData(gl.ARRAY_BUFFER,new Float32Array(positions),gl.STATIC_DRAW);
  const posLoc=gl.getAttribLocation(program,"position");
  gl.enableVertexAttribArray(posLoc);
  gl.vertexAttribPointer(posLoc,2,gl.FLOAT,false,0,0);

  const classBuffer=gl.createBuffer();
  gl.bindBuffer(gl.ARRAY_BUFFER,classBuffer);
  gl.bufferData(gl.ARRAY_BUFFER,new Float32Array(classes),gl.STATIC_DRAW);
  const classLoc=gl.getAttribLocation(program,"classe");
  gl.enableVertexAttribArray(classLoc);
  gl.vertexAttribPointer(classLoc,1,gl.FLOAT,false,0,0);

  const zoomLoc=gl.getUniformLocation(program,"zoom");

  function render(){
    gl.clear(gl.COLOR_BUFFER_BIT);
    gl.uniform1f(zoomLoc,zoom);
    gl.drawArrays(gl.POINTS,0,classes.length);
    requestAnimationFrame(render);
  }

  render();
});
</script>
</body>
</html>
