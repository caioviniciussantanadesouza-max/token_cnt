<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>CNT — Centro Natural TEC Amazônia</title>

<!-- (Opcional) Jupiter Plugin - deixe se você usa o botão/integração -->
<script src="https://plugin.jup.ag/plugin-v1.js" data-preload defer></script>

<style>
:root{
  --bg0:#000;
  --bg1:#050b10;
  --hud: rgba(110,210,255,.95);
  --hud2: rgba(110,210,255,.55);
  --stroke: rgba(110,210,255,.18);
  --glass: rgba(2,12,24,.46);
  --glass2: rgba(2,12,24,.28);
  --text: #c8f3ff;
  --muted:#86dcff;
  --shadow: 0 0 22px rgba(110,210,255,.14), 0 0 70px rgba(0,200,255,.08);
  --radius: 18px;
}
*{ box-sizing:border-box; }
html,body{
  margin:0;height:100%;
  background: radial-gradient(1200px 700px at 50% 35%, var(--bg1), var(--bg0) 70%);
  color:var(--text);
  font-family:"Segoe UI", Arial, sans-serif;
  overflow:hidden;
}
#app{
  position:fixed; inset:0;
  display:grid;
  grid-template-columns: 300px 1fr 360px;
  grid-template-rows: 120px minmax(0,1fr);
  gap:14px;
  padding:14px;
  align-items:stretch;
}

.glass{
  background: var(--glass);
  border: 1px solid var(--stroke);
  border-radius: var(--radius);
  box-shadow: var(--shadow);
  overflow:hidden;
  position:relative;
}
.header{
  grid-column: 1 / 4;
  padding: 14px 16px;
  display:flex;
  flex-direction:column;
  justify-content:center;
}
.brand{
  display:flex;
  align-items:baseline;
  justify-content:center;
  gap:10px;
  text-align:center;
}
.brand h1{
  margin:0;
  font-size:22px;
  letter-spacing:.6px;
}
.brand small{
  display:block;
  margin-top:6px;
  font-size:12px;
  color:var(--muted);
  opacity:.95;
}

.topchips{
  margin-top:10px;
  display:flex;
  gap:8px;
  justify-content:center;
  flex-wrap:wrap;
}
.chip{
  font-size:11px;
  color:var(--muted);
  border:1px solid var(--stroke);
  background: rgba(2,12,24,.26);
  padding:6px 10px;
  border-radius:999px;
  user-select:none;
}

.left, .right, .center{
  min-height: 520px; /* evita canvas 0px */
}
.left{ padding:14px; display:flex; flex-direction:column; gap:10px; }
.right{ padding:14px; display:flex; flex-direction:column; gap:12px; }
.center{
  padding:0;
  display:flex;
  flex-direction:column;
}
.panelTitle{
  font-size:12px;
  color:var(--muted);
  letter-spacing:.4px;
  text-transform:uppercase;
}
.bigIndex{
  font-size:48px;
  line-height:1;
  margin:6px 0 0;
}
.subline{
  font-size:12px;
  color:var(--muted);
  margin-top:6px;
}
.kv{
  display:flex;
  justify-content:space-between;
  gap:10px;
  font-size:12px;
  padding:10px 10px;
  border:1px solid var(--stroke);
  background: rgba(2,12,24,.22);
  border-radius: 12px;
}
.kv b{ font-weight:600; }
.kv span{ color:var(--muted); }

.grid2{
  display:grid;
  grid-template-columns: 1fr 1fr;
  gap:8px;
}
.mini{
  padding:10px;
  border:1px solid var(--stroke);
  border-radius: 12px;
  background: rgba(2,12,24,.22);
}
.mini .label{ font-size:11px; color:var(--muted); }
.mini .value{ margin-top:6px; font-size:18px; }

.buyBox{
  padding:12px;
  border:1px solid var(--stroke);
  border-radius: 14px;
  background: rgba(2,12,24,.26);
}
.buyBox h2{
  margin:0;
  font-size:16px;
  letter-spacing:.5px;
}
.buyBox p{
  margin:8px 0 10px;
  font-size:12px;
  color:var(--muted);
}
.row{
  display:flex;
  gap:10px;
  align-items:center;
}
.input{
  flex:1;
  border:1px solid var(--stroke);
  background: rgba(0,0,0,.35);
  color: var(--text);
  border-radius: 12px;
  padding:10px 12px;
  outline:none;
}
.btn{
  border:1px solid rgba(110,210,255,.35);
  background: rgba(110,210,255,.12);
  color: var(--text);
  border-radius: 12px;
  padding:10px 12px;
  cursor:pointer;
  font-weight:600;
  transition: transform .12s ease, background .12s ease;
}
.btn:hover{ transform: translateY(-1px); background: rgba(110,210,255,.18); }
.btn:active{ transform: translateY(0px); }

.chartBox{
  padding:12px;
  border:1px solid var(--stroke);
  border-radius: 14px;
  background: rgba(2,12,24,.26);
}
.spark{
  width:100%;
  height:90px;
  display:block;
  border-radius: 10px;
  background: rgba(0,0,0,.22);
  border:1px solid rgba(110,210,255,.12);
}

/* ======= MAPA (base + holograma alinhados) ======= */
.mapWrap{
  position:relative;
  width:100%;
  height:100%;
  min-height: 520px;
  overflow:hidden;
  border-radius: var(--radius);
}
.mapStage{
  position:absolute;
  inset:0;
  display:flex;
  align-items:center;
  justify-content:center;
  perspective: 900px;
}
.map3d{
  position:relative;
  width: min(100%, 980px);
  height: min(100%, 640px);
  aspect-ratio: 980/640;
  transform-style: preserve-3d;
  will-change: transform;
  filter: drop-shadow(0 0 20px rgba(110,210,255,.12));
}

/* O canvas SEMPRE no tamanho exato do stage */
#mapCanvas{
  position:absolute;
  inset:0;
  width:100%;
  height:100%;
  display:block;
  border-radius: 16px;
}

/* HUD overlay (não bloqueia clique) */
.hudOverlay{
  position:absolute;
  inset:0;
  pointer-events:none;
  z-index: 6;
}
.scanlines{
  position:absolute;
  inset:0;
  border-radius: 16px;
  background:
    repeating-linear-gradient(
      to bottom,
      rgba(110,210,255,.06) 0px,
      rgba(110,210,255,.06) 1px,
      rgba(0,0,0,0) 3px,
      rgba(0,0,0,0) 6px
    );
  opacity:.18;
  mix-blend-mode: screen;
  animation: scan 6s linear infinite;
}
@keyframes scan{
  0%{ transform: translateY(-12px); }
  100%{ transform: translateY(12px); }
}

.vignette{
  position:absolute;
  inset:0;
  border-radius:16px;
  background: radial-gradient(70% 60% at 50% 45%, rgba(0,0,0,0), rgba(0,0,0,.55) 85%);
  opacity:.9;
}

.borderGlow{
  position:absolute;
  inset:-2px;
  border-radius: 18px;
  border:1px solid rgba(110,210,255,.22);
  box-shadow: 0 0 28px rgba(110,210,255,.12), inset 0 0 28px rgba(110,210,255,.05);
  opacity:.9;
}

.legend{
  position:absolute;
  left:14px;
  bottom:14px;
  display:flex;
  gap:8px;
  flex-wrap:wrap;
  z-index:7;
  pointer-events:none;
}
.legend .tag{
  font-size:11px;
  color:var(--muted);
  border:1px solid rgba(110,210,255,.16);
  background: rgba(0,0,0,.25);
  padding:6px 10px;
  border-radius:999px;
}
.dot{
  display:inline-block;
  width:8px;height:8px;
  border-radius:50%;
  margin-right:6px;
  vertical-align:middle;
  box-shadow: 0 0 10px rgba(110,210,255,.18);
}

/* ALERTAS NO MAPA */
#alertsLayer{
  position:absolute;
  inset:0;
  z-index: 8;
  pointer-events:none;
}
.alertPin{
  position:absolute;
  transform: translate(-50%, -50%);
  width: 12px; height: 12px;
  border-radius: 999px;
  box-shadow: 0 0 14px rgba(255,80,80,.35);
  animation: pulse 1.8s ease-in-out infinite;
}
@keyframes pulse{
  0%,100%{ transform: translate(-50%, -50%) scale(1); opacity:.95; }
  50%{ transform: translate(-50%, -50%) scale(1.45); opacity:.55; }
}
.alertRing{
  position:absolute;
  transform: translate(-50%, -50%);
  width: 34px; height: 34px;
  border-radius: 999px;
  border:1px solid rgba(255,80,80,.35);
  box-shadow: 0 0 24px rgba(255,80,80,.18);
  animation: ring 1.8s ease-in-out infinite;
}
@keyframes ring{
  0%,100%{ transform: translate(-50%, -50%) scale(0.9); opacity:.45; }
  50%{ transform: translate(-50%, -50%) scale(1.2); opacity:.22; }
}

.toast{
  position:absolute;
  top:14px;
  right:14px;
  z-index:9;
  width: min(420px, calc(100% - 28px));
  display:flex;
  flex-direction:column;
  gap:8px;
  pointer-events:none;
}
.toastItem{
  pointer-events:none;
  border:1px solid rgba(255,100,100,.25);
  background: rgba(40,0,0,.22);
  border-radius: 14px;
  padding:10px 12px;
  box-shadow: 0 0 22px rgba(255,80,80,.10);
}
.toastItem b{ display:block; font-size:12px; letter-spacing:.3px; }
.toastItem span{ display:block; font-size:11px; color:rgba(255,200,200,.92); margin-top:4px; }

/* Responsivo */
@media (max-width: 1200px){
  #app{
    grid-template-columns: 300px 1fr;
    grid-template-rows: 120px minmax(0,1fr) minmax(0,1fr);
  }
  .header{ grid-column:1/3; }
  .right{ grid-column:1/3; }
}
@media (max-width: 860px){
  #app{
    grid-template-columns: 1fr;
    grid-template-rows: 120px minmax(0,1fr) minmax(0,1fr) minmax(0,1fr);
    overflow:auto;
  }
  html,body{ overflow:auto; }
  .header{ grid-column:1/2; }
}
</style>
</head>

<body>
<div id="app">

  <div class="glass header">
    <div class="brand">
      <h1>CNT — Centro Natural TEC Amazônia</h1>
    </div>
    <small style="text-align:center;color:var(--muted);">
      Mapa ecológico real • Água (azul) • Vegetação (verde) • Transição (amarelo) • Desmatamento (vermelho)
    </small>

    <div class="topchips">
      <div class="chip">Fonte: dados públicos governamentais</div>
      <div class="chip">Ano base: 2025</div>
      <div class="chip" id="statusChip">Status: iniciando…</div>
      <button class="chip btn" id="btnReload" style="pointer-events:auto;">Recarregar mapa</button>
      <button class="chip btn" id="btnFull" style="pointer-events:auto;">Carregar FULL (manual)</button>
      <button class="chip btn" id="btnPump" style="pointer-events:auto;">Compra: Pump.fun</button>
    </div>
  </div>

  <div class="glass left">
    <div class="panelTitle">CNT (Índice único Brasil)</div>
    <div class="bigIndex"><span id="score">72,4</span><span style="font-size:14px;color:var(--muted)">/100</span></div>
    <div class="subline">RAW auditável: <b id="raw">18,11</b></div>

    <div class="kv"><b>A — Estado</b><span id="aEstado">72,43</span></div>
    <div class="kv"><b>B — Tendência</b><span id="bTend">-0,10</span></div>
    <div class="kv"><b>C — Estabilidade</b><span id="cEstab">0,49</span></div>
    <div class="kv"><b>Grau</b><span id="grau">E</span></div>

    <div class="panelTitle" style="margin-top:4px;">Sub-índices</div>
    <div class="grid2">
      <div class="mini"><div class="label">IBE</div><div class="value" id="ibe">55,2</div></div>
      <div class="mini"><div class="label">IAB</div><div class="value" id="iab">N/D</div></div>
      <div class="mini"><div class="label">IBI</div><div class="value" id="ibi">23,5</div></div>
      <div class="mini"><div class="label">HID</div><div class="value" id="hid">1,03</div></div>
      <div class="mini"><div class="label">ENT</div><div class="value" id="ent">86,2</div></div>
      <div class="mini"><div class="label">PAN</div><div class="value" id="pan">11,7</div></div>
    </div>

    <div class="subline" id="mapMsg">Status: preparando render…</div>
  </div>

  <div class="glass center">
    <div class="mapWrap">
      <div class="mapStage">
        <div class="map3d" id="map3d">
          <canvas id="mapCanvas"></canvas>

          <div id="alertsLayer"></div>

          <div class="hudOverlay">
            <div class="borderGlow"></div>
            <div class="scanlines"></div>
            <div class="vignette"></div>

            <div class="legend">
              <div class="tag"><span class="dot" style="background:#3aa0ff"></span>Água</div>
              <div class="tag"><span class="dot" style="background:#00ff9a"></span>Vegetação</div>
              <div class="tag"><span class="dot" style="background:#ffd35a"></span>Transição</div>
              <div class="tag"><span class="dot" style="background:#ff3b3b"></span>Desmatamento</div>
            </div>

            <div class="toast" id="toast"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="glass right">
    <div class="buyBox">
      <h2>COMPRAR CNT</h2>
      <p>Abre o token no Pump.fun. (sem inventar moda: botão direto)</p>
      <div class="row">
        <input class="input" id="contrib" type="text" value="0,10" />
        <button class="btn" id="btnBuy">Comprar no Pump</button>
      </div>
      <p style="margin-top:10px;">
        Estimativa: <b id="estim">14.744.913</b> CNT<br>
        <span style="opacity:.8">Estimativa demo (não é cotação real).</span>
      </p>
    </div>

    <div class="chartBox">
      <div class="panelTitle">TELEMETRIA — Série 10 anos</div>
      <canvas class="spark" id="spark"></canvas>
      <div class="subline">Histórico: 10 • Último (RAW): <b id="raw2">18,11</b></div>
    </div>

    <div class="chartBox">
      <div class="panelTitle">Alertas ativos</div>
      <div class="subline" id="alertsSummary">Carregando…</div>
      <div class="subline" style="opacity:.85">
        Fonte: <code style="color:var(--muted)">./dados/alerts.json</code> (se existir)
      </div>
    </div>
  </div>

</div>

<script>
/* =============================
   CONFIG (mude só isso se quiser)
============================= */
const PUMP_URL = "https://pump.fun/coin/GCVyjNaCbXkwGUuktyNxSXad4ozmTp2fzQr2jieSpump";

// Seus arquivos (GitHub Pages OK: sempre relativo)
const ASSET_BASE_MAP = "./assets/mapa_base.png";
const ASSET_HOLO_MAP = "./assets/mapa_holo.png";

// Alertas "reais" (opcional)
const ALERTS_URL = "./dados/alerts.json";

/* =============================
   UTIL
============================= */
const $ = (id) => document.getElementById(id);

function setStatus(msg){
  $("statusChip").textContent = msg;
  $("mapMsg").textContent = msg;
}

function clamp(v,min,max){ return Math.max(min, Math.min(max, v)); }
function lerp(a,b,t){ return a + (b-a)*t; }

// Fetch com fallback sem quebrar
async function tryFetchJSON(url){
  try{
    const r = await fetch(url, { cache:"no-store" });
    if(!r.ok) return null;
    return await r.json();
  }catch(_){ return null; }
}

function toast(title, text){
  const box = $("toast");
  const div = document.createElement("div");
  div.className = "toastItem";
  div.innerHTML = `<b>${title}</b><span>${text}</span>`;
  box.appendChild(div);
  setTimeout(()=>{ div.style.opacity="0"; div.style.transition="opacity .4s ease"; }, 4200);
  setTimeout(()=>{ div.remove(); }, 4800);
}

/* =============================
   MAPA HOLOGRÁFICO 3D (CANVAS)
   - Base map + overlay holo
   - alinhados 1:1 (mesmo canvas)
   - tilt/parallax suave + brilho pulsante
============================= */
const canvas = $("mapCanvas");
const ctx = canvas.getContext("2d", { alpha:true });

let baseImg = new Image();
let holoImg = new Image();
baseImg.crossOrigin = "anonymous";
holoImg.crossOrigin = "anonymous";

let readyBase = false;
let readyHolo = false;

let t0 = performance.now();
let mouse = { x:0, y:0, nx:0, ny:0 };
let tilt = { rx:0, ry:0 };

function resizeCanvasToCSS(){
  const rect = canvas.getBoundingClientRect();
  const dpr = Math.max(1, Math.min(2, window.devicePixelRatio || 1));
  const w = Math.max(2, Math.floor(rect.width * dpr));
  const h = Math.max(2, Math.floor(rect.height * dpr));
  if(canvas.width !== w || canvas.height !== h){
    canvas.width = w;
    canvas.height = h;
  }
  ctx.setTransform(1,0,0,1,0,0);
}

function drawFallbackMap(){
  // fallback procedural (não quebra, caso seus assets não carreguem)
  const w = canvas.width, h = canvas.height;
  ctx.clearRect(0,0,w,h);

  // fundo
  const g = ctx.createRadialGradient(w*0.5,h*0.45, 10, w*0.5,h*0.45, Math.max(w,h)*0.7);
  g.addColorStop(0, "rgba(10,35,45,.35)");
  g.addColorStop(1, "rgba(0,0,0,.15)");
  ctx.fillStyle = g;
  ctx.fillRect(0,0,w,h);

  // “silhueta” genérica do mapa (placeholder)
  ctx.save();
  ctx.translate(w*0.5, h*0.52);
  ctx.scale(w/980, h/640);
  ctx.beginPath();
  ctx.moveTo(-220,-120);
  ctx.bezierCurveTo(-360,-40,-300,120,-120,160);
  ctx.bezierCurveTo(-10,220,180,170,240,60);
  ctx.bezierCurveTo(310,-40,250,-180,70,-190);
  ctx.bezierCurveTo(-80,-200,-140,-170,-220,-120);
  ctx.closePath();
  ctx.fillStyle = "rgba(20,80,70,.35)";
  ctx.fill();

  // borda “holo”
  ctx.strokeStyle = "rgba(110,210,255,.55)";
  ctx.lineWidth = 3;
  ctx.shadowColor = "rgba(110,210,255,.35)";
  ctx.shadowBlur = 16;
  ctx.stroke();
  ctx.restore();
}

function drawMapFrame(time){
  resizeCanvasToCSS();
  const w = canvas.width, h = canvas.height;
  const dt = (time - t0) * 0.001;

  ctx.clearRect(0,0,w,h);

  const hasAny = readyBase || readyHolo;

  if(!hasAny){
    drawFallbackMap();
  }else{
    // Render base (se existir) e holo (se existir) perfeitamente alinhados no mesmo canvas
    // Mantém aspect ratio do mapa dentro do canvas (cover)
    const img = readyBase ? baseImg : holoImg;
    const iw = img.naturalWidth || 980;
    const ih = img.naturalHeight || 640;

    const scale = Math.max(w/iw, h/ih);
    const dw = iw * scale;
    const dh = ih * scale;
    const dx = (w - dw)/2;
    const dy = (h - dh)/2;

    // base
    if(readyBase){
      ctx.globalCompositeOperation = "source-over";
      ctx.globalAlpha = 1.0;
      ctx.imageSmoothingEnabled = true;
      ctx.drawImage(baseImg, dx, dy, dw, dh);
    }

    // efeito holográfico: brilho pulsante + “bloom” leve
    const pulse = 0.55 + 0.25*Math.sin(dt*2.2);
    const shimmer = 0.35 + 0.25*Math.sin(dt*3.4 + 1.1);

    // Holo overlay
    if(readyHolo){
      ctx.globalCompositeOperation = "screen";
      ctx.globalAlpha = 0.85 + 0.10*pulse;
      ctx.drawImage(holoImg, dx, dy, dw, dh);
    }

    // Shimmer grid (leve)
    ctx.globalCompositeOperation = "screen";
    ctx.globalAlpha = 0.08 + 0.07*shimmer;
    ctx.save();
    ctx.translate(w*0.5, h*0.5);
    ctx.rotate(0.22);
    ctx.translate(-w*0.5, -h*0.5);
    ctx.fillStyle = "rgba(110,210,255,1)";
    for(let y=0; y<h; y+=18){
      ctx.fillRect(0, y, w, 1);
    }
    for(let x=0; x<w; x+=18){
      ctx.fillRect(x, 0, 1, h);
    }
    ctx.restore();

    // vignette interna (extra, não mexe no overlay HUD do CSS)
    ctx.globalCompositeOperation = "multiply";
    ctx.globalAlpha = 0.35;
    const vg = ctx.createRadialGradient(w*0.5,h*0.5, 20, w*0.5,h*0.5, Math.max(w,h)*0.65);
    vg.addColorStop(0, "rgba(255,255,255,1)");
    vg.addColorStop(1, "rgba(0,0,0,1)");
    ctx.fillStyle = vg;
    ctx.fillRect(0,0,w,h);

    ctx.globalCompositeOperation = "source-over";
    ctx.globalAlpha = 1;
  }

  requestAnimationFrame(drawMapFrame);
}

function setupTilt(){
  const box = $("map3d");
  const target = $("map3d");
  const wrap = target;

  const onMove = (ev) => {
    const r = wrap.getBoundingClientRect();
    const x = (ev.clientX - r.left) / r.width;
    const y = (ev.clientY - r.top) / r.height;
    mouse.x = x; mouse.y = y;
    mouse.nx = (x - 0.5) * 2;
    mouse.ny = (y - 0.5) * 2;
  };

  window.addEventListener("mousemove", onMove, { passive:true });

  // anima tilt suave
  function tick(){
    tilt.ry = lerp(tilt.ry, clamp(mouse.nx * 7, -7, 7), 0.08);
    tilt.rx = lerp(tilt.rx, clamp(-mouse.ny * 5, -5, 5), 0.08);

    const z = 22;
    box.style.transform = `rotateX(${tilt.rx}deg) rotateY(${tilt.ry}deg) translateZ(${z}px)`;
    requestAnimationFrame(tick);
  }
  tick();
}

async function loadImages(){
  readyBase = false;
  readyHolo = false;

  setStatus("Carregando assets do mapa…");

  const pBase = new Promise((resolve)=>{
    baseImg.onload = ()=>{ readyBase = true; resolve(true); };
    baseImg.onerror = ()=> resolve(false);
    baseImg.src = ASSET_BASE_MAP + "?v=" + Date.now();
  });

  const pHolo = new Promise((resolve)=>{
    holoImg.onload = ()=>{ readyHolo = true; resolve(true); };
    holoImg.onerror = ()=> resolve(false);
    holoImg.src = ASSET_HOLO_MAP + "?v=" + Date.now();
  });

  const [okBase, okHolo] = await Promise.all([pBase, pHolo]);

  if(okBase || okHolo){
    setStatus(`Mapa OK • base:${okBase ? "sim" : "não"} • holo:${okHolo ? "sim" : "não"}`);
  }else{
    setStatus("Assets não encontrados • usando fallback (verifique ./assets/)");
  }
}

/* =============================
   ALERTAS (reais via JSON)
   Formato esperado (exemplo):
   {
     "updated_at":"2026-02-17T09:40:00-03:00",
     "items":[
       {"id":"a1","title":"Foco de desmatamento","detail":"Detectado por satélite","x":0.62,"y":0.41,"severity":"high"},
       {"id":"a2","title":"Queimada","detail":"Risco moderado","x":0.48,"y":0.58,"severity":"medium"}
     ]
   }
   x,y são coordenadas normalizadas no mapa (0..1) dentro do canvas.
============================= */
let alertsData = null;
let alertsTimer = null;

function clearAlerts(){
  $("alertsLayer").innerHTML = "";
  $("toast").innerHTML = "";
}

function renderAlerts(items){
  const layer = $("alertsLayer");
  layer.innerHTML = "";

  const count = items.length;
  $("alertsSummary").textContent = count
    ? `${count} alerta(s) ativo(s) no mapa`
    : `Nenhum alerta ativo`;

  // cria pins
  const rect = canvas.getBoundingClientRect();
  items.forEach((a)=>{
    const pin = document.createElement("div");
    const ring = document.createElement("div");

    pin.className = "alertPin";
    ring.className = "alertRing";

    const color = (a.severity === "high") ? "rgba(255,60,60,1)"
                : (a.severity === "medium") ? "rgba(255,200,60,1)"
                : "rgba(110,210,255,1)";

    pin.style.background = color;
    pin.style.boxShadow = `0 0 16px ${color.replace("1)",".35)")}`;

    ring.style.borderColor = color.replace("1)",".35)");
    ring.style.boxShadow = `0 0 24px ${color.replace("1)",".18)")}`;

    // posicionamento responsivo por % dentro do canvas (normalizado)
    const leftPct = clamp(a.x, 0, 1) * 100;
    const topPct  = clamp(a.y, 0, 1) * 100;

    pin.style.left = leftPct + "%";
    pin.style.top  = topPct + "%";
    ring.style.left = leftPct + "%";
    ring.style.top  = topPct + "%";

    layer.appendChild(ring);
    layer.appendChild(pin);
  });
}

function demoAlerts(){
  // demo sem quebrar caso ./dados/alerts.json não exista
  return {
    updated_at: new Date().toISOString(),
    items: [
      { id:"d1", title:"Desmatamento", detail:"Sinal detectado (demo)", x:0.68, y:0.36, severity:"high" },
      { id:"d2", title:"Queimada", detail:"Risco moderado (demo)", x:0.46, y:0.58, severity:"medium" }
    ]
  };
}

async function loadAlertsOnce(){
  const data = await tryFetchJSON(ALERTS_URL);
  alertsData = data || demoAlerts();

  clearAlerts();
  renderAlerts(alertsData.items || []);
  setStatus(`Mapa OK • alertas: ${(alertsData.items||[]).length}`);

  // dispara toast só quando tem alerta high
  (alertsData.items||[]).slice(0,3).forEach((a)=>{
    if(a.severity === "high"){
      toast("ALERTA CRÍTICO", `${a.title} — ${a.detail}`);
    }
  });
}

function startAlertsPolling(){
  if(alertsTimer) clearInterval(alertsTimer);
  loadAlertsOnce();
  alertsTimer = setInterval(loadAlertsOnce, 15000); // 15s
}

/* =============================
   SPARKLINE (telemetria)
============================= */
function drawSpark(){
  const c = $("spark");
  const g = c.getContext("2d");

  const dpr = Math.max(1, Math.min(2, window.devicePixelRatio || 1));
  const r = c.getBoundingClientRect();
  c.width = Math.max(2, Math.floor(r.width*dpr));
  c.height = Math.max(2, Math.floor(r.height*dpr));

  const w = c.width, h = c.height;
  g.clearRect(0,0,w,h);

  // baseline
  g.globalAlpha = .7;
  g.strokeStyle = "rgba(110,210,255,.25)";
  g.lineWidth = 1;
  g.beginPath();
  g.moveTo(0, h-1);
  g.lineTo(w, h-1);
  g.stroke();

  // linha (demo)
  const pts = [64,58,60,57,62,66,63,61,49,57,58,56];
  const max = Math.max(...pts), min = Math.min(...pts);
  const pad = 10*dpr;

  g.globalAlpha = 1;
  g.strokeStyle = "rgba(110,210,255,.85)";
  g.lineWidth = 2*dpr;
  g.beginPath();
  pts.forEach((v,i)=>{
    const x = pad + (w-2*pad) * (i/(pts.length-1));
    const y = pad + (h-2*pad) * (1 - ((v-min)/(max-min || 1)));
    if(i===0) g.moveTo(x,y); else g.lineTo(x,y);
  });
  g.stroke();

  // glow leve
  g.globalAlpha = .35;
  g.shadowColor = "rgba(110,210,255,.35)";
  g.shadowBlur = 16*dpr;
  g.stroke();
  g.shadowBlur = 0;
}
window.addEventListener("resize", ()=>{ drawSpark(); });

/* =============================
   BOOT
============================= */
function computeFakeEstimate(valStr){
  const v = Number(String(valStr).replace(".","").replace(",","."));
  if(!isFinite(v) || v<=0) return 0;
  // demo: 0,10 -> ~14.7M
  const base = 14744913;
  return Math.round(base * (v / 0.10));
}

function updateEstimate(){
  const e = computeFakeEstimate($("contrib").value);
  $("estim").textContent = (e||0).toLocaleString("pt-BR");
}

function bindUI(){
  $("btnPump").addEventListener("click", ()=> window.open(PUMP_URL, "_blank", "noopener,noreferrer"));
  $("btnBuy").addEventListener("click", ()=> window.open(PUMP_URL, "_blank", "noopener,noreferrer"));
  $("contrib").addEventListener("input", updateEstimate);

  $("btnReload").addEventListener("click", async ()=>{
    await loadImages();
    await loadAlertsOnce();
  });

  $("btnFull").addEventListener("click", ()=>{
    toast("FULL (manual)", "Se você tiver datasets maiores, plugue aqui sem quebrar o mapa.");
  });
}

window.addEventListener("DOMContentLoaded", async ()=>{
  bindUI();
  drawSpark();
  setupTilt();

  // Garante tamanho OK mesmo no primeiro frame
  setStatus("Iniciando render…");
  await loadImages();

  // start render
  requestAnimationFrame(drawMapFrame);

  // alertas
  startAlertsPolling();

  updateEstimate();
});
</script>
</body>
</html>
