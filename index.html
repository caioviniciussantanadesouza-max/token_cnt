<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
  <base href="./">
  <title>CNT — Centro Natural TEC Amazônia</title>

  <style>
    :root{
      --bg0:#000;
      --bg1:#050b10;
      --glass: rgba(2,12,24,.52);
      --stroke: rgba(110,210,255,.22);
      --hud: rgba(110,210,255,.95);
      --hud2: rgba(110,210,255,.55);
      --text:#c8f3ff;
      --muted:#86dcff;
      --shadow: 0 0 18px rgba(110,210,255,.18), 0 0 70px rgba(0,200,255,.08);
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; margin:0; background: radial-gradient(1200px 700px at 50% -10%, #0b2a33 0%, #000 55%, #000 100%); color:var(--text); font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }

    .wrap{ max-width: 1300px; margin: 0 auto; padding: 16px; }

    .card{
      background: linear-gradient(180deg, rgba(2,12,24,.62), rgba(2,12,24,.38));
      border: 1px solid var(--stroke);
      border-radius: 22px;
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }

    header.card{ padding: 18px 18px 14px; }
    h1{ margin: 0; font-weight: 800; letter-spacing: .4px; text-align:center; font-size: 40px; }
    .sub{ text-align:center; color: var(--muted); margin-top: 8px; font-size: 15px; line-height: 1.35; }
    .chips{ display:flex; gap:10px; justify-content:center; flex-wrap:wrap; margin-top: 12px; }
    .chip{
      padding: 9px 12px;
      border-radius: 999px;
      border: 1px solid var(--stroke);
      background: rgba(0,0,0,.18);
      color: var(--text);
      font-size: 13px;
      box-shadow: 0 0 12px rgba(110,210,255,.08);
      user-select:none;
    }
    .chip strong{ color:#e9fbff; font-weight:700; }
    .chip button, .chip a{
      all: unset;
      cursor: pointer;
      color: var(--text);
    }
    .chip:hover{ border-color: rgba(110,210,255,.38); }

    .grid{
      margin-top: 14px;
      display:grid;
      grid-template-columns: 320px 1fr 320px;
      gap: 14px;
      align-items: start;
    }

    .panel{ padding: 14px; }
    .panel h2{
      margin: 0 0 10px;
      font-size: 14px;
      color: var(--muted);
      font-weight: 700;
      letter-spacing: .4px;
      text-transform: none;
    }

    .big{
      font-size: 64px;
      line-height: 1;
      margin: 10px 0 8px;
      letter-spacing: .5px;
    }
    .big small{ font-size: 16px; color: var(--muted); }
    .row{
      display:flex; justify-content:space-between; align-items:center;
      padding: 12px 14px;
      border: 1px solid rgba(110,210,255,.18);
      border-radius: 14px;
      background: rgba(0,0,0,.18);
      margin-top: 10px;
    }
    .row b{ font-size: 14px; }
    .row span{ color:#eaffff; font-weight:700; }

    .subgrid{
      margin-top: 12px;
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
    .pill{
      padding: 12px 12px;
      border-radius: 16px;
      border: 1px solid rgba(110,210,255,.18);
      background: rgba(0,0,0,.18);
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      min-height: 46px;
    }
    .pill .k{ color: var(--muted); font-weight: 700; }
    .pill .v{ color:#eaffff; font-weight: 800; }

    .mapCard{ padding: 12px; }
    .mapHead{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding: 6px 8px 10px;
      color: var(--muted);
      font-weight: 700;
    }
    .mapBox{
      position: relative;
      width: 100%;
      aspect-ratio: 16/10;
      border-radius: 18px;
      overflow: hidden;
      border: 1px solid rgba(110,210,255,.18);
      background: radial-gradient(800px 480px at 50% 40%, rgba(0,200,255,.08), rgba(0,0,0,.35) 55%, rgba(0,0,0,.75));
      box-shadow: inset 0 0 40px rgba(0,200,255,.06);
    }
    canvas#mapCanvas{
      position:absolute; inset:0;
      width:100%; height:100%;
      display:block;
    }
    .mapOverlay{
      position:absolute; inset:0;
      pointer-events:none;
      background:
        radial-gradient(900px 500px at 50% 35%, rgba(110,210,255,.08), transparent 55%),
        linear-gradient(180deg, rgba(0,0,0,.18), rgba(0,0,0,.35));
      mix-blend-mode: screen;
      opacity:.55;
    }

    .buyTitle{
      font-size: 22px;
      font-weight: 900;
      margin: 0 0 4px;
      letter-spacing:.3px;
    }
    .muted{ color: var(--muted); }

    .input{
      margin-top: 10px;
      width:100%;
      padding: 14px 14px;
      border-radius: 18px;
      border: 1px solid rgba(110,210,255,.22);
      background: rgba(0,0,0,.18);
      color: var(--text);
      font-size: 16px;
      outline: none;
    }
    .btn{
      margin-top: 12px;
      width:100%;
      padding: 16px 16px;
      border-radius: 999px;
      border: 1px solid rgba(110,210,255,.28);
      background: rgba(0,0,0,.16);
      color: #eaffff;
      font-weight: 900;
      font-size: 16px;
      cursor:pointer;
      box-shadow: 0 0 18px rgba(110,210,255,.10);
    }
    .btn:hover{ border-color: rgba(110,210,255,.55); box-shadow: 0 0 28px rgba(110,210,255,.16); }

    .teleBox{
      margin-top: 10px;
      border-radius: 16px;
      border: 1px solid rgba(110,210,255,.18);
      background: rgba(0,0,0,.18);
      overflow:hidden;
    }
    canvas#teleCanvas{ width:100%; height:120px; display:block; }

    .status{
      margin-top: 10px;
      font-size: 12px;
      color: rgba(200,243,255,.75);
    }

    .error{
      margin-top: 10px;
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid rgba(255,80,80,.35);
      background: rgba(255,80,80,.08);
      color: rgba(255,220,220,.95);
      font-size: 12px;
      display:none;
    }

    /* Mobile */
    @media (max-width: 980px){
      h1{ font-size: 34px; }
      .grid{ grid-template-columns: 1fr; }
      .mapBox{ aspect-ratio: 4/3; }
      header.card{ padding: 16px 14px 12px; }
    }
  </style>
</head>

<body>
  <div class="wrap">

    <header class="card">
      <h1>CNT — Centro Natural TEC Amazônia</h1>
      <div class="sub">Mapa ecológico real • Água (azul) • Vegetação (verde) • Transição (amarelo) • Desmatamento (vermelho)</div>

      <div class="chips">
        <div class="chip">Fonte: <strong>dados públicos governamentais</strong></div>
        <div class="chip">Ano base: <strong id="anoBase">2025</strong></div>

        <div class="chip">
          <button id="togglePts" title="Trocar pontos (sample/full)">
            Pontos: <strong id="ptsMode">carregando…</strong>
          </button>
        </div>

        <div class="chip">
          <a id="pumpLink" target="_blank" rel="noopener">Compra: <strong>Pump.fun</strong></a>
        </div>
      </div>

      <div class="error" id="errBox"></div>
    </header>

    <main class="grid">

      <!-- LEFT: Índices -->
      <section class="card panel" id="panelIndices">
        <h2><strong>CNT</strong> (índice único Brasil)</h2>

        <div class="big">
          <span id="cntScore">--</span><small> /100</small>
        </div>
        <div class="muted">RAW auditável: <strong id="rawVal">--</strong></div>

        <div class="row"><b>A — Estado</b><span id="A">--</span></div>
        <div class="row"><b>B — Tendência</b><span id="B">--</span></div>
        <div class="row"><b>C — Estabilidade</b><span id="C">--</span></div>
        <div class="row"><b>Grau</b><span id="rating">--</span></div>

        <h2 style="margin-top:14px;">Sub-índices</h2>
        <div class="subgrid">
          <div class="pill"><span class="k">IBE</span><span class="v" id="IBE">--</span></div>
          <div class="pill"><span class="k">IAB</span><span class="v" id="IAB">N/D</span></div>
          <div class="pill"><span class="k">IBI</span><span class="v" id="IBI">--</span></div>
          <div class="pill"><span class="k">HID</span><span class="v" id="HID">--</span></div>
          <div class="pill"><span class="k">ENT</span><span class="v" id="ENT">--</span></div>
          <div class="pill"><span class="k">PAN</span><span class="v" id="PAN">--</span></div>
        </div>

        <div class="status" id="statusLeft">Status: iniciando…</div>
      </section>

      <!-- CENTER: Mapa -->
      <section class="card mapCard">
        <div class="mapHead">
          <div><strong>Mapa base + holograma</strong></div>
          <div>Pontos: <span id="ptsCount">0</span></div>
        </div>

        <div class="mapBox" id="mapBox">
          <canvas id="mapCanvas"></canvas>
          <div class="mapOverlay"></div>
        </div>

        <div class="status" id="statusMap">Status: carregando assets…</div>
      </section>

      <!-- RIGHT: Compra + Telemetria -->
      <section class="card panel">
        <div class="buyTitle">COMPRAR CNT</div>
        <div class="muted">Abre o token no Pump.fun.</div>

        <div style="margin-top:10px" class="muted">Contribuição</div>
        <input class="input" id="contrib" type="number" step="0.01" min="0" value="0.10" inputmode="decimal" />

        <button class="btn" id="buyBtn">Comprar no Pump</button>

        <div style="margin-top:12px" class="muted">Estimativa: <strong id="estCnt" style="font-size:28px;color:#eaffff;">--</strong> <span class="muted">CNT</span></div>
        <div class="muted" style="font-size:12px;margin-top:4px;">Estimativa demo (não é cotação real).</div>

        <h2 style="margin-top:14px;">TELEMETRIA — Série 10 anos</h2>
        <div class="teleBox">
          <canvas id="teleCanvas"></canvas>
        </div>
        <div class="status" id="teleInfo">Histórico: -- • Último (RAW): --</div>
      </section>

    </main>

  </div>

<script>
/* ===========================
   CONFIG
=========================== */
const PUMP_URL = "https://pump.fun/coin/GCVyjNaCbXkwGUuktyNxSXad4ozmTp2fzQr2jieSpump";

// Arquivos locais (mesma pasta do index.html)
const FILES = {
  baseImg: "mapa_base.png",
  prodesImg: "prodes_mosaic.png",
  brGeo: "BR_IBGE_simplificado.geojson",
  dados: "dados_cnt.json",
  ptsSample: "vege_pts_sample.geojson",
  ptsFull: "vege_pts.geojson"
};

// Cache local para pontos (acelera no celular)
const CACHE_KEY = "CNT_PTS_CACHE_V1";

/* ===========================
   HELPERS
=========================== */
const $ = (id)=>document.getElementById(id);

function showErr(msg){
  const box = $("errBox");
  box.style.display = "block";
  box.textContent = msg;
}

function fmt(v, d=2){
  if(v === null || v === undefined || Number.isNaN(v)) return "--";
  const n = Number(v);
  return n.toLocaleString("pt-BR", {minimumFractionDigits:d, maximumFractionDigits:d});
}

async function fetchJSON(url){
  const r = await fetch(url, {cache:"no-store"});
  if(!r.ok) throw new Error(`Falha ao carregar ${url} (${r.status})`);
  return r.json();
}

function loadImage(url){
  return new Promise((res, rej)=>{
    const img = new Image();
    img.decoding = "async";
    img.onload = ()=>res(img);
    img.onerror = ()=>rej(new Error("Falha ao carregar imagem: " + url));
    img.src = url;
  });
}

/* ===========================
   CANVAS SIZING (HiDPI)
=========================== */
function resizeCanvasToBox(canvas, box){
  const dpr = Math.min(2, window.devicePixelRatio || 1); // limita pra não travar
  const rect = box.getBoundingClientRect();
  const w = Math.max(320, Math.floor(rect.width));
  const h = Math.max(240, Math.floor(rect.height));
  canvas.width = Math.floor(w * dpr);
  canvas.height = Math.floor(h * dpr);
  canvas.style.width = w + "px";
  canvas.style.height = h + "px";
  const ctx = canvas.getContext("2d", {alpha:true, desynchronized:true});
  ctx.setTransform(dpr,0,0,dpr,0,0); // desenha em CSS pixels
  return {ctx, w, h, dpr};
}

/* ===========================
   GEO / PROJECTION
   - projeta lon/lat -> pixels
   - usa bbox do Brasil
=========================== */
function bboxOfGeoJSON(geo){
  let minX=+Infinity, minY=+Infinity, maxX=-Infinity, maxY=-Infinity;

  function scanCoords(coords){
    if(typeof coords[0] === "number"){
      const x=coords[0], y=coords[1];
      if(x<minX) minX=x; if(x>maxX) maxX=x;
      if(y<minY) minY=y; if(y>maxY) maxY=y;
      return;
    }
    for(const c of coords) scanCoords(c);
  }

  if(geo.type === "FeatureCollection"){
    for(const f of geo.features) scanCoords(f.geometry.coordinates);
  } else if(geo.type === "Feature"){
    scanCoords(geo.geometry.coordinates);
  } else {
    scanCoords(geo.coordinates);
  }
  return {minX, minY, maxX, maxY};
}

function projectFactory(bbox, W, H, pad=0.06){
  const dx = bbox.maxX - bbox.minX;
  const dy = bbox.maxY - bbox.minY;

  // Mantém proporção (contain) -> isso alinha com imagens “mapa do Brasil” quando elas também são contain
  const usableW = W * (1 - pad*2);
  const usableH = H * (1 - pad*2);

  const s = Math.min(usableW/dx, usableH/dy);

  const cx = (bbox.minX + bbox.maxX)/2;
  const cy = (bbox.minY + bbox.maxY)/2;

  const px0 = W/2;
  const py0 = H/2;

  return (lon, lat)=>{
    const x = (lon - cx) * s + px0;
    const y = (-(lat - cy)) * s + py0;
    return [x,y];
  };
}

function pathFromGeo(ctx, geo, proj){
  ctx.beginPath();
  const feats = geo.type === "FeatureCollection" ? geo.features : [geo.type==="Feature"? geo : {geometry:geo}];

  for(const f of feats){
    const g = f.geometry;
    if(!g) continue;

    const drawRing = (ring)=>{
      for(let i=0;i<ring.length;i++){
        const [lon,lat]=ring[i];
        const [x,y]=proj(lon,lat);
        if(i===0) ctx.moveTo(x,y);
        else ctx.lineTo(x,y);
      }
      ctx.closePath();
    };

    if(g.type==="Polygon"){
      for(const ring of g.coordinates) drawRing(ring);
    } else if(g.type==="MultiPolygon"){
      for(const poly of g.coordinates){
        for(const ring of poly) drawRing(ring);
      }
    }
  }
}

/* ===========================
   HOLOGRAM POINTS
   - cores misturadas
   - pulso ligado ao CNT + RAW
=========================== */
function mulberry32(seed){
  let t = seed >>> 0;
  return function(){
    t += 0x6D2B79F5;
    let x = Math.imul(t ^ (t >>> 15), 1 | t);
    x ^= x + Math.imul(x ^ (x >>> 7), 61 | x);
    return ((x ^ (x >>> 14)) >>> 0) / 4294967296;
  };
}

// Distribuição de cores influenciada pelo “estado” (A) e RAW (telemetria)
function colorFromMix(r){
  // r em [0,1]
  if(r < 0.18) return {r:80,  g:170, b:255}; // água (azul)
  if(r < 0.68) return {r: 80, g:255, b:170}; // vegetação (verde)
  if(r < 0.88) return {r:255, g:230, b: 90}; // transição (amarelo)
  return {r:255, g: 90, b: 90};              // desmatamento (vermelho)
}

function drawGlowDot(ctx, x, y, baseR, col, a){
  // núcleo
  ctx.globalAlpha = a;
  ctx.fillStyle = `rgb(${col.r},${col.g},${col.b})`;
  ctx.beginPath();
  ctx.arc(x,y,baseR,0,Math.PI*2);
  ctx.fill();

  // glow
  ctx.globalAlpha = a * 0.55;
  ctx.beginPath();
  ctx.arc(x,y,baseR*2.6,0,Math.PI*2);
  ctx.fill();

  ctx.globalAlpha = a * 0.20;
  ctx.beginPath();
  ctx.arc(x,y,baseR*5.2,0,Math.PI*2);
  ctx.fill();
}

/* ===========================
   TELEMETRIA
=========================== */
function drawTelemetry(canvas, series){
  const ctx = canvas.getContext("2d");
  const box = canvas.getBoundingClientRect();
  const dpr = Math.min(2, window.devicePixelRatio || 1);
  canvas.width = Math.floor(box.width * dpr);
  canvas.height = Math.floor(box.height * dpr);
  ctx.setTransform(dpr,0,0,dpr,0,0);

  const W = box.width, H = box.height;
  ctx.clearRect(0,0,W,H);

  // background
  ctx.globalAlpha = 1;
  ctx.fillStyle = "rgba(0,0,0,.10)";
  ctx.fillRect(0,0,W,H);

  if(!series || series.length<2) return;

  const min = Math.min(...series);
  const max = Math.max(...series);
  const pad = 12;
  const dx = (W - pad*2) / (series.length - 1);

  const yOf = (v)=>{
    const t = (v - min) / (max - min || 1);
    return (H - pad) - t * (H - pad*2);
  };

  // linha
  ctx.lineWidth = 3;
  ctx.strokeStyle = "rgba(140,230,255,.92)";
  ctx.shadowBlur = 18;
  ctx.shadowColor = "rgba(110,210,255,.35)";

  ctx.beginPath();
  for(let i=0;i<series.length;i++){
    const x = pad + i*dx;
    const y = yOf(series[i]);
    if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
  }
  ctx.stroke();

  // pontos
  ctx.shadowBlur = 0;
  ctx.fillStyle = "rgba(200,245,255,.95)";
  for(let i=0;i<series.length;i++){
    const x = pad + i*dx;
    const y = yOf(series[i]);
    ctx.beginPath();
    ctx.arc(x,y,3.2,0,Math.PI*2);
    ctx.fill();
  }
}

/* ===========================
   MAIN
=========================== */
let state = {
  dados: null,
  brGeo: null,
  ptsGeo: null,
  baseImg: null,
  prodesImg: null,
  ptsMode: "sample",
  pts: [],
  proj: null,
  view: null,
  pulseK: 0.6,
  speed: 1.2
};

function updateUI(){
  const d = state.dados;
  if(!d) return;

  $("anoBase").textContent = "2025";

  const A = d.cnt?.A ?? null;
  const B = d.cnt?.B ?? null;
  const C = d.cnt?.C ?? null;

  const score = (A !== null && A !== undefined) ? Number(A) : null;
  $("cntScore").textContent = score !== null ? fmt(score,1) : "--";
  $("rawVal").textContent = d.telemetry_10y?.length ? fmt(d.telemetry_10y[d.telemetry_10y.length-1],2) : "--";

  $("A").textContent = fmt(A,2);
  $("B").textContent = fmt(B,2);
  $("C").textContent = fmt(C,2);
  $("rating").textContent = d.cnt?.rating ?? "--";

  $("IBI").textContent = fmt(d.indices?.IBI,1);
  $("IAB").textContent = (d.indices?.IAB==null) ? "N/D" : fmt(d.indices?.IAB,1);
  $("HID").textContent = fmt(d.indices?.HID,2);
  $("ENT").textContent = fmt(d.indices?.ENT,1);
  $("PAN").textContent = fmt(d.indices?.PAN,1);
  // IBE não existe no JSON atual -> mantém "--" (ou calcula)
  $("IBE").textContent = (d.indices?.IBE==null) ? "--" : fmt(d.indices?.IBE,1);

  // Telemetria
  const serie = d.telemetry_10y || [];
  drawTelemetry($("teleCanvas"), serie);
  const ultimo = serie.length ? serie[serie.length-1] : null;
  $("teleInfo").textContent = `Histórico: ${serie.length || "--"} • Último (RAW): ${ultimo!=null? fmt(ultimo,2): "--"}`;

  // Pulso: ligado a score e RAW
  const raw = (ultimo!=null)? Number(ultimo) : 0;
  state.pulseK = Math.max(0.25, Math.min(1.2, (score||50)/100 + raw/40));
  state.speed = Math.max(0.7, Math.min(2.2, 0.8 + raw/30));
}

function estimateCNT(){
  const v = Number($("contrib").value || 0);
  // Demo: contribuição * fator (ajusta como quiser)
  const factor = 147449130; // pra bater com sua demo anterior ~0.10 -> 14.744.913
  const est = Math.max(0, Math.round(v * factor));
  $("estCnt").textContent = est.toLocaleString("pt-BR");
}

function computePointsArray(geo){
  const feats = geo?.features || [];
  // reduz densidade se vier pesado (mobile)
  const MAX = 25000; // limite seguro p/ celular
  let pts = feats.map(f=>f.geometry?.coordinates).filter(c=>Array.isArray(c) && c.length>=2);
  if(pts.length > MAX){
    const step = Math.ceil(pts.length / MAX);
    pts = pts.filter((_,i)=> i%step===0);
  }
  return pts;
}

function drawFrame(t){
  const canvas = $("mapCanvas");
  const box = $("mapBox");
  const {ctx, w:W, h:H} = state.view;

  ctx.clearRect(0,0,W,H);

  // Fundo leve
  ctx.globalAlpha = 1;
  ctx.fillStyle = "rgba(0,0,0,.16)";
  ctx.fillRect(0,0,W,H);

  // ==== Raster base (contain) ====
  function drawContain(img, alpha=1){
    if(!img) return;
    const iw = img.naturalWidth || img.width;
    const ih = img.naturalHeight || img.height;
    const s = Math.min(W/iw, H/ih);
    const dw = iw*s, dh = ih*s;
    const dx = (W-dw)/2, dy = (H-dh)/2;
    ctx.globalAlpha = alpha;
    ctx.drawImage(img, dx, dy, dw, dh);
    return {dx,dy,dw,dh, s};
  }

  const baseRect = drawContain(state.baseImg, 0.92);

  // prodes overlay (bem sutil)
  drawContain(state.prodesImg, 0.20);

  // ==== Clip Brasil e contorno neon ====
  if(state.brGeo && state.proj){
    ctx.save();
    pathFromGeo(ctx, state.brGeo, state.proj);
    ctx.clip("evenodd");

    // ==== Holograma: pontos ====
    const d = state.dados || {};
    const A = Number(d.cnt?.A ?? 60);
    const ultimo = (d.telemetry_10y && d.telemetry_10y.length) ? Number(d.telemetry_10y[d.telemetry_10y.length-1]) : 10;

    const seed = Math.floor((A*1000) + (ultimo*100));
    const rnd = mulberry32(seed);

    const pulse = (Math.sin(t*0.001*state.speed)+1)/2; // 0..1
    const intensity = 0.35 + pulse * 0.65 * state.pulseK;

    // Ajusta mix de cores: se A cair, aumenta vermelho um pouco
    const redBoost = Math.max(0, Math.min(0.14, (70 - A)/400));

    const pts = state.pts;
    const count = pts.length;
    const step = count > 18000 ? 2 : 1;

    for(let i=0;i<count;i+=step){
      const lon = pts[i][0], lat = pts[i][1];
      const [x,y] = state.proj(lon,lat);

      // jitter mínimo para “vida”
      const j = (rnd()-0.5) * 0.6;
      const k = (rnd()-0.5) * 0.6;

      // distribuição
      let r = rnd();
      r = Math.min(0.999, r + (r>0.88 ? redBoost : 0)); // reforça vermelho só na cauda
      const col = colorFromMix(r);

      const baseR = 0.75 + rnd()*0.9;
      const a = (0.22 + rnd()*0.33) * intensity;

      drawGlowDot(ctx, x+j, y+k, baseR, col, a);
    }

    ctx.restore();

    // contorno neon por cima
    ctx.save();
    ctx.lineWidth = 1.2;
    ctx.strokeStyle = "rgba(110,210,255,.70)";
    ctx.shadowBlur = 18;
    ctx.shadowColor = "rgba(110,210,255,.28)";
    pathFromGeo(ctx, state.brGeo, state.proj);
    ctx.stroke();
    ctx.restore();
  }

  requestAnimationFrame(drawFrame);
}

async function loadPoints(mode){
  $("statusMap").textContent = "Status: carregando pontos…";
  $("ptsMode").textContent = mode === "full" ? "full" : "sample";

  // tenta cache
  try{
    const cached = JSON.parse(localStorage.getItem(CACHE_KEY) || "null");
    if(cached && cached.mode===mode && Array.isArray(cached.pts) && cached.pts.length){
      state.pts = cached.pts;
      $("ptsCount").textContent = state.pts.length.toLocaleString("pt-BR");
      $("statusMap").textContent = "Status: pontos carregados (cache local).";
      return;
    }
  }catch(e){}

  const url = mode==="full" ? FILES.ptsFull : FILES.ptsSample;
  const geo = await fetchJSON(url);
  state.ptsGeo = geo;
  state.pts = computePointsArray(geo);

  $("ptsCount").textContent = state.pts.length.toLocaleString("pt-BR");

  // salva cache
  try{
    localStorage.setItem(CACHE_KEY, JSON.stringify({mode, pts: state.pts}));
  }catch(e){}

  $("statusMap").textContent = "Status: pontos carregados.";
}

async function boot(){
  try{
    $("pumpLink").href = PUMP_URL;

    // UI
    $("buyBtn").addEventListener("click", ()=>{
      window.open(PUMP_URL, "_blank", "noopener");
    });
    $("contrib").addEventListener("input", estimateCNT);
    estimateCNT();

    // Toggle sample/full
    $("togglePts").addEventListener("click", async ()=>{
      state.ptsMode = (state.ptsMode==="sample") ? "full" : "sample";
      await loadPoints(state.ptsMode);
      $("statusLeft").textContent = `Status: OK • Pontos: ${state.pts.length.toLocaleString("pt-BR")} • Base: ${location.pathname}`;
    });

    // Load base data (paralelo)
    $("statusLeft").textContent = "Status: carregando dados…";
    $("statusMap").textContent = "Status: carregando imagens e geo…";

    const [dados, brGeo, baseImg, prodesImg] = await Promise.all([
      fetchJSON(FILES.dados),
      fetchJSON(FILES.brGeo),
      loadImage(FILES.baseImg),
      loadImage(FILES.prodesImg)
    ]);

    state.dados = dados;
    state.brGeo = brGeo;
    state.baseImg = baseImg;
    state.prodesImg = prodesImg;

    updateUI();

    // Canvas sizing + projection
    const canvas = $("mapCanvas");
    const box = $("mapBox");
    state.view = resizeCanvasToBox(canvas, box);

    const bbox = bboxOfGeoJSON(brGeo);
    state.proj = projectFactory(bbox, state.view.w, state.view.h, 0.07);

    window.addEventListener("resize", ()=>{
      state.view = resizeCanvasToBox(canvas, box);
      const bbox2 = bboxOfGeoJSON(state.brGeo);
      state.proj = projectFactory(bbox2, state.view.w, state.view.h, 0.07);
    }, {passive:true});

    // load points (default sample)
    state.ptsMode = "sample";
    await loadPoints("sample");

    $("statusLeft").textContent = `Status: OK • Pontos: ${state.pts.length.toLocaleString("pt-BR")} • Base: ${location.pathname}`;
    $("statusMap").textContent = "Status: renderizando (holograma ativo).";

    // start animation
    requestAnimationFrame(drawFrame);

  }catch(err){
    console.error(err);
    showErr("ERRO: " + (err?.message || String(err)) + " — confira se os arquivos estão na mesma pasta do index.html e se o GitHub Pages está apontando para a pasta certa.");
    $("statusLeft").textContent = "Status: erro.";
    $("statusMap").textContent = "Status: erro.";
  }
}

boot();
</script>
</body>
</html>
