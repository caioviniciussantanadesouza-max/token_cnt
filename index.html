<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>OS.CNT — Observatório CNT Amazônia</title>

  <!-- MapLibre GL (mapa real) -->
  <link rel="stylesheet" href="https://unpkg.com/maplibre-gl@4.7.1/dist/maplibre-gl.css">
  <script src="https://unpkg.com/maplibre-gl@4.7.1/dist/maplibre-gl.js"></script>

  <!-- Solana web3 (para conectar wallets injetadas, ex: Phantom) -->
  <script src="https://unpkg.com/@solana/web3.js@1.95.2/lib/index.iife.min.js"></script>

  <style>
    :root{
      --c: rgba(120,220,255,.92);
      --c2: rgba(120,220,255,.35);
      --glass: rgba(4,18,32,.28);
      --glass2: rgba(4,18,32,.16);
      --stroke: rgba(120,220,255,.22);
      --text: #a7e8ff;
      --text2:#7fd6ff;
      --ok: #6df;
      --warn: #ffd36d;
      --bad: #ff6d6d;
      --shadow: 0 0 18px rgba(120,220,255,.12), 0 0 60px rgba(0,255,255,.05);
      --r: 14px;
    }

    html,body{
      margin:0;
      height:100%;
      background:#01040a;
      color:var(--text);
      font-family:"Segoe UI", Arial, sans-serif;
      overflow:hidden;
    }

    /* ===== STAGE ===== */
    #stage{ position:fixed; inset:0; background:#01040a; }
    #map{
      position:absolute; inset:0;
      background:#01040a;
      filter: saturate(1.05) contrast(1.1);
    }

    /* fallback imagem (se quiser) */
    #bg{
      position:absolute; inset:0;
      width:100%; height:100%;
      object-fit:cover;
      opacity:.22;
      pointer-events:none;
      mix-blend-mode:screen;
      filter: brightness(.9) contrast(1.15) saturate(1.15);
    }

    /* camadas holográficas */
    #fx{
      position:absolute; inset:0;
      pointer-events:none;
      mix-blend-mode:screen;
      opacity:.95;
      filter: drop-shadow(0 0 10px rgba(120,220,255,.25));
    }
    #hudGrid{
      position:absolute; inset:0;
      pointer-events:none;
      background:
        radial-gradient(circle at 40% 50%, rgba(120,220,255,.06), transparent 55%),
        radial-gradient(circle at 70% 40%, rgba(120,220,255,.04), transparent 60%),
        linear-gradient(to bottom, rgba(120,220,255,.05), transparent 25%, transparent 75%, rgba(120,220,255,.04));
      opacity:.55;
      mix-blend-mode:screen;
    }

    /* respiração do bioma (no todo) */
    @keyframes breathe{
      0%   { filter: brightness(.92) contrast(1.12) saturate(1.05); }
      50%  { filter: brightness(1.02) contrast(1.22) saturate(1.2); }
      100% { filter: brightness(.92) contrast(1.12) saturate(1.05); }
    }
    #stage{ animation:breathe 14s ease-in-out infinite; }

    /* ===== PAINÉIS (overlay) ===== */
    .glass{
      position:absolute;
      background: linear-gradient(180deg, var(--glass), var(--glass2));
      border: 1px solid var(--stroke);
      border-radius: var(--r);
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      overflow:hidden;
    }
    .glass:before{
      content:"";
      position:absolute; inset:0;
      background:
        radial-gradient(circle at 20% 10%, rgba(120,220,255,.12), transparent 40%),
        radial-gradient(circle at 90% 30%, rgba(120,220,255,.08), transparent 45%),
        linear-gradient( to right, rgba(120,220,255,.06), transparent 25%, transparent 75%, rgba(120,220,255,.04));
      opacity:.8;
      pointer-events:none;
      mix-blend-mode:screen;
    }

    .panel{
      padding:14px 14px 12px 14px;
      line-height:1.25;
      letter-spacing:.2px;
    }

    .title{
      font-weight:700;
      letter-spacing:1.2px;
      font-size:12px;
      color:var(--text2);
      opacity:.95;
    }
    .sub{
      font-size:11px;
      opacity:.9;
      color:#bfefff;
    }
    .mono{
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
      letter-spacing:.4px;
    }

    /* layout */
    #pLeft{ left:18px; top:18px; width:300px; }
    #pCenter{ left:50%; top:18px; transform:translateX(-50%); width:min(560px, 58vw); height:130px; }
    #pRight{ right:18px; top:18px; width:260px; }
    #pBottom{ left:18px; right:18px; bottom:16px; height:110px; display:flex; gap:14px; padding:14px; }

    /* evita painéis “pesarem” no mapa */
    @media (max-width: 980px){
      #pCenter{ width:52vw; }
      #pLeft{ width:270px; }
      #pRight{ width:240px; }
    }
    @media (max-width: 820px){
      #pCenter{ display:none; }
      #pBottom{ height:128px; }
    }

    /* CNT principal */
    #cntVal{
      font-size:40px;
      font-weight:800;
      margin:6px 0 2px;
      color:#d6fbff;
      text-shadow: 0 0 20px rgba(120,220,255,.25);
    }
    #cntMeta{ font-size:11px; opacity:.92; }
    .pill{
      display:inline-block;
      padding:3px 8px;
      border:1px solid rgba(120,220,255,.22);
      border-radius:999px;
      background:rgba(120,220,255,.06);
      margin-top:8px;
      font-size:11px;
    }

    /* índices */
    .row{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      padding:6px 0;
      border-bottom:1px solid rgba(120,220,255,.12);
    }
    .row:last-child{ border-bottom:none; }
    .k{ font-size:12px; opacity:.95; }
    .v{
      font-size:12px;
      font-weight:700;
      color:#d6fbff;
    }
    .bar{
      height:6px; border-radius:999px;
      background:rgba(120,220,255,.10);
      border:1px solid rgba(120,220,255,.10);
      overflow:hidden;
      margin-top:5px;
    }
    .bar > i{
      display:block;
      height:100%;
      width:50%;
      background:linear-gradient(90deg, rgba(120,220,255,.15), rgba(120,220,255,.65));
      filter: drop-shadow(0 0 8px rgba(120,220,255,.35));
    }

    /* telemetria */
    #teleWrap{
      position:relative;
      height:100%;
    }
    #teleCanvas{
      width:100%; height:100%;
      filter: drop-shadow(0 0 10px rgba(120,220,255,.35));
    }
    #teleLabel{
      position:absolute;
      left:14px; top:10px;
      font-size:11px;
      opacity:.9;
    }

    /* bottom */
    .bCol{
      flex:1;
      min-width:0;
      display:flex;
      flex-direction:column;
      justify-content:space-between;
    }
    .btns{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }
    button{
      cursor:pointer;
      border:1px solid rgba(120,220,255,.22);
      background:rgba(120,220,255,.08);
      color:#d6fbff;
      border-radius:12px;
      padding:10px 12px;
      font-weight:700;
      letter-spacing:.3px;
      box-shadow: 0 0 20px rgba(120,220,255,.08);
    }
    button:hover{ background:rgba(120,220,255,.12); }
    button:active{ transform:translateY(1px); }
    input{
      width:100%;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid rgba(120,220,255,.18);
      background:rgba(1,6,12,.35);
      color:#d6fbff;
      outline:none;
    }
    .small{ font-size:11px; opacity:.88; }
    .muted{ opacity:.8; }
    .ok{ color: var(--ok); }
    .warn{ color: var(--warn); }
    .bad{ color: var(--bad); }

    /* status de wallet */
    #walletLine{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    #walletAddr{
      font-size:11px;
      opacity:.9;
      border:1px solid rgba(120,220,255,.18);
      background:rgba(120,220,255,.06);
      padding:6px 10px;
      border-radius:999px;
      max-width: 320px;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }

    /* tooltip simples */
    .hint{
      display:inline-block;
      padding:3px 8px;
      border:1px solid rgba(120,220,255,.16);
      border-radius:999px;
      background:rgba(120,220,255,.05);
      font-size:11px;
      opacity:.9;
    }
  </style>
</head>

<body>
  <div id="stage">
    <div id="map"></div>

    <!-- fallback visual (coloque imagem_cnt.png na pasta) -->
    <img id="bg" src="imagem_cnt.png" alt="CNT overlay" onerror="this.style.display='none'"/>

    <!-- campo energético (canvas) -->
    <canvas id="fx"></canvas>
    <div id="hudGrid"></div>

    <!-- LEFT: identidade + índice -->
    <div id="pLeft" class="glass">
      <div class="panel">
        <div class="title mono">OS.CNT</div>
        <div class="sub">Earth Environmental Monitoring Infrastructure</div>

        <div id="cntVal" class="mono">72.4</div>
        <div id="cntMeta" class="mono">
          Confiança: <b id="conf">Alta</b><br>
          Estado do sistema: <b id="estado">Regulação estável</b><br>
          Modo operacional: Monitoramento ativo<br>
          Status: Operacional
        </div>

        <div class="pill mono" id="meaningPill">PULSO • FLUXO • RESPIRAÇÃO ECOLÓGICA</div>
      </div>
    </div>

    <!-- CENTER: telemetria -->
    <div id="pCenter" class="glass">
      <div id="teleWrap">
        <div id="teleLabel" class="mono">Telemetria ecológica — 30 dias (metabolismo)</div>
        <canvas id="teleCanvas"></canvas>
      </div>
    </div>

    <!-- RIGHT: sub-índices -->
    <div id="pRight" class="glass">
      <div class="panel">
        <div class="title mono">SUB-ÍNDICES</div>
        <div class="small muted">Alimentam matematicamente o CNT</div>

        <div id="idx"></div>
      </div>
    </div>

    <!-- BOTTOM: token / compra / PSA -->
    <div id="pBottom" class="glass">
      <div class="bCol">
        <div class="title mono">TOKEN CNT — MERCADO (SOLANA)</div>
        <div class="small">
          Mint: <span class="mono">GCVy…Spump</span> • Fonte: DexScreener
        </div>
        <div class="small">
          Cotação: <b class="mono" id="cntQuote">carregando…</b> &nbsp;|&nbsp;
          Preço (USD): <b class="mono" id="cntUsd">—</b>
        </div>
        <div class="small muted">
          *Não custodiamos fundos. Compra ocorre via Pump.fun.
        </div>
      </div>

      <div class="bCol">
        <div class="title mono">SIMULAÇÃO — TROCA SOL → CNT</div>
        <div class="small muted">Digite SOL para estimar CNT (com preço real quando disponível)</div>
        <input id="solIn" type="number" step="0.01" value="0.10" placeholder="0.10">
        <div class="small">
          Você recebe aprox.: <b class="mono" id="cntOut">—</b>
        </div>
      </div>

      <div class="bCol">
        <div class="title mono">CARTEIRA & COMPRA</div>
        <div id="walletLine">
          <button id="btnConnect">Conectar Wallet</button>
          <button id="btnDisconnect" style="display:none">Desconectar</button>
          <span id="walletAddr" class="mono" style="display:none"></span>
        </div>
        <div class="btns">
          <button id="btnBuy">Comprar no Pump.fun</button>
          <span class="hint mono" id="netHint">Rede: Solana</span>
        </div>
        <div class="small muted">
          Link token: <span class="mono">pump.fun/coin/GCVy…Spump</span>
        </div>
      </div>
    </div>
  </div>

  <script>
    /***********************
     * CONFIG
     ***********************/
    const MINT = "GCVyjNaCbXkwGUuktyNxSXad4ozmTp2fzQr2jieSpump";
    const PUMP_URL = "https://pump.fun/coin/GCVyjNaCbXkwGUuktyNxSXad4ozmTp2fzQr2jieSpump";

    /***********************
     * MAPA REAL (MapLibre)
     ***********************/
    let map;
    function initMap(){
      try{
        map = new maplibregl.Map({
          container: "map",
          style: "https://basemaps.cartocdn.com/gl/dark-matter-gl-style/style.json",
          center: [-60.0, -4.5],  // Amazônia
          zoom: 4.1,
          pitch: 45,
          bearing: -12,
          antialias: true
        });

        map.addControl(new maplibregl.NavigationControl({ visualizePitch:true }), "top-left");

        map.on("load", () => {
          // glow sutil
          const layers = map.getStyle().layers || [];
          // tenta deixar labels mais "científicos"
          layers.forEach(l=>{
            if(l.type === "symbol"){
              map.setLayoutProperty(l.id, "text-field", ["get","name"]);
              map.setPaintProperty(l.id, "text-color", "rgba(160,240,255,0.65)");
              map.setPaintProperty(l.id, "text-halo-color", "rgba(0,0,0,0.8)");
              map.setPaintProperty(l.id, "text-halo-width", 1.2);
            }
          });
        });

      }catch(e){
        console.log("Falha MapLibre:", e);
        // se falhar, fica só com imagem_cnt.png
      }
    }
    initMap();

    /***********************
     * CAMPO ENERGÉTICO (canvas)
     ***********************/
    const fx = document.getElementById("fx");
    const fctx = fx.getContext("2d");
    function resizeFx(){
      fx.width = innerWidth * devicePixelRatio;
      fx.height = innerHeight * devicePixelRatio;
      fx.style.width = innerWidth + "px";
      fx.style.height = innerHeight + "px";
      fctx.setTransform(devicePixelRatio,0,0,devicePixelRatio,0,0);
    }
    addEventListener("resize", resizeFx);
    resizeFx();

    // pontos (torres) - aproximado dentro da Amazônia
    const towers = Array.from({length: 26}, () => ({
      x: Math.random(),
      y: Math.random(),
      h: 0.35 + Math.random()*0.9,
      p: Math.random()*Math.PI*2,
      s: 0.6 + Math.random()*1.2
    }));

    // partículas
    const particles = Array.from({length: 140}, ()=>({
      x: Math.random(),
      y: Math.random(),
      r: 0.6 + Math.random()*1.8,
      v: 0.15 + Math.random()*0.65,
      p: Math.random()*Math.PI*2
    }));

    let T = 0;
    function drawFx(){
      const w = innerWidth, h = innerHeight;
      fctx.clearRect(0,0,w,h);

      // pulso geral
      const pulse = 0.55 + Math.sin(T*0.6)*0.12;

      // brilho difuso central
      const gx = w*0.52, gy = h*0.52;
      const rg = Math.min(w,h)*0.62;
      const grad = fctx.createRadialGradient(gx,gy,rg*0.05,gx,gy,rg);
      grad.addColorStop(0, `rgba(120,220,255,${0.10*pulse})`);
      grad.addColorStop(0.5, `rgba(120,220,255,${0.05*pulse})`);
      grad.addColorStop(1, "rgba(120,220,255,0)");
      fctx.fillStyle = grad;
      fctx.fillRect(0,0,w,h);

      // partículas
      fctx.globalCompositeOperation = "screen";
      for(const p of particles){
        p.p += 0.008*p.v;
        p.x += Math.cos(p.p)*0.00035*p.v;
        p.y += Math.sin(p.p)*0.00025*p.v;

        if(p.x<0) p.x=1; if(p.x>1) p.x=0;
        if(p.y<0) p.y=1; if(p.y>1) p.y=0;

        const px = p.x*w, py = p.y*h;
        fctx.beginPath();
        fctx.fillStyle = `rgba(120,220,255,${0.07*pulse})`;
        fctx.arc(px,py,p.r,0,Math.PI*2);
        fctx.fill();
      }

      // torres (polos de atividade)
      for(const t of towers){
        const x = (0.18 + t.x*0.64)*w;
        const y = (0.18 + t.y*0.64)*h;
        const amp = (0.5 + Math.sin(T*1.2 + t.p)*0.5);
        const height = (18 + t.h*92) * (0.75 + amp*0.7);
        const width = 2.2 + amp*1.8;

        // halo base
        const hg = fctx.createRadialGradient(x,y,1,x,y,34);
        hg.addColorStop(0, `rgba(120,220,255,${0.24*pulse})`);
        hg.addColorStop(1, "rgba(120,220,255,0)");
        fctx.fillStyle = hg;
        fctx.beginPath();
        fctx.arc(x,y,34,0,Math.PI*2);
        fctx.fill();

        // coluna
        const lg = fctx.createLinearGradient(x,y-height,x,y);
        lg.addColorStop(0, `rgba(120,220,255,0)`);
        lg.addColorStop(0.25, `rgba(120,220,255,${0.10*pulse})`);
        lg.addColorStop(0.75, `rgba(120,220,255,${0.22*pulse})`);
        lg.addColorStop(1, `rgba(120,220,255,${0.10*pulse})`);
        fctx.fillStyle = lg;
        fctx.fillRect(x-width/2, y-height, width, height);

        // topo
        fctx.fillStyle = `rgba(180,255,255,${0.18*pulse})`;
        fctx.beginPath();
        fctx.arc(x, y-height, 4 + amp*2, 0, Math.PI*2);
        fctx.fill();
      }

      fctx.globalCompositeOperation = "source-over";

      // vinheta sutil
      const vg = fctx.createRadialGradient(w/2,h/2,Math.min(w,h)*0.35,w/2,h/2,Math.min(w,h)*0.92);
      vg.addColorStop(0,"rgba(0,0,0,0)");
      vg.addColorStop(1,"rgba(0,0,0,0.55)");
      fctx.fillStyle = vg;
      fctx.fillRect(0,0,w,h);

      T += 0.016;
      requestAnimationFrame(drawFx);
    }
    drawFx();

    /***********************
     * TELEMETRIA (canvas)
     ***********************/
    const tele = document.getElementById("teleCanvas");
    const tctx = tele.getContext("2d");
    function resizeTele(){
      const box = tele.getBoundingClientRect();
      tele.width = Math.floor(box.width * devicePixelRatio);
      tele.height = Math.floor(box.height * devicePixelRatio);
      tctx.setTransform(devicePixelRatio,0,0,devicePixelRatio,0,0);
    }
    addEventListener("resize", resizeTele);
    resizeTele();

    let shift = 0;
    function drawTele(){
      const w = tele.getBoundingClientRect().width;
      const h = tele.getBoundingClientRect().height;

      // fundo translúcido
      tctx.clearRect(0,0,w,h);
      tctx.fillStyle = "rgba(0,20,40,.22)";
      tctx.fillRect(0,0,w,h);

      // linha fisiológica
      tctx.lineWidth = 2;
      tctx.strokeStyle = "rgba(120,220,255,.95)";
      tctx.beginPath();
      for(let i=0;i<w;i++){
        const a = (i+shift)/42;
        const b = (i+shift)/13;
        const c = (i+shift)/90;
        const y = h*0.58
          + Math.sin(a)*h*0.10
          + Math.sin(b)*h*0.04
          + Math.sin(c)*h*0.06;
        if(i===0) tctx.moveTo(i,y);
        else tctx.lineTo(i,y);
      }
      tctx.stroke();

      // “batimento” fino
      tctx.strokeStyle = "rgba(120,220,255,.35)";
      tctx.lineWidth = 1;
      tctx.beginPath();
      for(let i=0;i<w;i++){
        const a = (i+shift)/22;
        const y = h*0.62 + Math.sin(a)*h*0.02;
        if(i===0) tctx.moveTo(i,y);
        else tctx.lineTo(i,y);
      }
      tctx.stroke();

      shift += 2;
      requestAnimationFrame(drawTele);
    }
    drawTele();

    /***********************
     * SUB-ÍNDICES (dinâmicos e coerentes)
     ***********************/
    const idxBox = document.getElementById("idx");
    const cntValEl = document.getElementById("cntVal");
    const confEl = document.getElementById("conf");
    const estadoEl = document.getElementById("estado");

    const defs = [
      { key:"IBE", name:"Índice Bioelétrico", v:88 },
      { key:"IAB", name:"Índice Abiótico",    v:88 },
      { key:"IBI", name:"Índice Biótico",     v:11 },
      { key:"HID", name:"Índice Hídrico",     v:83 },
      { key:"ENT", name:"Entropia",           v:88 },
      { key:"PAN", name:"Pressão Antrópica",  v:78 }
    ];

    function clamp(n,a,b){ return Math.max(a, Math.min(b,n)); }

    function renderIndices(){
      idxBox.innerHTML = "";
      defs.forEach(d=>{
        const row = document.createElement("div");
        row.className = "row";
        row.innerHTML = `
          <div style="min-width:0">
            <div class="k mono">${d.key} <span class="muted">— ${d.name}</span></div>
            <div class="bar"><i style="width:${d.v.toFixed(0)}%"></i></div>
          </div>
          <div class="v mono">${d.v.toFixed(0)}</div>
        `;
        idxBox.appendChild(row);
      });
    }

    // Simulação “realista” (não randômico tosco)
    // PAN/ENT penalizam, HID/IBI/IBE/IAB sustentam
    let tSim = 0;
    function tickIndices(){
      tSim += 0.016;

      // ondas lentas: parecem sensores / séries temporais
      const w1 = Math.sin(tSim*0.35);
      const w2 = Math.sin(tSim*0.18 + 1.2);
      const w3 = Math.sin(tSim*0.24 + 2.0);

      // base
      const HID = clamp(80 + w2*8 + w3*4, 0, 100);
      const IBI = clamp(22 + w1*7 + w2*4, 0, 100); // baixo (Amazônia sob pressão)
      const IAB = clamp(86 + w3*6, 0, 100);
      const IBE = clamp(84 + w1*6 + w3*3, 0, 100);

      // penalidades
      const PAN = clamp(72 + (-w2)*7 + (w1)*5, 0, 100);
      const ENT = clamp(78 + (PAN-70)*0.35 + (-IBI)*0.05 + w3*3, 0, 100);

      // aplica
      defs.find(x=>x.key==="HID").v = HID;
      defs.find(x=>x.key==="IBI").v = IBI;
      defs.find(x=>x.key==="IAB").v = IAB;
      defs.find(x=>x.key==="IBE").v = IBE;
      defs.find(x=>x.key==="PAN").v = PAN;
      defs.find(x=>x.key==="ENT").v = ENT;

      // CNT (vitalidade líquida)
      const base = (IBE*0.22 + IAB*0.20 + IBI*0.18 + HID*0.20);
      const pen  = (ENT*0.10 + PAN*0.10);
      const CNT  = clamp(base - (pen-12), 0, 100);

      cntValEl.textContent = CNT.toFixed(1);

      // confiança / estado (simples, institucional)
      let conf = "Alta";
      if(CNT < 55) conf = "Média";
      if(CNT < 40) conf = "Baixa";
      confEl.textContent = conf;

      let estado = "Regulação estável";
      if(CNT < 58) estado = "Transição funcional";
      if(CNT < 42) estado = "Estresse sistêmico";
      estadoEl.textContent = estado;

      // render
      renderIndices();
      requestAnimationFrame(tickIndices);
    }
    renderIndices();
    tickIndices();

    /***********************
     * COTAÇÃO REAL DO TOKEN CNT (DexScreener)
     ***********************/
    const cntQuote = document.getElementById("cntQuote");
    const cntUsd = document.getElementById("cntUsd");
    const solIn = document.getElementById("solIn");
    const cntOut = document.getElementById("cntOut");

    let cntPerSol = 0;   // calculado
    let priceSol = 0;    // 1 CNT em SOL
    let priceUSD = 0;

    function updateQuote(){
      const sol = parseFloat(solIn.value || "0");
      if(!cntPerSol || !isFinite(cntPerSol)){
        cntOut.textContent = "—";
        return;
      }
      const out = sol * cntPerSol;
      cntOut.textContent = out.toLocaleString("pt-BR",{maximumFractionDigits:0}) + " CNT";
    }
    solIn.addEventListener("input", updateQuote);

    async function atualizarPrecoCNT(){
      try{
        const r = await fetch(`https://api.dexscreener.com/latest/dex/tokens/${MINT}`);
        const data = await r.json();

        if(!data.pairs || data.pairs.length === 0){
          cntQuote.textContent = "sem liquidez ainda";
          cntUsd.textContent = "—";
          cntPerSol = 0;
          updateQuote();
          return;
        }

        // pega o primeiro par mais relevante
        const pair = data.pairs[0];

        priceSol = parseFloat(pair.priceNative); // 1 CNT em SOL
        priceUSD = parseFloat(pair.priceUsd || "0");

        if(!priceSol || !isFinite(priceSol)){
          cntQuote.textContent = "indisponível";
          cntUsd.textContent = "—";
          cntPerSol = 0;
          updateQuote();
          return;
        }

        cntPerSol = 1 / priceSol;

        cntQuote.textContent =
          `1 SOL ≈ ${cntPerSol.toLocaleString("pt-BR",{maximumFractionDigits:0})} CNT`;

        cntUsd.textContent =
          (priceUSD && isFinite(priceUSD))
            ? `$ ${priceUSD.toFixed(8)}`
            : "—";

        updateQuote();

      }catch(e){
        console.log("Preço indisponível", e);
        cntQuote.textContent = "carregando…";
        cntUsd.textContent = "—";
      }
    }

    atualizarPrecoCNT();
    setInterval(atualizarPrecoCNT, 20000);

    /***********************
     * SOLANA WALLET (injetadas)
     ***********************/
    const btnConnect = document.getElementById("btnConnect");
    const btnDisconnect = document.getElementById("btnDisconnect");
    const walletAddr = document.getElementById("walletAddr");
    const btnBuy = document.getElementById("btnBuy");

    let provider = null;

    function getProvider(){
      // Phantom / Solflare / Backpack etc (injetadas)
      if(window.solana && window.solana.isPhantom) return window.solana;
      if(window.solflare && window.solflare.isSolflare) return window.solflare;
      // fallback: window.solana mesmo (algumas wallets expõem só solana)
      if(window.solana) return window.solana;
      return null;
    }

    function shortAddr(a){
      return a.slice(0,4) + "…" + a.slice(-4);
    }

    async function connectWallet(){
      provider = getProvider();
      if(!provider){
        alert("Nenhuma wallet Solana detectada. Instale Phantom ou Solflare e recarregue.");
        return;
      }
      try{
        const res = await provider.connect();
        const pubkey = (res && res.publicKey) ? res.publicKey.toString() : (provider.publicKey ? provider.publicKey.toString() : "");
        if(pubkey){
          walletAddr.style.display = "";
          walletAddr.textContent = shortAddr(pubkey);
          btnDisconnect.style.display = "";
        }
      }catch(e){
        console.log("connect cancelado/erro", e);
      }
    }

    async function disconnectWallet(){
      try{
        if(provider && provider.disconnect) await provider.disconnect();
      }catch(e){}
      walletAddr.style.display = "none";
      walletAddr.textContent = "";
      btnDisconnect.style.display = "none";
      provider = null;
    }

    btnConnect.addEventListener("click", connectWallet);
    btnDisconnect.addEventListener("click", disconnectWallet);

    btnBuy.addEventListener("click", ()=>{
      // compra segura: abre Pump.fun (usuário assina na wallet)
      window.open(PUMP_URL, "_blank", "noopener,noreferrer");
    });

  </script>
</body>
</html>
