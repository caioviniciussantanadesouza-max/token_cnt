<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CNT — Centro Natural TEC Amazônia</title>

  <style>
    :root{
      --bg0:#000;
      --bg1:#061219;
      --glass: rgba(2,12,24,.46);
      --stroke: rgba(110,210,255,.18);
      --stroke2: rgba(110,210,255,.28);
      --text:#c8f3ff;
      --muted:#86dcff;
      --hud: rgba(110,210,255,.95);
      --shadow: 0 0 22px rgba(110,210,255,.14), 0 0 70px rgba(0,200,255,.08);
      --r: 22px;
    }

    *{box-sizing:border-box;}
    html,body{height:100%;}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Sans", "Helvetica Neue", sans-serif;
      background:
        radial-gradient(900px 600px at 25% 15%, rgba(0,190,255,.18), transparent 55%),
        radial-gradient(800px 600px at 70% 55%, rgba(0,255,170,.12), transparent 60%),
        radial-gradient(900px 900px at 55% 95%, rgba(120,200,255,.10), transparent 60%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      color:var(--text);
      overflow-x:hidden;
    }

    .wrap{max-width:1200px; margin:18px auto; padding:0 14px 40px;}

    .panel{
      background: linear-gradient(180deg, rgba(0,0,0,.35), rgba(0,0,0,.15));
      border: 1px solid var(--stroke);
      border-radius: var(--r);
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      position:relative;
      overflow:hidden;
    }
    .panel::before{
      content:"";
      position:absolute; inset:-2px;
      background: radial-gradient(700px 280px at 20% 0%, rgba(0,210,255,.18), transparent 60%),
                  radial-gradient(500px 300px at 85% 30%, rgba(0,255,170,.10), transparent 60%);
      opacity:.9;
      pointer-events:none;
    }
    .panel > *{position:relative;}

    header.panel{padding:22px 18px 18px; text-align:center;}
    h1{margin:0; font-weight:800; letter-spacing:.3px; font-size:clamp(26px, 3.2vw, 40px);}
    .subtitle{margin:8px 0 14px; color:var(--muted); line-height:1.35; font-size:14px;}
    .pills{display:flex; gap:10px; justify-content:center; flex-wrap:wrap;}
    .pill{
      border:1px solid var(--stroke);
      padding:8px 12px;
      border-radius:999px;
      font-size:12px;
      color:var(--text);
      background: rgba(0,0,0,.18);
    }

    .grid{
      margin-top:14px;
      display:grid;
      grid-template-columns: 310px 1fr 310px;
      gap:14px;
      align-items:stretch;
    }

    .card-title{font-weight:800; letter-spacing:.3px; margin:0 0 10px; font-size:14px; color:var(--muted);}

    /* Índices */
    .idx{padding:16px;}
    .big{
      font-size:60px;
      line-height:1;
      letter-spacing:-1px;
      margin:6px 0 6px;
    }
    .big small{font-size:18px; opacity:.7; margin-left:6px;}
    .kv{display:flex; justify-content:space-between; gap:10px; padding:10px 12px; border:1px solid var(--stroke); border-radius:999px; margin-top:10px; background: rgba(0,0,0,.16);}
    .kv b{font-weight:800;}
    .subgrid{display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:12px;}
    .mini{padding:10px 12px; border:1px solid var(--stroke); border-radius:14px; background: rgba(0,0,0,.14); display:flex; justify-content:space-between; align-items:center;}
    .mini span{color:var(--muted); font-weight:700; font-size:12px;}
    .mini b{font-size:14px;}
    .status{margin-top:10px; color:rgba(200,243,255,.75); font-size:12px;}

    /* Compra */
    .buy{padding:16px;}
    .buy h2{margin:0 0 8px; font-size:22px; letter-spacing:.3px;}
    .buy p{margin:0 0 14px; color:var(--muted); font-size:13px;}
    .field{display:flex; flex-direction:column; gap:8px;}
    .field label{font-size:12px; color:rgba(200,243,255,.75);}
    .field input{
      height:44px;
      padding:0 14px;
      border-radius:999px;
      background: rgba(0,0,0,.25);
      border:1px solid var(--stroke2);
      color:var(--text);
      outline:none;
      font-size:16px;
    }
    .btn{
      margin-top:12px;
      width:100%;
      height:52px;
      border-radius:999px;
      border:1px solid rgba(110,210,255,.38);
      background: radial-gradient(400px 100px at 50% 0%, rgba(110,210,255,.25), rgba(0,0,0,.15));
      color:var(--text);
      font-weight:900;
      letter-spacing:.2px;
      font-size:16px;
      cursor:pointer;
      box-shadow: 0 0 18px rgba(110,210,255,.18);
    }
    .btn:active{transform: translateY(1px);}
    .est{margin-top:14px; font-size:13px; color:rgba(200,243,255,.75);}
    .est b{font-size:26px; color:var(--text);}

    /* Telemetria */
    .tel{padding:14px 16px 16px; margin-top:14px;}
    .tel .box{height:120px; border:1px solid var(--stroke); border-radius:16px; overflow:hidden; background: rgba(0,0,0,.16);}
    canvas{display:block; width:100%; height:100%;}

    /* Mapa */
    .map{padding:12px; display:flex; flex-direction:column; gap:10px;}
    .mapTop{display:flex; justify-content:space-between; gap:10px; flex-wrap:wrap; align-items:center;}
    .mapTop .hint{color:rgba(200,243,255,.75); font-size:12px;}
    .mapWrap{
      position:relative;
      border:1px solid var(--stroke);
      border-radius: 18px;
      background: rgba(0,0,0,.16);
      overflow:hidden;
      box-shadow: inset 0 0 36px rgba(0,190,255,.10);
      /* aspect-ratio setado via JS conforme a imagem */
    }
    .layer{position:absolute; inset:0;}
    .vignette{
      position:absolute; inset:0;
      background: radial-gradient(600px 420px at 50% 50%, rgba(0,0,0,0), rgba(0,0,0,.45));
      pointer-events:none;
    }
    .scan{
      position:absolute; left:-20%; right:-20%; height:120px;
      background: linear-gradient(180deg, transparent, rgba(110,210,255,.08), transparent);
      mix-blend-mode: screen;
      opacity:.7;
      filter: blur(1px);
      animation: scan 4.2s linear infinite;
      pointer-events:none;
    }
    @keyframes scan{0%{top:-40%;}100%{top:140%;}}

    /* Responsivo: mobile troca a ordem */
    @media (max-width: 980px){
      .grid{grid-template-columns: 1fr;}
      .idx{order:2;}
      .map{order:1;}
      .right{order:3;}
      header.panel{padding:18px 14px 14px;}
    }

    .right{display:flex; flex-direction:column; gap:14px;}
  </style>
</head>
<body>
  <div class="wrap">
    <header class="panel">
      <h1>CNT — Centro Natural TEC Amazônia</h1>
      <div class="subtitle">Mapa ecológico real • Água (azul) • Vegetação (verde) • Transição (amarelo) • Desmatamento (vermelho)</div>
      <div class="pills">
        <div class="pill">Fonte: dados públicos governamentais</div>
        <div class="pill">Ano base: <span id="yearPill">2025</span></div>
        <div class="pill">Holograma: MapBiomas/IBGE (pontos)</div>
        <div class="pill">Compra: Pump.fun</div>
      </div>
    </header>

    <main class="grid">
      <section class="panel idx" id="idxPanel">
        <div class="card-title">CNT (índice único Brasil)</div>
        <div class="big"><span id="cntValue">--</span><small>/100</small></div>
        <div style="color:rgba(200,243,255,.75); font-size:13px;">RAW auditável: <b id="rawValue">--</b></div>

        <div class="kv"><span><b>A</b> — Estado</span><b id="aEstado">--</b></div>
        <div class="kv"><span><b>B</b> — Tendência</span><b id="bTend">--</b></div>
        <div class="kv"><span><b>C</b> — Estabilidade</span><b id="cEstab">--</b></div>
        <div class="kv"><span><b>G</b>rau</span><b id="grau">--</b></div>

        <div class="card-title" style="margin-top:14px;">Sub-índices</div>
        <div class="subgrid">
          <div class="mini"><span>IBE</span><b id="ibe">--</b></div>
          <div class="mini"><span>IAB</span><b id="iab">--</b></div>
          <div class="mini"><span>IBI</span><b id="ibi">--</b></div>
          <div class="mini"><span>HID</span><b id="hid">--</b></div>
          <div class="mini"><span>ENT</span><b id="ent">--</b></div>
          <div class="mini"><span>PAN</span><b id="pan">--</b></div>
        </div>

        <div class="status" id="status">Status: iniciando…</div>
      </section>

      <section class="panel map" id="mapPanel">
        <div class="mapTop">
          <div class="card-title" style="margin:0;">Mapa base + holograma</div>
          <div class="hint" id="ptsHint">Pontos: --</div>
        </div>

        <div class="mapWrap" id="mapWrap" aria-label="Mapa CNT">
          <canvas class="layer" id="baseCanvas"></canvas>
          <canvas class="layer" id="holoCanvas"></canvas>
          <div class="vignette"></div>
          <div class="scan"></div>
        </div>

        <div class="hint" style="margin-top:2px;">Base: <span id="basePath">(auto)</span> • Se não aparecer, verifique se <b>mapa_base.png</b> e <b>prodes_mosaic.png</b> estão na mesma pasta do <b>index.html</b>.</div>
      </section>

      <aside class="right" id="rightCol">
        <section class="panel buy" id="buyPanel">
          <h2>COMPRAR CNT</h2>
          <p>Abre o token no Pump.fun.</p>
          <div class="field">
            <label>Contribuição</label>
            <input id="contrib" inputmode="decimal" value="0,10" />
          </div>
          <button class="btn" id="buyBtn">Comprar no Pump</button>
          <div class="est">Estimativa: <b id="estCnt">--</b> CNT<br><span style="opacity:.8">Estimativa demo (não é cotação real).</span></div>
        </section>

        <section class="panel tel" id="telPanel">
          <div class="card-title">TELEMETRIA — Série 10 anos</div>
          <div class="box"><canvas id="telCanvas"></canvas></div>
          <div class="hint" style="margin-top:8px;">Histórico: <span id="telN">--</span> • Último (RAW): <span id="telLast">--</span></div>
        </section>
      </aside>
    </main>
  </div>

<script>
(() => {
  // ===== Config =====
  const TOKEN_URL = "https://pump.fun/coin/GCVyjNaCbXkwGUuktyNxSXad4ozmTp2fzQr2jieSpump";
  const ASSETS = {
    baseImg: "mapa_base.png",
    mosaicImg: "prodes_mosaic.png",
    dados: "dados_cnt.json",
  };

  // ===== Helpers =====
  const $ = (id) => document.getElementById(id);
  const clamp = (v,min,max)=>Math.max(min,Math.min(max,v));

  function detectBasePath(){
    let p = location.pathname;
    if (p.endsWith("index.html")) p = p.slice(0, -"index.html".length);
    if (!p.endsWith("/")) p += "/";
    return location.origin + p;
  }

  async function fetchJson(url){
    const r = await fetch(url, {cache:"no-store"});
    if (!r.ok) throw new Error(`HTTP ${r.status} em ${url}`);
    return r.json();
  }

  function fmt2(v){
    if (v===null || v===undefined || Number.isNaN(v)) return "--";
    return (Math.round(v*100)/100).toString().replace(".",",");
  }

  // ===== UI =====
  const statusEl = $("status");
  const ptsHint = $("ptsHint");
  const basePathEl = $("basePath");

  $("buyBtn").addEventListener("click", () => {
    window.open(TOKEN_URL, "_blank", "noopener,noreferrer");
  });

  $("contrib").addEventListener("input", () => {
    const val = parseFloat(String($("contrib").value).replace(",","."));
    const est = (!Number.isFinite(val) || val<=0) ? 0 : Math.floor(val * 147449130);
    $("estCnt").textContent = est.toLocaleString("pt-BR");
  });
  $("contrib").dispatchEvent(new Event("input"));

  // ===== Telemetria (canvas) =====
  function drawTelemetry(values){
    const c = $("telCanvas");
    const dpr = Math.max(1, Math.min(2, window.devicePixelRatio || 1));
    const w = c.clientWidth, h = c.clientHeight;
    c.width = Math.floor(w * dpr);
    c.height = Math.floor(h * dpr);
    const ctx = c.getContext("2d");
    ctx.setTransform(dpr,0,0,dpr,0,0);

    ctx.clearRect(0,0,w,h);
    if (!values || !values.length) return;

    const grd = ctx.createLinearGradient(0,0,0,h);
    grd.addColorStop(0, "rgba(0,0,0,.0)");
    grd.addColorStop(1, "rgba(0,0,0,.25)");
    ctx.fillStyle = grd;
    ctx.fillRect(0,0,w,h);

    const minV = Math.min(...values);
    const maxV = Math.max(...values);
    const pad = 14;
    const x0 = pad, y0 = pad;
    const x1 = w-pad, y1 = h-pad;
    const span = Math.max(1e-6, maxV-minV);

    const pts = values.map((v,i)=>{
      const t = values.length===1 ? 0 : i/(values.length-1);
      const x = x0 + t*(x1-x0);
      const y = y1 - ((v-minV)/span)*(y1-y0);
      return [x,y];
    });

    ctx.lineWidth = 2.5;
    ctx.strokeStyle = "rgba(140,220,255,.95)";
    ctx.shadowColor = "rgba(110,210,255,.35)";
    ctx.shadowBlur = 10;
    ctx.beginPath();
    pts.forEach(([x,y],i)=> i?ctx.lineTo(x,y):ctx.moveTo(x,y));
    ctx.stroke();

    ctx.shadowBlur = 0;
    ctx.fillStyle = "rgba(200,243,255,.9)";
    for(const [x,y] of pts){
      ctx.beginPath();
      ctx.arc(x,y,2.2,0,Math.PI*2);
      ctx.fill();
    }
  }

  // ===== Mapa + Holograma =====
  const baseCanvas = $("baseCanvas");
  const holoCanvas = $("holoCanvas");
  const mapWrap = $("mapWrap");

  function setMapAspectFromImage(img){
    const w = img.naturalWidth || 16;
    const h = img.naturalHeight || 9;
    mapWrap.style.aspectRatio = `${w} / ${h}`;
  }

  function resizeCanvasToWrap(c){
    const dpr = Math.max(1, Math.min(2, window.devicePixelRatio || 1));
    const w = mapWrap.clientWidth;
    const h = mapWrap.clientHeight;
    c.width = Math.floor(w * dpr);
    c.height = Math.floor(h * dpr);
    const ctx = c.getContext("2d");
    ctx.setTransform(dpr,0,0,dpr,0,0);
    return {ctx, w, h};
  }

  function rgbToHsl(r,g,b){
    r/=255; g/=255; b/=255;
    const max=Math.max(r,g,b), min=Math.min(r,g,b);
    let h,s,l=(max+min)/2;
    if(max===min){h=s=0;}
    else{
      const d=max-min;
      s=l>0.5? d/(2-max-min) : d/(max+min);
      switch(max){
        case r: h=(g-b)/d + (g<b?6:0); break;
        case g: h=(b-r)/d + 2; break;
        case b: h=(r-g)/d + 4; break;
      }
      h/=6;
    }
    return [h*360, s, l];
  }

  function classifyPixel(r,g,b){
    const [h,s,l] = rgbToHsl(r,g,b);
    if (l < 0.10) return null;
    if (h > 175 && h < 250 && s > 0.25) return "agua";
    if (h > 70 && h <= 170 && s > 0.18) return "veg";
    if (h >= 25 && h <= 70 && s > 0.18) return "trans";
    if ((h < 25 || h > 330) && s > 0.20) return "des";
    return "trans";
  }

  const CLASS_COL = {
    agua: [40, 170, 255],
    veg:  [0, 255, 170],
    trans:[255, 220, 0],
    des:  [255, 80, 80],
  };

  async function loadImage(url){
    return new Promise((resolve,reject)=>{
      const img = new Image();
      img.onload = ()=> resolve(img);
      img.onerror = ()=> reject(new Error("Falha ao carregar imagem: " + url));
      img.src = url;
    });
  }

  function buildPointsFromMosaic(mosaicImg, sampleStep=3, maxPoints=18000){
    const oc = document.createElement("canvas");
    oc.width = mosaicImg.naturalWidth;
    oc.height = mosaicImg.naturalHeight;
    const octx = oc.getContext("2d", {willReadFrequently:true});
    octx.drawImage(mosaicImg, 0,0);
    const imgData = octx.getImageData(0,0,oc.width,oc.height).data;

    const pts = [];
    for (let y=0; y<oc.height; y+=sampleStep){
      for (let x=0; x<oc.width; x+=sampleStep){
        const i = (y*oc.width + x) * 4;
        const r = imgData[i], g = imgData[i+1], b = imgData[i+2], a = imgData[i+3];
        if (a < 40) continue;
        const cls = classifyPixel(r,g,b);
        if (!cls) continue;
        const rx = x + (Math.random() - 0.5) * sampleStep;
        const ry = y + (Math.random() - 0.5) * sampleStep;
        pts.push({x: rx, y: ry, cls, seed: Math.random()});
      }
    }

    if (pts.length > maxPoints){
      const step = Math.ceil(pts.length / maxPoints);
      return pts.filter((_,i)=> i%step===0);
    }
    return pts;
  }

  function drawBase(baseImg){
    const {ctx,w,h} = resizeCanvasToWrap(baseCanvas);
    ctx.clearRect(0,0,w,h);

    ctx.save();
    ctx.globalAlpha = 0.96;
    ctx.drawImage(baseImg, 0,0,w,h);

    ctx.globalCompositeOperation = "screen";
    ctx.globalAlpha = 0.35;
    const g = ctx.createRadialGradient(w*0.5,h*0.45, 10, w*0.5,h*0.45, Math.max(w,h)*0.7);
    g.addColorStop(0, "rgba(0,200,255,.18)");
    g.addColorStop(1, "rgba(0,0,0,0)");
    ctx.fillStyle = g;
    ctx.fillRect(0,0,w,h);
    ctx.restore();
  }

  function startHologram(points, mosaicNatural, state){
    let running = true;

    const groups = {
      agua: points.filter(p=>p.cls==="agua"),
      veg: points.filter(p=>p.cls==="veg"),
      trans: points.filter(p=>p.cls==="trans"),
      des: points.filter(p=>p.cls==="des"),
    };

    function render(t){
      if (!running) return;

      const {ctx,w,h} = resizeCanvasToWrap(holoCanvas);
      ctx.clearRect(0,0,w,h);

      const sx = w / mosaicNatural.w;
      const sy = h / mosaicNatural.h;

      const cnt = state.cntValue ?? 50;
      const speed = 0.55 + (cnt/100)*1.65;
      const glow = 0.25 + (cnt/100)*0.45;
      const pulse = 0.55 + 0.45*Math.sin(t*0.001*speed);

      ctx.globalCompositeOperation = "lighter";

      for (const [cls, arr] of Object.entries(groups)){
        const col = CLASS_COL[cls] || [255,255,255];
        const baseA = cls==="des" ? 0.22 : cls==="agua" ? 0.18 : 0.20;
        const a = baseA + glow * 0.20;

        ctx.fillStyle = `rgba(${col[0]},${col[1]},${col[2]},${a})`;
        ctx.shadowColor = `rgba(${col[0]},${col[1]},${col[2]},${0.35 + glow*0.55})`;
        ctx.shadowBlur = 10 + glow*22;

        for (let i=0; i<arr.length; i++){
          const p = arr[i];
          const local = 0.6 + 0.4*Math.sin((t*0.001*speed) + p.seed*6.283);
          const r = (1.0 + 1.6*pulse*local) * (cls==="des" ? 1.15 : 1.0);

          const x = p.x*sx;
          const y = p.y*sy;
          if (x<0 || y<0 || x>w || y>h) continue;

          ctx.beginPath();
          ctx.arc(x,y,r,0,Math.PI*2);
          ctx.fill();
        }
      }

      ctx.globalCompositeOperation = "screen";
      ctx.shadowBlur = 0;
      const fog = ctx.createRadialGradient(w*0.55,h*0.5, 10, w*0.55,h*0.5, Math.max(w,h)*0.75);
      fog.addColorStop(0, `rgba(0,220,255,${0.07 + glow*0.06})`);
      fog.addColorStop(1, "rgba(0,0,0,0)");
      ctx.fillStyle = fog;
      ctx.fillRect(0,0,w,h);

      requestAnimationFrame(render);
    }

    requestAnimationFrame(render);
    return () => { running = false; };
  }

  // ===== State =====
  const state = { cntValue: null, baseUrl: null };

  async function init(){
    const base = detectBasePath();
    state.baseUrl = base;
    basePathEl.textContent = base;

    statusEl.textContent = "Status: carregando dados…";

    let dados;
    try { dados = await fetchJson(ASSETS.dados); }
    catch (e){ dados = await fetchJson(base + ASSETS.dados); }

    $("yearPill").textContent = dados?.meta?.year ?? "2025";

    state.cntValue = Number(dados?.cnt?.value);
    $("cntValue").textContent = fmt2(state.cntValue);
    $("rawValue").textContent = fmt2(Number(dados?.cnt?.raw));
    $("aEstado").textContent = fmt2(Number(dados?.indices?.A_estado));
    $("bTend").textContent = fmt2(Number(dados?.indices?.B_tendencia));
    $("cEstab").textContent = fmt2(Number(dados?.indices?.C_estabilidade));
    $("grau").textContent = String(dados?.indices?.grau ?? "--");

    $("ibe").textContent = fmt2(Number(dados?.indices?.IBE));
    $("iab").textContent = String(dados?.indices?.IAB ?? "N/D");
    $("ibi").textContent = fmt2(Number(dados?.indices?.IBI));
    $("hid").textContent = fmt2(Number(dados?.indices?.HID));
    $("ent").textContent = fmt2(Number(dados?.indices?.ENT));
    $("pan").textContent = fmt2(Number(dados?.indices?.PAN));

    const serie = dados?.telemetry_10y || [];
    drawTelemetry(serie);
    $("telN").textContent = String(serie.length || 0);
    $("telLast").textContent = fmt2(serie.length ? serie[serie.length-1] : null);

    statusEl.textContent = "Status: carregando mapa…";

    let baseImg, mosaicImg;
    try { baseImg = await loadImage(ASSETS.baseImg); }
    catch(e){ baseImg = await loadImage(base + ASSETS.baseImg); }

    try { mosaicImg = await loadImage(ASSETS.mosaicImg); }
    catch(e){ mosaicImg = await loadImage(base + ASSETS.mosaicImg); }

    setMapAspectFromImage(baseImg);
    drawBase(baseImg);

    const cacheKey = `cnt_pts_v1_${mosaicImg.naturalWidth}x${mosaicImg.naturalHeight}`;
    let points = null;
    try {
      const cached = localStorage.getItem(cacheKey);
      if (cached) points = JSON.parse(cached);
    } catch(_){}

    if (!points){
      statusEl.textContent = "Status: gerando holograma…";
      await new Promise((res)=>{
        const job = () => {
          points = buildPointsFromMosaic(mosaicImg, 3, 18000);
          try { localStorage.setItem(cacheKey, JSON.stringify(points)); } catch(_){}
          res();
        };
        if ("requestIdleCallback" in window) requestIdleCallback(job, {timeout: 1200});
        else setTimeout(job, 10);
      });
    }

    ptsHint.textContent = `Pontos: ${points.length.toLocaleString("pt-BR")}`;
    startHologram(points, {w:mosaicImg.naturalWidth, h:mosaicImg.naturalHeight}, state);

    statusEl.textContent = "Status: OK • Base e holograma alinhados • (cache local ativo)";

    let rto=null;
    window.addEventListener("resize", ()=>{
      clearTimeout(rto);
      rto=setTimeout(()=>{ drawBase(baseImg); }, 120);
    });
  }

  init().catch((err)=>{
    console.error(err);
    statusEl.textContent = "Status: ERRO — " + (err?.message || String(err));
  });
})();
</script>
</body>
</html>
