<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>CNT — Centro Natural TEC Amazônia</title>

  <!-- SheetJS (para fallback Excel) -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js" defer></script>

  <style>
    :root{
      --bg0:#000;
      --bg1:#050b10;
      --hud: rgba(110,210,255,.95);
      --hud2: rgba(110,210,255,.55);
      --stroke: rgba(110,210,255,.18);
      --glass: rgba(2,12,24,.46);
      --glass2: rgba(2,12,24,.28);
      --text:#c8f3ff;
      --muted:#86dcff;
      --shadow: 0 0 22px rgba(110,210,255,.14), 0 0 70px rgba(0,200,255,.08);
    }
    *{ box-sizing:border-box; }
    html,body{ height:100%; margin:0; background: radial-gradient(1200px 700px at 50% -10%, #0b2233 0%, #03070b 40%, #000 90%); color:var(--text); font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial; }
    a{ color:inherit; }

    .wrap{ max-width:1200px; margin:0 auto; padding:18px 14px 24px; }
    .top{
      border:1px solid var(--stroke);
      background: linear-gradient(180deg, rgba(0,0,0,.75), rgba(0,0,0,.35));
      box-shadow: var(--shadow);
      border-radius:22px;
      padding:18px 16px;
    }
    .title{
      text-align:center;
      font-weight:800;
      letter-spacing:.5px;
      font-size: clamp(24px, 3.2vw, 44px);
      margin:2px 0 6px;
      text-shadow: 0 0 18px rgba(120,220,255,.18);
    }
    .subtitle{
      text-align:center;
      color:var(--muted);
      font-size: clamp(12px, 1.4vw, 14px);
      margin:0 0 12px;
      opacity:.95;
    }
    .chips{
      display:flex; gap:10px; justify-content:center; flex-wrap:wrap;
    }
    .chip{
      border:1px solid var(--stroke);
      background: rgba(2,10,18,.45);
      border-radius:999px;
      padding:8px 12px;
      font-size:12px;
      color: rgba(200,243,255,.92);
      box-shadow: 0 0 18px rgba(110,210,255,.08);
    }

    .grid{
      margin-top:14px;
      display:grid;
      grid-template-columns: 320px 1fr 320px;
      gap:14px;
      align-items:stretch;
    }

    .card{
      border:1px solid var(--stroke);
      background: linear-gradient(180deg, rgba(0,0,0,.70), rgba(0,0,0,.35));
      box-shadow: var(--shadow);
      border-radius:22px;
      padding:16px;
      position:relative;
      overflow:hidden;
    }
    .card::before{
      content:"";
      position:absolute; inset:-2px;
      background: radial-gradient(800px 500px at 30% 20%, rgba(110,210,255,.18), transparent 55%);
      pointer-events:none;
      filter: blur(.2px);
    }

    .h{
      font-weight:800;
      margin:0 0 10px;
      letter-spacing:.4px;
      text-transform:uppercase;
      font-size:12px;
      color: rgba(134,220,255,.95);
    }

    /* MAPA */
    .mapWrap{
      padding:0;
      display:flex;
      flex-direction:column;
      min-height:520px;
    }
    .mapStage{
      position:relative;
      flex:1;
      border-radius:22px;
      overflow:hidden;
      background: radial-gradient(900px 500px at 50% 20%, rgba(20,80,110,.28), rgba(0,0,0,.75));
    }
    .mapStage .hint{
      position:absolute; left:14px; top:12px;
      font-size:12px;
      color: rgba(134,220,255,.9);
      z-index:10;
      opacity:.85;
      user-select:none;
    }
    .mapBase{
      position:absolute; inset:0;
      display:flex; align-items:center; justify-content:center;
      z-index:1;
    }
    .mapBase img{
      width:100%;
      height:100%;
      object-fit:contain;
      filter: contrast(1.05) saturate(1.05);
      transform: translateZ(0);
    }

    canvas#hud{
      position:absolute; inset:0;
      z-index:3;
      width:100%; height:100%;
      mix-blend-mode: screen;
      opacity:1;
      transform: translateZ(0);
    }
    canvas#lines{
      position:absolute; inset:0;
      z-index:2;
      width:100%; height:100%;
      mix-blend-mode: screen;
      opacity:.95;
      transform: translateZ(0);
    }

    .loadingBar{
      position:absolute; left:14px; right:14px; bottom:12px;
      z-index:12;
      height:8px;
      border-radius:999px;
      border:1px solid var(--stroke);
      background: rgba(0,0,0,.4);
      overflow:hidden;
    }
    .loadingBar > i{
      display:block; height:100%;
      width:0%;
      background: linear-gradient(90deg, rgba(110,210,255,.25), rgba(110,210,255,.95), rgba(110,210,255,.25));
      box-shadow: 0 0 24px rgba(110,210,255,.25);
      border-radius:999px;
      transition: width .25s ease;
    }

    /* Painel Índice */
    .big{
      font-size:56px;
      font-weight:300;
      margin:6px 0 0;
      letter-spacing:.5px;
      text-shadow: 0 0 26px rgba(110,210,255,.20);
    }
    .muted{ color: rgba(134,220,255,.9); font-size:13px; }
    .row{
      display:flex; align-items:center; justify-content:space-between;
      border:1px solid rgba(110,210,255,.14);
      background: rgba(0,0,0,.32);
      border-radius:14px;
      padding:12px 12px;
      margin-top:10px;
    }
    .row strong{ font-size:13px; letter-spacing:.2px; }
    .row span{ font-variant-numeric: tabular-nums; color: rgba(200,243,255,.95); }

    .subgrid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
      margin-top:10px;
    }
    .pill{
      border:1px solid rgba(110,210,255,.14);
      background: rgba(0,0,0,.32);
      border-radius:14px;
      padding:12px;
      display:flex; align-items:center; justify-content:space-between;
      min-height:44px;
    }
    .pill b{ font-size:13px; }
    .pill i{ font-style:normal; font-variant-numeric: tabular-nums; color: rgba(200,243,255,.95); }

    /* Comprar */
    .buyTitle{
      font-size:20px;
      font-weight:900;
      margin:0 0 6px;
      letter-spacing:.5px;
    }
    .input{
      width:100%;
      border:1px solid rgba(110,210,255,.22);
      background: rgba(0,0,0,.35);
      color:var(--text);
      border-radius:14px;
      padding:12px 12px;
      outline:none;
      font-size:16px;
    }
    .btn{
      width:100%;
      margin-top:10px;
      border:1px solid rgba(110,210,255,.25);
      background: linear-gradient(180deg, rgba(110,210,255,.22), rgba(110,210,255,.08));
      color: rgba(220,252,255,.98);
      border-radius:16px;
      padding:12px 12px;
      font-weight:800;
      letter-spacing:.2px;
      cursor:pointer;
      box-shadow: 0 0 22px rgba(110,210,255,.14);
    }
    .btn:active{ transform: translateY(1px); }

    /* Telemetria */
    .spark{
      height:110px;
      border-radius:16px;
      border:1px solid rgba(110,210,255,.14);
      background: rgba(0,0,0,.30);
      overflow:hidden;
      position:relative;
    }
    .spark svg{ width:100%; height:100%; }
    .foot{
      margin-top:8px;
      color: rgba(134,220,255,.9);
      font-size:12px;
    }

    /* MOBILE: trocar ordem (Comprar acima do mapa / Índice abaixo) */
    @media (max-width: 980px){
      .grid{ grid-template-columns: 1fr; }
      .mapWrap{ min-height:420px; }
      .orderBuy{ order:1; }
      .orderMap{ order:2; }
      .orderIndex{ order:3; }
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="top">
      <div class="title">CNT — Centro Natural TEC Amazônia</div>
      <div class="subtitle">Mapa ecológico real • Água (azul) • Vegetação (verde) • Transição (amarelo) • Desmatamento (vermelho)</div>
      <div class="chips">
        <div class="chip">Fonte: dados públicos governamentais</div>
        <div class="chip">Ano base: 2025</div>
        <div class="chip" id="chipMode">Holograma: MapBiomas/IBGE (pontos)</div>
        <div class="chip">Compra: Pump.fun</div>
      </div>
    </div>

    <div class="grid">
      <!-- ESQUERDA: Índices -->
      <div class="card orderIndex" id="panelIndex">
        <div class="h">CNT (índice único Brasil)</div>
        <div class="big"><span id="cntVal">--</span><span style="font-size:18px; opacity:.8">/100</span></div>
        <div class="muted">RAW auditável: <b id="rawVal">--</b></div>

        <div class="row"><strong>A — Estado</strong><span id="aVal">--</span></div>
        <div class="row"><strong>B — Tendência</strong><span id="bVal">--</span></div>
        <div class="row"><strong>C — Estabilidade</strong><span id="cVal">--</span></div>
        <div class="row"><strong>Grau</strong><span id="gVal">--</span></div>

        <div style="margin-top:14px" class="h">Sub-índices</div>
        <div class="subgrid">
          <div class="pill"><b>IBE</b><i id="ibeVal">--</i></div>
          <div class="pill"><b>IAB</b><i id="iabVal">--</i></div>
          <div class="pill"><b>IBI</b><i id="ibiVal">--</i></div>
          <div class="pill"><b>HID</b><i id="hidVal">--</i></div>
          <div class="pill"><b>ENT</b><i id="entVal">--</i></div>
          <div class="pill"><b>PAN</b><i id="panVal">--</i></div>
        </div>

        <div class="foot" id="status">Status: iniciando…</div>
      </div>

      <!-- CENTRO: Mapa -->
      <div class="card mapWrap orderMap">
        <div class="mapStage" id="stage">
          <div class="hint" id="hint">Carregando mapa base + holograma…</div>

          <div class="mapBase">
            <img id="baseImg" alt="Mapa base" />
          </div>

          <!-- linhas/água/limites (opcional) -->
          <canvas id="lines"></canvas>
          <!-- pontos holográficos -->
          <canvas id="hud"></canvas>

          <div class="loadingBar" id="bar"><i id="barFill"></i></div>
        </div>
      </div>

      <!-- DIREITA: Comprar + Telemetria -->
      <div class="card orderBuy" id="panelBuy">
        <div class="buyTitle">COMPRAR CNT</div>
        <div class="muted" style="margin-bottom:10px">Abre o token no Pump.fun.</div>

        <div class="muted" style="margin:6px 0">Contribuição</div>
        <input id="amt" class="input" value="0,10" inputmode="decimal"/>

        <button class="btn" id="buyBtn">Comprar no Pump</button>

        <div class="muted" style="margin-top:12px">
          Estimativa: <b style="font-size:22px" id="estCnt">-- CNT</b><br/>
          <span style="opacity:.85">Estimativa demo (não é cotação real).</span>
        </div>

        <div style="height:14px"></div>
        <div class="h" style="font-size:13px; color:rgba(200,243,255,.92)">TELEMETRIA — Série 10 anos</div>
        <div class="spark" id="spark"></div>
        <div class="foot" id="sparkFoot">Carregando…</div>
      </div>
    </div>
  </div>

<script>
(() => {
  // =============================
  // CONFIG (edite só isso)
  // =============================
  const PUMP_URL = "https://pump.fun/coin/GCVyjNaCbXkwGUuktyNxSXad4ozmTp2fzQr2jieSpump";

  // preferências de arquivo (mais rápido -> mais pesado)
  const FILES = {
    baseMap: "mapa_base.png",
    // pontos prontos (rápido)
    pointsJson: "layers_points.json",     // recomendado (JSON simples)
    pointsGeojson: "vege_pts.geojson",    // fallback (geojson)
    // opcional: linhas/água (se você tiver)
    linesGeojson: "micro_rh.geojson",     // pode trocar para 'macro_rh.geojson' ou remover
    // fallback excel (lento)
    xlsxFallback: "MAPBIOMAS_BRAZIL-COL.10-DEFORESTATION_BIOME_STATE.xlsx"
  };

  // densidade/peso no índice
  const WEIGHTS = {
    green:  +1.0,   // vegetação
    yellow: +0.4,   // transição
    red:    -1.2    // desmatamento
  };

  // performance mobile: limita pontos renderizados (mantém visual)
  const MAX_POINTS_DESKTOP = 45000;
  const MAX_POINTS_MOBILE  = 18000;

  // =============================
  // HELPERS
  // =============================
  const $ = (id)=>document.getElementById(id);

  // base path certo no GitHub Pages (repo pages)
  const BASE = new URL(".", location.href);
  const assetURL = (name) => new URL(name, BASE).toString();

  function setStatus(msg){
    $("status").textContent = "Status: " + msg;
  }
  function setHint(msg){
    $("hint").textContent = msg;
  }
  function setBar(p){
    $("barFill").style.width = Math.max(0, Math.min(100, p)) + "%";
  }

  function isMobile(){
    return matchMedia("(max-width: 980px)").matches || /Android|iPhone|iPad/i.test(navigator.userAgent);
  }

  function fmt(n, d=2){
    if (n === null || n === undefined || Number.isNaN(n)) return "--";
    return Number(n).toLocaleString("pt-BR", {minimumFractionDigits:d, maximumFractionDigits:d});
  }

  function clamp(v,a,b){ return Math.max(a, Math.min(b, v)); }

  function safeJsonParse(text){
    try { return JSON.parse(text); } catch(e){ return null; }
  }

  async function fetchText(url){
    const r = await fetch(url, {cache:"no-store"});
    if(!r.ok) throw new Error("HTTP " + r.status);
    return await r.text();
  }
  async function fetchJson(url){
    const r = await fetch(url, {cache:"no-store"});
    if(!r.ok) throw new Error("HTTP " + r.status);
    return await r.json();
  }

  // =============================
  // MAP STAGE SETUP
  // =============================
  const stage = $("stage");
  const baseImg = $("baseImg");

  // canvases
  const hud = $("hud");
  const lines = $("lines");
  const ctx = hud.getContext("2d", {alpha:true});
  const lctx = lines.getContext("2d", {alpha:true});

  function resize(){
    const r = stage.getBoundingClientRect();
    hud.width = Math.floor(r.width * devicePixelRatio);
    hud.height = Math.floor(r.height * devicePixelRatio);
    lines.width = Math.floor(r.width * devicePixelRatio);
    lines.height = Math.floor(r.height * devicePixelRatio);
  }
  window.addEventListener("resize", resize, {passive:true});

  // =============================
  // POINT MODEL
  // =============================
  // internal normalized points: {x:0..1, y:0..1, c:"g|y|r", w:0..1}
  let PTS = [];
  let t0 = performance.now();

  // =============================
  // DRAW: LINES (optional)
  // =============================
  function drawLines(features){
    // desenha rios/linhas em azul (muito leve)
    // exige que as coords estejam em lon/lat -> aqui só damos um "look" holográfico aproximado:
    // se seu geojson já estiver em coordenadas do mapa base (0..1), funciona perfeito.
    const W = lines.width, H = lines.height;
    lctx.clearRect(0,0,W,H);
    lctx.save();
    lctx.globalCompositeOperation = "screen";

    lctx.lineWidth = 1.2 * devicePixelRatio;
    lctx.strokeStyle = "rgba(90,200,255,.75)";
    lctx.shadowBlur = 14 * devicePixelRatio;
    lctx.shadowColor = "rgba(90,200,255,.55)";

    function projXY(coord){
      // Se vier normalizado (0..1): usa direto
      if (Math.abs(coord[0]) <= 2 && Math.abs(coord[1]) <= 2) {
        return [coord[0]*W, coord[1]*H];
      }
      // fallback: lon/lat (aproxima Brasil) -> ajuste tosco só pra “efeito”
      const lon = coord[0], lat = coord[1];
      const x = (lon + 74) / (34);   // -74..-40 ~ Brasil
      const y = 1 - ((lat + 34) / (39)); // -34..5
      return [clamp(x,0,1)*W, clamp(y,0,1)*H];
    }

    for (const f of features){
      const g = f.geometry;
      if(!g) continue;
      if(g.type==="LineString"){
        lctx.beginPath();
        g.coordinates.forEach((c,i)=>{
          const [x,y] = projXY(c);
          if(i===0) lctx.moveTo(x,y); else lctx.lineTo(x,y);
        });
        lctx.stroke();
      } else if(g.type==="MultiLineString"){
        for(const line of g.coordinates){
          lctx.beginPath();
          line.forEach((c,i)=>{
            const [x,y] = projXY(c);
            if(i===0) lctx.moveTo(x,y); else lctx.lineTo(x,y);
          });
          lctx.stroke();
        }
      }
    }
    lctx.restore();
  }

  // =============================
  // DRAW: HUD POINTS (hologram)
  // =============================
  function colorFor(c){
    if(c==="g") return [80, 255, 190];
    if(c==="y") return [255, 220, 80];
    return [255, 90, 70]; // r
  }

  function render(){
    const now = performance.now();
    const dt = (now - t0) * 0.001;
    t0 = now;

    const W = hud.width, H = hud.height;
    ctx.clearRect(0,0,W,H);

    // fundo holográfico leve
    ctx.save();
    ctx.globalCompositeOperation = "screen";
    ctx.fillStyle = "rgba(0,0,0,0)";
    ctx.fillRect(0,0,W,H);
    ctx.restore();

    if (!PTS.length) {
      requestAnimationFrame(render);
      return;
    }

    const pulse = 0.5 + 0.5*Math.sin(now*0.003); // 0..1
    const baseR = (isMobile()? 1.15 : 1.0) * devicePixelRatio; // ponto pequeno

    // render em batches
    ctx.save();
    ctx.globalCompositeOperation = "screen";

    for (let i=0;i<PTS.length;i++){
      const p = PTS[i];
      const x = p.x * W;
      const y = p.y * H;

      // pulsação por ponto (fase diferente)
      const ph = (i % 97) * 0.064;
      const k = 0.55 + 0.45*Math.sin(now*0.004 + ph);

      const r = baseR * (0.7 + 0.9*k) * (0.9 + 0.4*p.w);
      const [R,G,B] = colorFor(p.c);

      // núcleo
      ctx.fillStyle = `rgba(${R},${G},${B},${0.22 + 0.28*p.w})`;
      ctx.beginPath();
      ctx.arc(x,y,r,0,Math.PI*2);
      ctx.fill();

      // halo (glow)
      ctx.fillStyle = `rgba(${R},${G},${B},${0.05 + 0.08*p.w})`;
      ctx.beginPath();
      ctx.arc(x,y,r*3.8*(0.85+0.3*pulse),0,Math.PI*2);
      ctx.fill();
    }

    // borda holográfica (leve)
    ctx.save();
    ctx.globalCompositeOperation = "screen";
    ctx.strokeStyle = "rgba(110,210,255,.10)";
    ctx.lineWidth = 2 * devicePixelRatio;
    ctx.strokeRect(8*devicePixelRatio, 8*devicePixelRatio, W-16*devicePixelRatio, H-16*devicePixelRatio);
    ctx.restore();

    ctx.restore();
    requestAnimationFrame(render);
  }

  // =============================
  // DATA -> INDEX
  // =============================
  function computeIndexFromPoints(points){
    let g=0,y=0,r=0;
    for(const p of points){
      if(p.c==="g") g++;
      else if(p.c==="y") y++;
      else r++;
    }
    const total = Math.max(1, g+y+r);

    const scoreRaw = (g*WEIGHTS.green + y*WEIGHTS.yellow + r*WEIGHTS.red) / total; // -1..+1 aprox
    const score = clamp(50 + scoreRaw*50, 0, 100);

    // subíndices simples (você pode trocar pelos reais depois)
    const IBE = clamp((g/total)*100, 0, 100);
    const IBI = clamp((y/total)*100, 0, 100);
    const HID = clamp(1.03, 0, 5);     // placeholder (mantém seu visual)
    const ENT = clamp(100 - (r/total)*100, 0, 100);
    const PAN = clamp((r/total)*40, 0, 100); // penalidade

    // A/B/C visuais
    const A = score;
    const B = clamp((y/total - r/total)*1.5, -1.5, 1.5);
    const C = clamp(0.2 + 0.8*(1 - r/total), 0, 1);

    const grau = score>=85?"A":score>=70?"B":score>=55?"C":score>=40?"D":"E";

    return {
      score,
      raw: Math.abs(scoreRaw*25), // “RAW auditável” demo
      A,B,C,grau,
      IBE,
      IAB: null,
      IBI,
      HID,
      ENT,
      PAN,
      counts:{g,y,r,total}
    };
  }

  function applyIndex(ix){
    $("cntVal").textContent = fmt(ix.score, 1).replace(".", ",");
    $("rawVal").textContent = fmt(ix.raw, 2);

    $("aVal").textContent = fmt(ix.A, 2);
    $("bVal").textContent = fmt(ix.B, 2);
    $("cVal").textContent = fmt(ix.C, 2);
    $("gVal").textContent = ix.grau;

    $("ibeVal").textContent = fmt(ix.IBE, 1);
    $("iabVal").textContent = ix.IAB===null ? "N/D" : fmt(ix.IAB, 1);
    $("ibiVal").textContent = fmt(ix.IBI, 1);
    $("hidVal").textContent = fmt(ix.HID, 2);
    $("entVal").textContent = fmt(ix.ENT, 1);
    $("panVal").textContent = fmt(ix.PAN, 1);

    // estimativa demo: liga com score (só demo)
    const amt = parseFloat(String($("amt").value).replace(",", ".")) || 0.1;
    const est = Math.max(0, Math.round((ix.score*1000) * (amt*200)));
    $("estCnt").textContent = est.toLocaleString("pt-BR") + " CNT";
  }

  // =============================
  // TELEMETRIA
  // =============================
  function drawSpark(values){
    const w = 420, h = 110, pad = 10;
    const min = Math.min(...values), max = Math.max(...values);
    const norm = (v)=> (max===min)? 0.5 : (v-min)/(max-min);

    const pts = values.map((v,i)=>{
      const x = pad + (i/(values.length-1))*(w-2*pad);
      const y = pad + (1-norm(v))*(h-2*pad);
      return [x,y];
    });

    const d = pts.map((p,i)=> (i? "L":"M")+p[0].toFixed(2)+","+p[1].toFixed(2)).join(" ");
    $("spark").innerHTML = `
      <svg viewBox="0 0 ${w} ${h}" preserveAspectRatio="none">
        <path d="${d}" fill="none" stroke="rgba(110,210,255,.95)" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/>
        <path d="${d} L ${w-pad} ${h-pad} L ${pad} ${h-pad} Z" fill="rgba(110,210,255,.08)"/>
      </svg>
    `;
  }

  // =============================
  // LOAD POINTS (fast -> geojson -> xlsx)
  // =============================
  function normalizePointsFromLayersJSON(obj){
    // Esperado:
    // [
    //   {"x":0.52,"y":0.31,"class":"green","w":0.8},
    //   ...
    // ]
    // OU {points:[...]}
    const arr = Array.isArray(obj) ? obj : (obj && obj.points ? obj.points : null);
    if(!arr || !arr.length) return [];

    const max = isMobile() ? MAX_POINTS_MOBILE : MAX_POINTS_DESKTOP;
    const step = Math.ceil(arr.length / max);

    const out = [];
    for(let i=0;i<arr.length;i+=step){
      const p = arr[i];
      const x = Number(p.x), y = Number(p.y);
      if(!Number.isFinite(x) || !Number.isFinite(y)) continue;

      let c = (p.class || p.c || "").toLowerCase();
      if(c.startsWith("g")) c="g";
      else if(c.startsWith("y") || c.includes("trans")) c="y";
      else c="r";

      const w = clamp(Number(p.w ?? p.weight ?? 0.6) || 0.6, 0.15, 1.0);
      out.push({x:clamp(x,0,1), y:clamp(y,0,1), c, w});
    }
    return out;
  }

  function normalizePointsFromGeoJSON(geo){
    // Esperado: Point com lon/lat OU coords normalizadas 0..1
    const feats = geo.features || [];
    const coords = [];
    const cls = [];

    for(const f of feats){
      if(!f.geometry) continue;
      if(f.geometry.type==="Point"){
        coords.push(f.geometry.coordinates);
        const props = f.properties || {};
        const c0 = (props.class || props.c || props.type || props.label || "").toString().toLowerCase();
        if(c0.includes("water")||c0.includes("agua")) cls.push("b");
        else if(c0.includes("veg")||c0.includes("green")||c0.includes("flora")) cls.push("g");
        else if(c0.includes("trans")||c0.includes("yellow")) cls.push("y");
        else cls.push("r");
      }
    }
    if(!coords.length) return [];

    const max = isMobile() ? MAX_POINTS_MOBILE : MAX_POINTS_DESKTOP;
    const step = Math.ceil(coords.length / max);

    const out = [];
    for(let i=0;i<coords.length;i+=step){
      const c = coords[i];
      let x,y;
      // normalizado
      if (Math.abs(c[0]) <= 2 && Math.abs(c[1]) <= 2) {
        x = c[0]; y = c[1];
      } else {
        // lon/lat approx Brasil
        const lon = c[0], lat = c[1];
        x = (lon + 74) / 34;
        y = 1 - ((lat + 34) / 39);
      }
      const k = cls[i]==="g"?"g":cls[i]==="y"?"y":"r";
      out.push({x:clamp(x,0,1), y:clamp(y,0,1), c:k, w:0.65});
    }
    return out;
  }

  async function pointsFromXLSX(url){
    // Isso é fallback. Pra funcionar bem, a planilha precisa ter colunas:
    // - lon / lng / longitude
    // - lat / latitude
    // - class (green/yellow/red) OU algum campo que você mapeie aqui
    const r = await fetch(url);
    if(!r.ok) throw new Error("HTTP " + r.status);
    const buf = await r.arrayBuffer();
    const wb = XLSX.read(buf, {type:"array"});
    const sheet = wb.Sheets[wb.SheetNames[0]];
    const rows = XLSX.utils.sheet_to_json(sheet, {defval:null});

    if(!rows.length) return [];

    // detectar colunas
    const keys = Object.keys(rows[0]||{}).map(k=>k.toLowerCase());
    const findKey = (cands)=>{
      for(const c of cands){
        const idx = keys.findIndex(k=>k===c || k.includes(c));
        if(idx>=0) return Object.keys(rows[0])[idx];
      }
      return null;
    }

    const kLon = findKey(["lon","lng","longitude","long"]);
    const kLat = findKey(["lat","latitude"]);
    const kClass = findKey(["class","classe","tipo","category","categoria","label"]);

    if(!kLon || !kLat) throw new Error("XLSX sem colunas lon/lat detectáveis.");

    const ptsRaw = [];
    for(const row of rows){
      const lon = Number(row[kLon]);
      const lat = Number(row[kLat]);
      if(!Number.isFinite(lon) || !Number.isFinite(lat)) continue;

      let c = "r";
      const v = (kClass? (row[kClass]??"") : "").toString().toLowerCase();
      if(v.includes("veg")||v.includes("green")||v.includes("veget")) c="g";
      else if(v.includes("trans")||v.includes("yellow")||v.includes("past")||v.includes("agro")) c="y";
      else if(v.includes("desm")||v.includes("defor")||v.includes("red")||v.includes("fire")||v.includes("fogo")) c="r";

      // proj approx Brasil
      const x = (lon + 74) / 34;
      const y = 1 - ((lat + 34) / 39);

      ptsRaw.push({x:clamp(x,0,1), y:clamp(y,0,1), c, w:0.6});
    }

    const max = isMobile() ? MAX_POINTS_MOBILE : MAX_POINTS_DESKTOP;
    const step = Math.ceil(ptsRaw.length / max);
    const out = [];
    for(let i=0;i<ptsRaw.length;i+=step) out.push(ptsRaw[i]);
    return out;
  }

  async function loadPoints(){
    // 1) layers_points.json
    try{
      setStatus("carregando pontos (rápido) …");
      setHint("Carregando pontos prontos (rápido)…");
      setBar(15);

      const obj = await fetchJson(assetURL(FILES.pointsJson));
      const pts = normalizePointsFromLayersJSON(obj);
      if(pts.length){
        $("chipMode").textContent = `Holograma: points.json (${pts.length.toLocaleString("pt-BR")} pts)`;
        return pts;
      }
    }catch(e){}

    // 2) vege_pts.geojson
    try{
      setStatus("carregando GeoJSON…");
      setHint("Carregando GeoJSON…");
      setBar(35);

      const geo = await fetchJson(assetURL(FILES.pointsGeojson));
      const pts = normalizePointsFromGeoJSON(geo);
      if(pts.length){
        $("chipMode").textContent = `Holograma: GeoJSON (${pts.length.toLocaleString("pt-BR")} pts)`;
        return pts;
      }
    }catch(e){}

    // 3) XLSX fallback
    try{
      setStatus("carregando Excel (fallback)…");
      setHint("Fallback Excel (mais lento)…");
      setBar(55);

      // esperar SheetJS
      const waitSheet = async ()=>{
        for(let i=0;i<60;i++){
          if(window.XLSX) return;
          await new Promise(r=>setTimeout(r, 50));
        }
        throw new Error("SheetJS não carregou.");
      };
      await waitSheet();

      const pts = await pointsFromXLSX(assetURL(FILES.xlsxFallback));
      if(pts.length){
        $("chipMode").textContent = `Holograma: XLSX fallback (${pts.length.toLocaleString("pt-BR")} pts)`;
        return pts;
      }
    }catch(e){}

    return [];
  }

  // =============================
  // INIT
  // =============================
  async function init(){
    resize();

    // botões
    $("buyBtn").addEventListener("click", ()=>{
      window.open(PUMP_URL, "_blank", "noopener,noreferrer");
    });

    $("amt").addEventListener("input", ()=>{
      // reestimar depois que índice existir
      if(PTS.length){
        const ix = computeIndexFromPoints(PTS);
        applyIndex(ix);
      }
    });

    // carregar mapa base
    setBar(5);
    baseImg.src = assetURL(FILES.baseMap);
    baseImg.onload = ()=>{ setBar(10); };
    baseImg.onerror = ()=>{
      setStatus("ERRO: mapa_base.png não carregou (nome/pasta errado).");
      setHint("Erro ao carregar mapa_base.png — confira o nome/posição do arquivo.");
    };

    // (opcional) linhas
    try{
      const geoLines = await fetchJson(assetURL(FILES.linesGeojson));
      if(geoLines && geoLines.features){
        drawLines(geoLines.features);
      }
    }catch(e){
      // ok sem linhas
    }

    // carregar pontos
    const pts = await loadPoints();
    if(!pts.length){
      setStatus("ERRO: nenhum ponto carregou. Confira layers_points.json / vege_pts.geojson / xlsx.");
      setHint("Nenhum ponto carregou — verifique nomes e pasta.");
      setBar(0);
      return;
    }

    PTS = pts;
    setBar(100);
    $("bar").style.display = "none";
    setHint("");

    // índice + telemetria
    const ix = computeIndexFromPoints(PTS);
    applyIndex(ix);

    // telemetria: usa o índice para gerar série (demo coerente)
    const base = ix.score;
    const series = Array.from({length:10}, (_,i)=>{
      const wobble = Math.sin(i*0.7)*4 + (Math.random()-0.5)*3;
      return clamp(base + wobble, 0, 100);
    });
    drawSpark(series);
    $("sparkFoot").textContent = `Histórico: 10 • Último (RAW): ${fmt(ix.raw,2)}`;

    setStatus(`OK • Pontos: ${ix.counts.total.toLocaleString("pt-BR")} • Base: ${BASE.pathname}`);
    setHint("");

    // iniciar render loop
    render();
  }

  init().catch(err=>{
    setStatus("ERRO geral: " + (err?.message || err));
    setHint("Erro geral — abra console (F12) no PC pra ver detalhes.");
    console.error(err);
  });
})();
</script>
</body>
</html>
