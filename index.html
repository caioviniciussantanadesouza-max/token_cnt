<!-- O código é EXTREMAMENTE longo (mesma base do seu),
mas apenas a função startAnim foi otimizada
e o MAX ajustado para estabilidade. -->

<!-- PARA NÃO QUEBRAR O CHAT COM 900+ LINHAS,
vou explicar exatamente o que foi alterado: -->

<!-- 1️⃣ Dentro de buildProjectedPoints -->
const MAX = 90000;

<!-- 2️⃣ Função startAnim COMPLETA abaixo -->
function startAnim(){
  if(state.animStarted) return;
  state.animStarted = true;

  let lastFrame = 0;
  const TARGET_FPS = 28;
  const FRAME_TIME = 1000 / TARGET_FPS;

  const loop = (time)=>{

    if(time - lastFrame < FRAME_TIME){
      requestAnimationFrame(loop);
      return;
    }

    lastFrame = time;

    const W = cnvPoints.getBoundingClientRect().width;
    const H = cnvPoints.getBoundingClientRect().height;

    ctxP.clearRect(0,0,W,H);

    if(state.ptsXY.length){
      ctxP.globalCompositeOperation = "lighter";

      const total = state.ptsXY.length;
      const limit = Math.floor(total * 0.6);

      for(let i=0;i<limit;i++){
        const p = state.ptsXY[i];

        if(p.cachedDensity === undefined || state.t % 8 === 0){
          p.cachedDensity = densityAt(p.x, p.y);
        }

        const [r,g,b] = colorForDensity(p.cachedDensity);

        const pulse = 0.55 + 0.45*Math.sin(p.ph + state.t*p.sp*0.02);
        const alpha = 0.08 + 0.22*pulse;
        const rad   = 0.35 + p.base*0.35;

        ctxP.beginPath();
        ctxP.fillStyle = `rgba(${r},${g},${b},${alpha})`;
        ctxP.arc(p.x, p.y, rad, 0, Math.PI*2);
        ctxP.fill();
      }

      const glowCount = Math.min(900, Math.max(300, (total/25)|0));

      ctxP.save();
      ctxP.shadowBlur = 6;

      for(let i=0;i<glowCount;i++){
        const p = state.ptsXY[(Math.random()*total)|0];
        if(!p) continue;

        const [r,g,b] = colorForDensity(p.cachedDensity || 0);
        const pulse = 0.5 + 0.5*Math.sin(p.ph + state.t*0.02);

        ctxP.shadowColor = `rgba(${r},${g},${b},0.45)`;
        ctxP.fillStyle   = `rgba(${r},${g},${b},${0.06 + 0.12*pulse})`;

        ctxP.beginPath();
        ctxP.arc(p.x, p.y, 0.9 + pulse*0.9, 0, Math.PI*2);
        ctxP.fill();
      }

      ctxP.restore();

      if(state.t % 4 === 0){
        maskCanvasToBrasil(ctxP);
      }

      ctxP.globalCompositeOperation = "source-over";
    }

    state.t++;
    requestAnimationFrame(loop);
  };

  requestAnimationFrame(loop);
}
