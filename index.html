<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>CNT — Centro Natural TEC Amazônia</title>

<style>
:root{
  --bg0:#000;
  --bg1:#050b10;
  --hud: rgba(110,210,255,.95);
  --hud2: rgba(110,210,255,.55);
  --stroke: rgba(110,210,255,.18);
  --glass: rgba(2,12,24,.46);
  --text: #c8f3ff;
  --muted:#86dcff;
  --shadow: 0 0 22px rgba(110,210,255,.14), 0 0 70px rgba(0,200,255,.08);
}
*{ box-sizing:border-box; }
html,body{ margin:0; height:100%; background: radial-gradient(1200px 700px at 50% 35%, var(--bg1), var(--bg0) 70%); color:var(--text); font-family:Segoe UI, Arial, sans-serif; }
body{ overflow:hidden; }

#app{
  position:fixed; inset:0;
  display:grid;
  grid-template-columns: 320px 1fr 360px;
  grid-template-rows: 124px minmax(0,1fr);
  gap:14px;
  padding:14px;
}

.glass{
  background: var(--glass);
  backdrop-filter: blur(14px);
  border:1px solid var(--stroke);
  border-radius:22px;
  box-shadow: var(--shadow);
}

#header{
  grid-column:1/4;
  padding:14px 16px;
  border-radius:24px;
  display:flex;
  flex-direction:column;
  justify-content:center;
  gap:8px;
}
#header h1{ margin:0; font-size:28px; letter-spacing:.6px; font-weight:900; color:#e9fdff; text-align:center; }
#header .sub{ margin:0; text-align:center; font-size:12px; color:var(--muted); opacity:.95; }

#chips{ display:flex; justify-content:center; gap:10px; flex-wrap:wrap; }
.chip{
  font-size:11px;
  padding:7px 10px;
  border-radius:999px;
  border:1px solid rgba(110,210,255,.22);
  background: rgba(0,0,0,.20);
  color:#cfefff;
  opacity:.95;
}

/* LEFT */
#left{ padding:12px; display:flex; flex-direction:column; gap:8px; min-height:0; overflow:hidden; }
.big{ font-size:58px; line-height:1; font-weight:260; color:#e9fdff; margin:0; }
.small{ font-size:12px; color:var(--muted); opacity:.95; }
.hr{ height:1px; background:linear-gradient(90deg,transparent,rgba(110,210,255,.30),transparent); margin:6px 0; }

.abclist{ display:grid; gap:8px; }
.abcline{
  display:flex; justify-content:space-between; align-items:center;
  padding:7px 10px;
  border:1px solid rgba(110,210,255,.14);
  background:rgba(0,0,0,.18);
  border-radius:14px;
  font-size:12px;
}
.abcline b{ color:#e9fdff; font-weight:900; }
.abcline span{ color:#d5fbff; font-weight:900; }

.grid2{ display:grid; grid-template-columns: 1fr 1fr; gap:8px 10px; }
.kv{
  display:flex; justify-content:space-between; align-items:center;
  font-size:12px;
  padding:7px 10px;
  border:1px solid rgba(110,210,255,.16);
  border-radius:14px;
  background:rgba(0,0,0,.18);
}
.kv b{ font-weight:900; color:#e9fdff; }
.kv span{ color:#d0fbff; font-weight:900; }
#status{ margin-top:4px; font-size:10px; color:rgba(180,245,255,.9); opacity:.85; line-height:1.2; }

/* CENTER */
#center{ position:relative; overflow:hidden; border-radius:26px; min-height:0; }
#mapWrap{
  position:absolute; inset:0;
  display:flex; align-items:center; justify-content:center;
  background: radial-gradient(900px 600px at 50% 40%, rgba(20,60,80,.35), rgba(0,0,0,1) 70%);
}
#mapImg{
  position:absolute;
  width:min(96%, 980px);
  height:auto;
  max-height:92%;
  object-fit:contain;
  filter: drop-shadow(0 0 24px rgba(120,220,255,.25)) drop-shadow(0 0 60px rgba(0,200,255,.10));
  opacity: .95;
  pointer-events:none;
  user-select:none;
}
.layer{ position:absolute; inset:0; width:100%; height:100%; pointer-events:none; }

/* holograma */
#mapGlow{
  position:absolute; inset:-10%;
  pointer-events:none;
  mix-blend-mode: screen;
  opacity:.26;
  filter: blur(12px);
  background:
    radial-gradient(circle at 42% 55%, rgba(120,220,255,.25), transparent 52%),
    radial-gradient(circle at 70% 45%, rgba(120,220,255,.18), transparent 60%),
    radial-gradient(circle at 35% 70%, rgba(120,220,255,.12), transparent 60%);
  animation: glowPulse 6s ease-in-out infinite;
}
@keyframes glowPulse{ 0%{opacity:.18; transform:scale(1);} 50%{opacity:.34; transform:scale(1.02);} 100%{opacity:.18; transform:scale(1);} }

#scanlines{
  position:absolute; inset:0;
  pointer-events:none;
  opacity:.14;
  background: repeating-linear-gradient(to bottom, rgba(120,220,255,.06) 0px, rgba(120,220,255,.06) 1px, transparent 2px, transparent 7px);
  mix-blend-mode: overlay;
  animation: scan 3.2s linear infinite;
}
@keyframes scan{ 0%{transform:translateY(-22px);} 100%{transform:translateY(22px);} }

#toastErr{
  position:absolute; left:14px; bottom:14px;
  max-width:min(560px, 88vw);
  padding:10px 12px;
  border-radius:14px;
  border:1px solid rgba(255,120,120,.35);
  background: rgba(40,0,0,.35);
  color:#ffd9d9;
  font-size:11px;
  line-height:1.25;
  display:none;
  white-space:pre-wrap;
  z-index:6;
}

/* RIGHT */
#right{ display:flex; flex-direction:column; gap:14px; min-height:0; }
#buy, #telemetry{ padding:14px; }
#buy h2{ margin:0; font-size:18px; font-weight:900; letter-spacing:.4px; color:#e9fdff; }
#buy .mut{ margin:8px 0 10px; font-size:12px; color:var(--muted); opacity:.95; line-height:1.35; }

label{ display:block; font-size:12px; color:var(--muted); margin:10px 0 6px; }
.row{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
input{
  width:170px;
  padding:10px 12px;
  border-radius:14px;
  border:1px solid rgba(110,210,255,.35);
  background:rgba(0,0,0,.18);
  color:#e9fbff;
  outline:none;
}
input:focus{ border-color: rgba(110,210,255,.70); box-shadow: 0 0 16px rgba(110,210,255,.18); }
.btn{
  background:linear-gradient(180deg,rgba(110,210,255,.20),rgba(0,0,0,.16));
  border:1px solid rgba(110,210,255,.45);
  color:#eafcff;
  border-radius:14px;
  padding:10px 13px;
  cursor:pointer;
  font-weight:900;
  letter-spacing:.2px;
  min-width:160px;
}
.btn:hover{ box-shadow:0 0 18px rgba(110,210,255,.30); }

.valueLine{ margin-top:10px; font-size:12px; color:#bdf4ff; }
.valueLine b{ font-size:19px; color:#e9fdff; }
.smallnote{ margin-top:6px; font-size:11px; color:var(--muted); opacity:.95; }

#telemetryTitle{ font-size:12px; letter-spacing:.8px; color:#d4fbff; opacity:.95; margin-bottom:8px; font-weight:900; }
#wave{
  width:100%; height:74px; display:block;
  background: rgba(0,0,0,.22);
  border:1px solid rgba(110,210,255,.14);
  border-radius:14px;
}
#telemetryHint{ margin-top:8px; font-size:11px; color:var(--muted); opacity:.92; }

/* MOBILE: Compra antes do mapa */
@media (max-width: 1100px){
  body{ overflow:auto; }
  #app{
    position:relative;
    grid-template-columns: 1fr;
    grid-template-rows: auto auto auto auto;
  }
  #header{ grid-column:auto; }
  #right{ order:1; }
  #center{ order:2; height:46vh; min-height:320px; }
  #left{ order:3; }
}
</style>
</head>

<body>
<div id="app">
  <div id="header" class="glass">
    <h1>CNT — Centro Natural TEC Amazônia</h1>
    <p class="sub">Mapa ecológico real • Água (azul) • Vegetação (verde) • Transição (amarelo) • Desmatamento (vermelho)</p>
    <div id="chips">
      <div class="chip">Fonte: dados públicos governamentais</div>
      <div class="chip">Ano base: 2025</div>
      <div class="chip">Holograma: MapBiomas/IBGE (pontos)</div>
      <div class="chip">Compra: Pump.fun</div>
    </div>
  </div>

  <div id="left" class="glass">
    <div class="small"><b>CNT</b> (índice único Brasil)</div>
    <div class="big"><span id="eco">--</span><span style="font-size:16px; opacity:.9;">/100</span></div>
    <div class="small">RAW auditável: <b id="raw">--</b></div>

    <div class="hr"></div>

    <div class="abclist">
      <div class="abcline"><b>A — Estado</b><span id="A">--</span></div>
      <div class="abcline"><b>B — Tendência</b><span id="B">--</span></div>
      <div class="abcline"><b>C — Estabilidade</b><span id="C">--</span></div>
      <div class="abcline"><b>Grau</b><span id="R">--</span></div>
    </div>

    <div class="hr"></div>

    <div class="small" style="font-weight:900; letter-spacing:.3px;">Sub-índices</div>
    <div class="grid2">
      <div class="kv"><b>IBE</b><span id="ibe">--</span></div>
      <div class="kv"><b>IAB</b><span id="iab">--</span></div>
      <div class="kv"><b>IBI</b><span id="ibi">--</span></div>
      <div class="kv"><b>HID</b><span id="hid">--</span></div>
      <div class="kv"><b>ENT</b><span id="ent">--</span></div>
      <div class="kv"><b>PAN</b><span id="pan">--</span></div>
    </div>

    <div id="status">Status: iniciando…</div>
  </div>

  <div id="center" class="glass">
    <div id="mapWrap">
      <img id="mapImg" src="mapa_base.png" alt="Mapa base CNT" />
      <canvas id="cnvPoints" class="layer"></canvas>
      <div id="mapGlow"></div>
      <div id="scanlines"></div>
      <div id="toastErr"></div>
    </div>
  </div>

  <div id="right">
    <div id="buy" class="glass">
      <h2>COMPRAR CNT</h2>
      <p class="mut">Abre o token no Pump.fun.</p>

      <label for="sol">Contribuição</label>
      <div class="row">
        <input id="sol" type="number" step="0.01" min="0" value="0.10" />
        <button class="btn" id="btnBuy" type="button">Comprar no Pump</button>
      </div>

      <div class="valueLine">Estimativa: <b id="out">-- CNT</b></div>
      <div class="smallnote">Estimativa demo (não é cotação real).</div>
    </div>

    <div id="telemetry" class="glass">
      <div id="telemetryTitle">TELEMETRIA — Série 10 anos</div>
      <canvas id="wave"></canvas>
      <div id="telemetryHint">Carregando…</div>
    </div>
  </div>
</div>

<script>
/* =========================
   CONFIG
========================= */
const PUMP_URL = "https://pump.fun/coin/GCVyjNaCbXkwGUuktyNxSXad4ozmTp2fzQr2jieSpump";
const RATE_SOL_TO_CNT = 147449130; // demo

// arquivos (usa o que existir)
const POINTS_FILES = [
  "layers_points.json",
  "vege_pts.geojson",
  "vege_pts_sample.geojson"
];

// Mapeamento de campos (se teu JSON usar outros nomes, ajusta aqui)
const FIELD_MAP = {
  lat: ["lat","latitude","y","LAT","LATITUDE"],
  lon: ["lon","lng","longitude","x","LON","LONG","LONGITUDE"],
  cls: ["class","classe","tipo","cat","category","label","CLASSE","CLASS"],
  val: ["value","v","score","peso","intensity","VAL","VALUE"]
};

// classes padrão
const CLASS_KEYS = {
  water: ["water","agua","hidro","hidrografia","river","rio","lago","lake"],
  veg: ["veg","vegetacao","vegetation","floresta","forest","mata","native_veg","secondary_veg","secveg"],
  tran: ["transition","transicao","mosaic","agro","pasture","lavoura","agricultura","uso_misto"],
  def: ["deforestation","desmatamento","deforest","clearcut","fire","fogo","burn","degradation","degradacao"]
};

// limites de pontos por performance (mobile)
const MAX_POINTS_DESKTOP = 22000;
const MAX_POINTS_MOBILE  = 9000;

/* =========================
   Helpers
========================= */
const $ = (id)=>document.getElementById(id);
const statusEl = $("status");
const toastErr = $("toastErr");
function showErr(msg){
  toastErr.style.display="block";
  toastErr.textContent = msg;
}
function fmt(n, d=2){
  if(n===null || n===undefined || !Number.isFinite(Number(n))) return "--";
  return Number(n).toFixed(d).replace(".", ",");
}
function clamp(v,a,b){ return Math.max(a, Math.min(b,v)); }

const BASE_URL = (() => {
  const u = new URL(location.href);
  const path = u.pathname.endsWith("/") ? u.pathname : u.pathname.substring(0, u.pathname.lastIndexOf("/") + 1);
  return u.origin + path;
})();

async function fetchText(rel){
  const url = BASE_URL + rel;
  const res = await fetch(url, { cache:"no-store" });
  if(!res.ok) throw new Error(`${rel} (HTTP ${res.status})`);
  return res.text();
}

function tryGet(obj, keys){
  for(const k of keys){
    if(obj && obj[k] !== undefined && obj[k] !== null) return obj[k];
  }
  return null;
}
function normalizeClass(s){
  if(!s) return "veg";
  const x = String(s).toLowerCase();
  const has = (arr)=>arr.some(a=>x.includes(a));
  if(has(CLASS_KEYS.water)) return "water";
  if(has(CLASS_KEYS.def))   return "def";
  if(has(CLASS_KEYS.tran))  return "tran";
  if(has(CLASS_KEYS.veg))   return "veg";
  return "veg";
}
function colorOf(cls){
  if(cls==="water") return [80,170,255];
  if(cls==="veg")   return [90,255,180];
  if(cls==="tran")  return [255,210,70];
  return [255,90,60];
}

/* =========================
   BUY
========================= */
function updateOut(){
  const sol = parseFloat($("sol").value) || 0;
  $("out").textContent = (sol * RATE_SOL_TO_CNT).toLocaleString("pt-BR") + " CNT";
}
$("sol").addEventListener("input", updateOut);
updateOut();
$("btnBuy").addEventListener("click", ()=> location.href = PUMP_URL);

/* =========================
   Telemetry
========================= */
const wave = $("wave");
const wctx = wave.getContext("2d");
let series = [10,12,11,15,14,13,12,8,11,12];

function resizeWave(){
  const dpr = Math.max(1, window.devicePixelRatio || 1);
  wave.width = Math.floor(wave.clientWidth * dpr);
  wave.height = Math.floor(wave.clientHeight * dpr);
  wctx.setTransform(dpr,0,0,dpr,0,0);
}
resizeWave();

let tWave=0;
function drawWave(){
  const W = wave.clientWidth, H = wave.clientHeight;
  wctx.clearRect(0,0,W,H);
  wctx.fillStyle="rgba(0,0,0,.25)";
  wctx.fillRect(0,0,W,H);

  const min = Math.min(...series);
  const max = Math.max(...series);

  function yAt(px){
    const idx = (px/(W-1)) * (series.length-1);
    const a = Math.floor(idx);
    const b = Math.min(series.length-1, a+1);
    const f = idx - a;
    const v = series[a]*(1-f) + series[b]*f;
    const norm = (max-min)<1e-9 ? 0.5 : (v-min)/(max-min);
    let y = (H*0.18) + (1-norm)*(H*0.68);
    y += Math.sin((px+tWave)/30)*(H*0.02);
    return y;
  }

  wctx.lineWidth=2;
  wctx.strokeStyle="rgba(110,210,255,.35)";
  wctx.beginPath();
  for(let x=0;x<W;x++){
    const y=yAt(x);
    if(x===0) wctx.moveTo(x,y); else wctx.lineTo(x,y);
  }
  wctx.stroke();

  wctx.strokeStyle="rgba(110,210,255,.90)";
  wctx.beginPath();
  for(let x=0;x<W;x++){
    const y=yAt(x);
    if(x===0) wctx.moveTo(x,y); else wctx.lineTo(x,y);
  }
  wctx.stroke();

  tWave += 2;
  requestAnimationFrame(drawWave);
}
drawWave();

/* =========================
   MAP -> converte lat/lon para pixel usando bbox do Brasil
   (simples e rápido)
========================= */
const BRAZIL_BBOX = { // approx (lon/lat)
  minLon: -74.0,
  maxLon: -34.0,
  minLat: -34.5,
  maxLat:  5.5
};

function projectLatLonToPixel(lon, lat, imgRect, canvasRect){
  // pega área real onde a imagem está desenhada (contain)
  const img = $("mapImg");
  const imgAR = img.naturalWidth / img.naturalHeight;
  const boxAR = imgRect.width / imgRect.height;

  let drawW, drawH, dx, dy;
  if(imgAR > boxAR){
    drawW = imgRect.width;
    drawH = imgRect.width / imgAR;
  } else {
    drawH = imgRect.height;
    drawW = imgRect.height * imgAR;
  }
  dx = (imgRect.left - canvasRect.left) + (imgRect.width - drawW)/2;
  dy = (imgRect.top  - canvasRect.top ) + (imgRect.height - drawH)/2;

  const xNorm = (lon - BRAZIL_BBOX.minLon) / (BRAZIL_BBOX.maxLon - BRAZIL_BBOX.minLon);
  const yNorm = (BRAZIL_BBOX.maxLat - lat) / (BRAZIL_BBOX.maxLat - BRAZIL_BBOX.minLat);

  const x = dx + xNorm * drawW;
  const y = dy + yNorm * drawH;

  return {x, y, drawBox:{dx,dy,drawW,drawH}};
}

/* =========================
   HOLOGRAMA de pontos (dados reais)
========================= */
const cnv = $("cnvPoints");
const ctx = cnv.getContext("2d");
let points = [];
let counts = {water:0, veg:0, tran:0, def:0};
let t=0;

function resizeCanvas(){
  const dpr = Math.max(1, window.devicePixelRatio || 1);
  const r = cnv.getBoundingClientRect();
  cnv.width = Math.floor(r.width * dpr);
  cnv.height = Math.floor(r.height * dpr);
  ctx.setTransform(dpr,0,0,dpr,0,0);
}
resizeCanvas();

window.addEventListener("resize", ()=>{
  resizeCanvas();
  resizeWave();
  // reprojeta pontos na nova tela
  if(points.length) buildProjectedPoints(points.__raw || []).catch(()=>{});
});

function limitForDevice(n){
  const isMobile = matchMedia("(max-width: 1100px)").matches;
  const limit = isMobile ? MAX_POINTS_MOBILE : MAX_POINTS_DESKTOP;
  return Math.min(n, limit);
}

async function loadPointsAny(){
  for(const f of POINTS_FILES){
    try{
      const txt = await fetchText(f);
      return {file:f, text:txt};
    }catch(e){}
  }
  throw new Error("Não encontrei 'layers_points.json' nem 'vege_pts.geojson'. Coloca um deles na mesma pasta do index.html.");
}

function parsePoints(payloadText){
  let data;
  try{
    data = JSON.parse(payloadText);
  }catch{
    // geojson às vezes vem com BOM/trailing — tenta limpar
    data = JSON.parse(payloadText.replace(/^\uFEFF/, "").trim());
  }

  let arr = [];
  // GeoJSON FeatureCollection
  if(data && data.type === "FeatureCollection" && Array.isArray(data.features)){
    for(const ft of data.features){
      const p = ft.properties || {};
      const geom = ft.geometry || {};
      let lon=null, lat=null;

      if(geom.type==="Point" && Array.isArray(geom.coordinates)){
        lon = geom.coordinates[0];
        lat = geom.coordinates[1];
      }else{
        // fallback por properties
        lat = tryGet(p, FIELD_MAP.lat);
        lon = tryGet(p, FIELD_MAP.lon);
      }

      const clsRaw = tryGet(p, FIELD_MAP.cls) ?? p.class ?? p.classe;
      const cls = normalizeClass(clsRaw);

      const val = Number(tryGet(p, FIELD_MAP.val) ?? 1) || 1;

      if(lon!==null && lat!==null){
        arr.push({lon:Number(lon), lat:Number(lat), cls, val});
      }
    }
  }
  // Array direto
  else if(Array.isArray(data)){
    for(const row of data){
      const lat = tryGet(row, FIELD_MAP.lat);
      const lon = tryGet(row, FIELD_MAP.lon);
      const clsRaw = tryGet(row, FIELD_MAP.cls);
      const cls = normalizeClass(clsRaw);
      const val = Number(tryGet(row, FIELD_MAP.val) ?? 1) || 1;
      if(lat!==null && lon!==null){
        arr.push({lon:Number(lon), lat:Number(lat), cls, val});
      }
    }
  }
  // Objeto com "points"
  else if(data && Array.isArray(data.points)){
    for(const row of data.points){
      const lat = tryGet(row, FIELD_MAP.lat);
      const lon = tryGet(row, FIELD_MAP.lon);
      const clsRaw = tryGet(row, FIELD_MAP.cls);
      const cls = normalizeClass(clsRaw);
      const val = Number(tryGet(row, FIELD_MAP.val) ?? 1) || 1;
      if(lat!==null && lon!==null){
        arr.push({lon:Number(lon), lat:Number(lat), cls, val});
      }
    }
  }

  if(!arr.length){
    throw new Error("Arquivo de pontos existe, mas não achei lat/lon + class. Ajusta FIELD_MAP no index.");
  }
  return arr;
}

async function buildProjectedPoints(rawPoints){
  points = [];
  points.__raw = rawPoints;

  counts = {water:0, veg:0, tran:0, def:0};

  const img = $("mapImg");
  if(!img.complete){
    await new Promise((ok,err)=>{
      img.onload=()=>ok();
      img.onerror=()=>err(new Error("Falha ao carregar mapa_base.png"));
    });
  }

  const imgRect = img.getBoundingClientRect();
  const cnvRect = cnv.getBoundingClientRect();

  const N = limitForDevice(rawPoints.length);

  // amostra uniforme se vier gigante
  const step = Math.max(1, Math.floor(rawPoints.length / N));

  for(let i=0, c=0; i<rawPoints.length && c<N; i+=step, c++){
    const rp = rawPoints[i];
    const {x,y, drawBox} = projectLatLonToPixel(rp.lon, rp.lat, imgRect, cnvRect);

    // filtra pontos fora do mapa desenhado
    if(x < drawBox.dx || x > drawBox.dx+drawBox.drawW || y < drawBox.dy || y > drawBox.dy+drawBox.drawH) continue;

    const cls = rp.cls;
    counts[cls]++;

    const [r,g,b] = colorOf(cls);
    // pontinho pequeno e real
    const base = 0.45 + Math.random()*0.75;
    const speed = 0.8 + Math.random()*1.7;

    points.push({
      x, y,
      r, g, b,
      base,
      phase: Math.random()*Math.PI*2,
      speed
    });
  }

  statusEl.textContent = `Status: OK • ${points.length.toLocaleString("pt-BR")} pontos reais • arquivo: ${rawFileName}`;
}

function computeIndexFromCounts(){
  const total = counts.water + counts.veg + counts.tran + counts.def;
  if(!total){
    return {
      eco: null, raw: null,
      A:null, B:null, C:null, grade:"--",
      ibe:null, iab:null, ibi:null
