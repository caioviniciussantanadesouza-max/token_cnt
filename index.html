<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>CNT — Centro Natural TEC Amazônia</title>

  <style>
    :root{
      --bg0:#000;
      --bg1:#050b10;
      --glass: rgba(2,12,24,.52);
      --glass2: rgba(2,12,24,.30);
      --stroke: rgba(110,210,255,.18);
      --hud: rgba(110,210,255,.92);
      --hud2: rgba(110,210,255,.55);
      --text:#c8f3ff;
      --muted:#86dcff;
      --shadow: 0 0 22px rgba(110,210,255,.14), 0 0 70px rgba(0,200,255,.08);
      --radius: 26px;
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; margin:0; }
    body{
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color: var(--text);
      background:
        radial-gradient(1200px 700px at 50% 20%, rgba(40,180,255,.10), rgba(0,0,0,0) 60%),
        radial-gradient(900px 600px at 30% 70%, rgba(0,255,170,.07), rgba(0,0,0,0) 55%),
        radial-gradient(900px 700px at 75% 75%, rgba(255,120,0,.06), rgba(0,0,0,0) 60%),
        linear-gradient(180deg, var(--bg1), var(--bg0));
      overflow-x:hidden;
    }

    .wrap{
      max-width: 1280px;
      margin: 18px auto 28px;
      padding: 0 14px;
    }

    .card{
      background: linear-gradient(180deg, rgba(10,20,30,.70), rgba(5,10,16,.60));
      border: 1px solid var(--stroke);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
    }

    header.card{
      padding: 22px 18px 16px;
      text-align:center;
    }

    h1{
      margin: 0;
      font-size: clamp(26px, 4vw, 44px);
      letter-spacing:.3px;
      font-weight: 800;
    }

    .sub{
      margin-top: 6px;
      color: var(--muted);
      font-size: 14px;
      letter-spacing:.2px;
    }

    .chips{
      display:flex;
      flex-wrap: wrap;
      gap: 10px;
      justify-content: center;
      margin-top: 14px;
    }

    .chip{
      font-size: 12px;
      color: rgba(200,245,255,.95);
      background: rgba(0,0,0,.35);
      border: 1px solid rgba(110,210,255,.25);
      padding: 8px 12px;
      border-radius: 999px;
      box-shadow: 0 0 20px rgba(110,210,255,.06);
      user-select:none;
    }

    .chip.btn{
      cursor:pointer;
      transition: .15s ease;
    }
    .chip.btn:hover{ transform: translateY(-1px); border-color: rgba(110,210,255,.45); }

    .grid{
      display:grid;
      grid-template-columns: 320px 1fr 320px;
      gap: 14px;
      margin-top: 14px;
      align-items: start;
    }

    /* Map */
    .mapCard{ padding: 10px; }
    .mapFrame{
      position: relative;
      border-radius: 22px;
      overflow: hidden;
      border: 1px solid rgba(110,210,255,.18);
      background:
        radial-gradient(600px 360px at 50% 45%, rgba(110,210,255,.10), rgba(0,0,0,.0) 65%),
        linear-gradient(180deg, rgba(0,0,0,.45), rgba(0,0,0,.65));
      min-height: 520px;
    }

    /* fundo real */
    .mapBase{
      position:absolute;
      inset:0;
      width:100%;
      height:100%;
      object-fit: contain;
      filter: contrast(1.05) saturate(1.05);
      opacity: .95;
      transform: translateZ(0);
    }

    /* canvas holograma */
    canvas#holo{
      position:absolute;
      inset:0;
      width:100%;
      height:100%;
      pointer-events:none;
      mix-blend-mode: screen;
      filter: drop-shadow(0 0 10px rgba(0,220,255,.22));
    }

    /* HUD glow around map */
    .mapFrame:before{
      content:"";
      position:absolute; inset:0;
      border-radius: 22px;
      box-shadow:
        inset 0 0 0 1px rgba(110,210,255,.10),
        inset 0 0 45px rgba(0,220,255,.08),
        0 0 70px rgba(0,220,255,.08);
      pointer-events:none;
    }

    /* Left panel */
    .panel{ padding: 14px; }
    .panel h3{
      margin:0 0 10px 0;
      font-size: 13px;
      color: var(--muted);
      letter-spacing:.3px;
      font-weight: 700;
    }
    .big{
      display:flex;
      align-items: baseline;
      gap: 10px;
      margin-top: 2px;
    }
    .big .val{
      font-size: 64px;
      letter-spacing:-1px;
      font-weight: 300;
    }
    .big .unit{ opacity:.8; }

    .kv{ margin-top: 6px; font-size: 13px; color: rgba(200,245,255,.85); }

    .rows{ margin-top: 12px; display:grid; gap: 10px; }
    .row{
      display:flex;
      justify-content: space-between;
      align-items:center;
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid rgba(110,210,255,.18);
      background: rgba(0,0,0,.30);
    }
    .row b{ font-size: 13px; }
    .row span{ font-variant-numeric: tabular-nums; }

    .subs{
      margin-top: 14px;
      color: var(--muted);
      font-weight:700;
      font-size: 13px;
    }
    .subgrid{
      margin-top: 10px;
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
    .pill{
      padding: 10px 12px;
      border-radius: 16px;
      border: 1px solid rgba(110,210,255,.18);
      background: rgba(0,0,0,.26);
      display:flex;
      justify-content: space-between;
      align-items:center;
      font-size: 13px;
    }
    .status{
      margin-top: 10px;
      font-size: 12px;
      color: rgba(200,245,255,.65);
    }

    /* Right panel */
    .buyTitle{
      font-size: 22px;
      margin: 2px 0 4px;
      font-weight: 800;
      letter-spacing:.3px;
    }
    .muted{ color: var(--muted); font-size: 13px; }

    .input{
      width:100%;
      padding: 12px 12px;
      border-radius: 14px;
      border: 1px solid rgba(110,210,255,.24);
      background: rgba(0,0,0,.28);
      color: var(--text);
      outline:none;
      font-size: 14px;
    }

    .btnBig{
      width: 100%;
      margin-top: 10px;
      padding: 12px 14px;
      border-radius: 16px;
      border: 1px solid rgba(110,210,255,.35);
      background: linear-gradient(180deg, rgba(30,120,160,.38), rgba(0,0,0,.25));
      color: rgba(230,255,255,.96);
      font-weight: 800;
      letter-spacing:.2px;
      cursor:pointer;
      transition: .16s ease;
      box-shadow: 0 0 22px rgba(110,210,255,.10);
    }
    .btnBig:hover{ transform: translateY(-1px); border-color: rgba(110,210,255,.55); }
    .btnBig:active{ transform: translateY(0px); }

    .tele{
      margin-top: 14px;
      padding: 14px;
    }
    .tele h4{
      margin:0 0 10px;
      font-size: 13px;
      letter-spacing:.3px;
      color: rgba(210,250,255,.90);
    }
    .spark{
      height: 110px;
      border-radius: 16px;
      border: 1px solid rgba(110,210,255,.18);
      background: rgba(0,0,0,.26);
      overflow:hidden;
      position:relative;
    }
    canvas#sparkline{ width:100%; height:100%; display:block; }
    .teleFoot{ margin-top: 8px; font-size: 12px; color: rgba(200,245,255,.68); }

    /* Mobile order: header -> buy -> map -> index -> telemetry */
    @media (max-width: 980px){
      .grid{ grid-template-columns: 1fr; }
      .mapFrame{ min-height: 420px; }
      .panel{ order: 3; }
      .mapCard{ order: 2; }
      .rightCol{ order: 1; }
    }
  </style>
</head>

<body>
  <div class="wrap">
    <header class="card">
      <h1>CNT — Centro Natural TEC Amazônia</h1>
      <div class="sub">Mapa ecológico real • Água (azul) • Vegetação (verde) • Transição (amarelo) • Desmatamento (vermelho)</div>
      <div class="chips">
        <div class="chip" id="chipFonte">Fonte: dados públicos governamentais</div>
        <div class="chip" id="chipAno">Ano base: 2025</div>
        <div class="chip btn" id="chipModo">Pontos: carregando…</div>
        <div class="chip btn" id="chipCompra">Compra: Pump.fun</div>
      </div>
    </header>

    <section class="grid">
      <!-- LEFT: Índice -->
      <aside class="card panel" id="leftPanel">
        <h3>CNT (índice único Brasil)</h3>

        <div class="big">
          <div class="val" id="cntVal">--</div>
          <div class="unit">/100</div>
        </div>

        <div class="kv">RAW auditável: <b id="rawVal">--</b></div>

        <div class="rows">
          <div class="row"><b>A — Estado</b><span id="aVal">--</span></div>
          <div class="row"><b>B — Tendência</b><span id="bVal">--</span></div>
          <div class="row"><b>C — Estabilidade</b><span id="cVal">--</span></div>
          <div class="row"><b>Grau</b><span id="gVal">--</span></div>
        </div>

        <div class="subs">Sub-índices</div>
        <div class="subgrid">
          <div class="pill"><b>IBE</b><span id="ibeVal">--</span></div>
          <div class="pill"><b>IAB</b><span id="iabVal">--</span></div>
          <div class="pill"><b>IBI</b><span id="ibiVal">--</span></div>
          <div class="pill"><b>HID</b><span id="hidVal">--</span></div>
          <div class="pill"><b>ENT</b><span id="entVal">--</span></div>
          <div class="pill"><b>PAN</b><span id="panVal">--</span></div>
        </div>

        <div class="status" id="status">Status: iniciando…</div>
      </aside>

      <!-- CENTER: Mapa -->
      <main class="card mapCard">
        <div class="mapFrame" id="mapFrame">
          <img class="mapBase" id="mapBase" alt="Mapa base" />
          <canvas id="holo"></canvas>
        </div>
      </main>

      <!-- RIGHT: Compra + Telemetria -->
      <aside class="rightCol">
        <div class="card panel" id="buyCard">
          <div class="buyTitle">COMPRAR CNT</div>
          <div class="muted">Abre o token no Pump.fun.</div>

          <div style="margin-top:12px; font-size:13px; color:rgba(200,245,255,.85)">Contribuição</div>
          <input class="input" id="contrib" value="0,10" />

          <button class="btnBig" id="buyBtn">Comprar no Pump</button>

          <div style="margin-top:10px; font-size:13px; color:rgba(200,245,255,.85)">
            Estimativa: <b id="estCnt">--</b> CNT
          </div>
          <div style="margin-top:4px; font-size:12px; color:rgba(200,245,255,.65)">Estimativa demo (não é cotação real).</div>
        </div>

        <div class="card tele">
          <h4>TELEMETRIA — Série 10 anos</h4>
          <div class="spark">
            <canvas id="sparkline"></canvas>
          </div>
          <div class="teleFoot" id="teleFoot">Carregando…</div>
        </div>
      </aside>
    </section>
  </div>

  <script>
    // ==========================================================
    // BASE (Local + GitHub Pages) — resolve TODO o problema de path
    // ==========================================================
    const BASE =
      location.hostname.includes("github.io")
        ? "/" + location.pathname.split("/")[1] + "/"
        : "./";

    // Pump.fun do teu token (troque se mudar)
    const PUMP_URL = "https://pump.fun/coin/GCVyjNaCbXkwGUuktyNxSXad4ozmTp2fzQr2jieSpump";

    // ==========================================================
    // Utilitários
    // ==========================================================
    const $ = (id) => document.getElementById(id);

    function clamp(x, a, b){ return Math.max(a, Math.min(b, x)); }
    function fmt(x, d=2){
      if (x === null || x === undefined || Number.isNaN(x)) return "N/D";
      return Number(x).toFixed(d).replace(".", ",");
    }

    async function fetchJSON(url){
      const r = await fetch(url, { cache: "no-store" });
      if(!r.ok) throw new Error("HTTP " + r.status + " " + url);
      return await r.json();
    }

    // ==========================================================
    // Estado global
    // ==========================================================
    const state = {
      cnt: 50,          // índice CNT (0..100)
      raw: 0,
      pulseFactor: 0.6, // vai ser derivado do cnt
      mode: "auto",     // auto / rapido / full
      points: [],
      bounds: null,     // {minLon,maxLon,minLat,maxLat}
      mapReady: false,
      pointsReady: false,
      lastDraw: 0,
      seed: Math.random() * 9999
    };

    // ==========================================================
    // UI events
    // ==========================================================
    $("chipCompra").onclick = () => window.open(PUMP_URL, "_blank", "noopener");
    $("buyBtn").onclick = () => window.open(PUMP_URL, "_blank", "noopener");

    $("chipModo").onclick = () => {
      // alterna modo manual
      if(state.mode === "auto") state.mode = "rapido";
      else if(state.mode === "rapido") state.mode = "full";
      else state.mode = "auto";
      applyModeLabel();
      reloadPoints();
    };

    function applyModeLabel(){
      const label =
        state.mode === "auto" ? "Pontos: auto" :
        state.mode === "rapido" ? "Pontos: rápido" :
        "Pontos: full";
      $("chipModo").textContent = label;
    }

    // ==========================================================
    // Carrega dados CNT (painel) e usa isso pra “energia” do holograma
    // ==========================================================
    async function loadCNT(){
      try{
        const data = await fetchJSON(BASE + "dados_cnt.json");

        // Aceita vários formatos
        const cnt = data.cnt ?? data.CNT ?? data.indice ?? data.index ?? data.valor ?? 72.4;
        const raw = data.raw ?? data.RAW ?? data.auditavel ?? data.audit ?? 18.11;

        const A = data.A ?? data.estado ?? data.a ?? 72.43;
        const B = data.B ?? data.tendencia ?? data.b ?? -0.10;
        const C = data.C ?? data.estabilidade ?? data.c ?? 0.49;
        const G = data.grau ?? data.Grau ?? data.g ?? "E";

        const subs = data.subindices ?? data.sub ?? data.sub_index ?? {};
        const IBE = subs.IBE ?? data.IBE ?? 55.2;
        const IAB = subs.IAB ?? data.IAB ?? null;
        const IBI = subs.IBI ?? data.IBI ?? 23.5;
        const HID = subs.HID ?? data.HID ?? 1.03;
        const ENT = subs.ENT ?? data.ENT ?? 86.2;
        const PAN = subs.PAN ?? data.PAN ?? 11.7;

        state.cnt = clamp(Number(cnt), 0, 100);
        state.raw = Number(raw) || 0;

        // energia do holograma (quanto maior o CNT, mais “vivo”)
        state.pulseFactor = 0.35 + (state.cnt / 100) * 0.85;

        $("cntVal").textContent = fmt(state.cnt, 1);
        $("rawVal").textContent = fmt(state.raw, 2);
        $("aVal").textContent = fmt(A, 2);
        $("bVal").textContent = fmt(B, 2);
        $("cVal").textContent = fmt(C, 2);
        $("gVal").textContent = (typeof G === "string" ? G : String(G));

        $("ibeVal").textContent = fmt(IBE, 1);
        $("iabVal").textContent = (IAB === null ? "N/D" : fmt(IAB, 1));
        $("ibiVal").textContent = fmt(IBI, 1);
        $("hidVal").textContent = fmt(HID, 2);
        $("entVal").textContent = fmt(ENT, 1);
        $("panVal").textContent = fmt(PAN, 1);

        // estimativa demo
        $("estCnt").textContent = (14744913).toLocaleString("pt-BR");

        $("status").textContent = "Status: OK • Base: " + BASE;

      }catch(err){
        $("status").textContent = "Status: erro ao ler dados_cnt.json • " + err.message;
      }
    }

    // ==========================================================
    // Bound do Brasil (pra projetar lon/lat em pixels no mapa base)
    // ==========================================================
    function computeBoundsFromGeoJSON(gj){
      let minLon=  999, minLat=  999;
      let maxLon= -999, maxLat= -999;

      function scanCoords(coords){
        // coords pode ser [lon,lat] ou arrays aninhados
        if(typeof coords[0] === "number" && typeof coords[1] === "number"){
          const lon = coords[0], lat = coords[1];
          if(lon < minLon) minLon = lon;
          if(lon > maxLon) maxLon = lon;
          if(lat < minLat) minLat = lat;
          if(lat > maxLat) maxLat = lat;
        } else {
          for(const c of coords) scanCoords(c);
        }
      }

      if(gj.type === "FeatureCollection"){
        for(const f of gj.features){
          if(f.geometry && f.geometry.coordinates) scanCoords(f.geometry.coordinates);
        }
      } else if(gj.type === "Feature"){
        scanCoords(gj.geometry.coordinates);
      } else if(gj.coordinates){
        scanCoords(gj.coordinates);
      }

      return {minLon, maxLon, minLat, maxLat};
    }

    async function loadBrazilBounds(){
      // tenta simplificado, depois completo
      const candidates = ["BR_IBGE_simplificado.geojson", "BR_IBGE.geojson", "uf.geojson"];
      for(const file of candidates){
        try{
          const gj = await fetchJSON(BASE + file);
          state.bounds = computeBoundsFromGeoJSON(gj);
          return;
        }catch(e){}
      }

      // fallback aproximado
      state.bounds = { minLon:-74.0, maxLon:-34.0, minLat:-34.0, maxLat:5.5 };
    }

    // Projeção simples (equirectangular no bounding box)
    function lonLatToPx(lon, lat, w, h){
      const b = state.bounds;
      const x = (lon - b.minLon) / (b.maxLon - b.minLon);
      const y = 1 - (lat - b.minLat) / (b.maxLat - b.minLat);
      return { x: x * w, y: y * h };
    }

    // ==========================================================
    // Carrega pontos (MapBiomas/IBGE) e transforma em lista renderizável
    // ==========================================================
    function classToColor(cls){
      // Você pediu: azul água, verde vegetação, amarelo transição, vermelho desmatamento
      // Aceita muitos nomes diferentes
      const c = (cls || "").toString().toLowerCase();

      if(c.includes("agua") || c.includes("hid") || c.includes("river") || c.includes("water")) return "blue";
      if(c.includes("veg") || c.includes("flore") || c.includes("forest") || c.includes("mata")) return "green";
      if(c.includes("trans") || c.includes("agro") || c.includes("past") || c.includes("lavoura") || c.includes("mosaico")) return "yellow";
      if(c.includes("desmat") || c.includes("defor") || c.includes("fogo") || c.includes("burn") || c.includes("degrad")) return "red";

      // fallback: se tiver valor numérico (0..1) tenta mapear
      const v = Number(cls);
      if(!Number.isNaN(v)){
        if(v < 0.25) return "blue";
        if(v < 0.55) return "green";
        if(v < 0.8) return "yellow";
        return "red";
      }

      return "green";
    }

    function pickPointFiles(){
      const isMobile = matchMedia("(max-width: 980px)").matches;
      if(state.mode === "rapido") return ["vege_pts_sample.geojson", "layers_points.json"];
      if(state.mode === "full") return ["layers_points.json", "vege_pts.geojson", "vege_pts_sample.geojson"];
      // auto
      return isMobile
        ? ["vege_pts_sample.geojson", "layers_points.json"]
        : ["layers_points.json", "vege_pts.geojson", "vege_pts_sample.geojson"];
    }

    async function loadPoints(){
      state.pointsReady = false;
      $("status").textContent = "Status: carregando pontos…";

      const files = pickPointFiles();

      for(const file of files){
        try{
          const data = await fetchJSON(BASE + file);
          const pts = [];

          // 1) layers_points.json (custom)
          if(Array.isArray(data)){
            for(const p of data){
              const lon = p.lon ?? p[0];
              const lat = p.lat ?? p[1];
              const cls = p.class ?? p.tipo ?? p.layer ?? p.c ?? "green";
              if(typeof lon === "number" && typeof lat === "number"){
                pts.push({
                  lon, lat,
                  color: classToColor(cls),
                  seed: Math.random()
                });
              }
            }
          } else if(data && data.points && Array.isArray(data.points)){
            for(const p of data.points){
              const lon = p.lon ?? p[0];
              const lat = p.lat ?? p[1];
              const cls = p.class ?? p.tipo ?? p.layer ?? p.c ?? "green";
              if(typeof lon === "number" && typeof lat === "number"){
                pts.push({ lon, lat, color: classToColor(cls), seed: Math.random() });
              }
            }
          }

          // 2) GeoJSON (FeatureCollection)
          if(pts.length === 0 && data && data.type === "FeatureCollection"){
            for(const f of data.features){
    
