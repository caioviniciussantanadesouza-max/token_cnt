<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>CNT — Centro Natural TEC Amazônia</title>

<style>
html,body{
  margin:0;
  height:100%;
  background:#000;
  overflow:hidden;
  font-family:Arial, sans-serif;
  color:#c8f3ff;
}
#app{
  position:fixed;
  inset:0;
  display:grid;
  grid-template-columns: 300px 1fr 360px;
  grid-template-rows: 120px 1fr;
  gap:14px;
  padding:14px;
}
.glass{
  background: rgba(2,12,24,.46);
  border:1px solid rgba(110,210,255,.18);
  border-radius:22px;
}
#header{
  grid-column:1 / 4;
  padding:14px;
  text-align:center;
}
#center{
  position:relative;
  overflow:hidden;
}
#mapWrap{
  position:absolute;
  inset:0;
}
.layer{
  position:absolute;
  inset:0;
}
#yearIndicator{
  position:absolute;
  top:20px;
  left:50%;
  transform:translateX(-50%);
  font-size:28px;
  color:#00ffff;
  text-shadow:0 0 12px #00ffff;
  z-index:1000;
  letter-spacing:3px;
}
</style>
</head>

<body>
<div id="app">

<div id="header" class="glass">
<h2>CNT — Centro Natural TEC Amazônia</h2>
Loop ecológico real 2000 → 2025
</div>

<div class="glass"></div>

<div id="center" class="glass">
<div id="mapWrap">
<canvas id="cnvPoints" class="layer"></canvas>
<div id="yearIndicator">2000</div>
</div>
</div>

<div class="glass"></div>

</div>

<script>

// =============================
// CONFIG
// =============================

const MIN_YEAR = 2000;
const MAX_YEAR = 2025;
const YEAR_DURATION = 5000; // 5s por ano (suave)

let currentYear = MIN_YEAR;
let yearCache = {};
let bbox = null;
let pulseTime = 0;

// =============================
// CANVAS
// =============================

const cnv = document.getElementById("cnvPoints");
const ctx = cnv.getContext("2d");

function resize(){
  const w = cnv.parentElement.clientWidth;
  const h = cnv.parentElement.clientHeight;
  cnv.width = w;
  cnv.height = h;
}
window.addEventListener("resize", resize);
resize();

// =============================
// PROJECTION
// =============================

function calcBBox(fc){
  let minx=Infinity,miny=Infinity,maxx=-Infinity,maxy=-Infinity;
  fc.features.forEach(f=>{
    const [x,y]=f.geometry.coordinates;
    if(x<minx)minx=x;
    if(y<miny)miny=y;
    if(x>maxx)maxx=x;
    if(y>maxy)maxy=y;
  });
  return [minx,miny,maxx,maxy];
}

function proj(lon,lat){
  const [minx,miny,maxx,maxy]=bbox;
  return [
    (lon-minx)/(maxx-minx)*cnv.width,
    (maxy-lat)/(maxy-miny)*cnv.height
  ];
}

// =============================
// COLOR
// =============================

function getColor(type){
  if(type==="vegetation") return [0,255,100];
  if(type==="deforestation") return [255,255,0];
  if(type==="urban") return [255,0,0];
  if(type==="hydro") return [0,170,255];
  return [255,255,255];
}

// =============================
// LOOP CONTROL
// =============================

let lastYearSwitch = 0;

function updateYear(timestamp){
  if(timestamp - lastYearSwitch > YEAR_DURATION){
    currentYear++;
    if(currentYear > MAX_YEAR) currentYear = MIN_YEAR;
    document.getElementById("yearIndicator").innerText = currentYear;
    lastYearSwitch = timestamp;
  }
}

// =============================
// RENDER LOOP (SUPER LEVE)
// =============================

function animate(timestamp){

  updateYear(timestamp);

  ctx.clearRect(0,0,cnv.width,cnv.height);
  ctx.globalCompositeOperation="lighter";

  const points = yearCache[currentYear] || [];

  pulseTime += 0.02;

  for(let p of points){

    const pulse = 0.6 + 0.4 * Math.sin(pulseTime + p.phase);
    const alpha = 0.25 + 0.5 * pulse;

    ctx.beginPath();
    ctx.fillStyle = `rgba(${p.color[0]},${p.color[1]},${p.color[2]},${alpha})`;
    ctx.arc(p.x, p.y, 1.2 + 1.8 * pulse, 0, Math.PI*2);
    ctx.fill();
  }

  ctx.globalCompositeOperation="source-over";
  requestAnimationFrame(animate);
}

// =============================
// INIT
// =============================

async function init(){

  const res = await fetch("vege_pts.geojson");
  const data = await res.json();

  bbox = calcBBox(data);

  // Pré-processamento: organiza por ano
  data.features.forEach(f=>{
    const year = Number(f.properties.year);
    if(!yearCache[year]) yearCache[year] = [];

    const [x,y] = proj(
      f.geometry.coordinates[0],
      f.geometry.coordinates[1]
    );

    yearCache[year].push({
      x,
      y,
      color: getColor(f.properties.type),
      phase: Math.random()*Math.PI*2
    });
  });

  requestAnimationFrame(animate);
}

init();

</script>
</body>
</html>
