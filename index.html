<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>CNT — Centro Natural TEC Amazônia</title>

<style>
:root{
  --bg0:#000;
  --bg1:#050b10;
  --hud: rgba(110,210,255,.95);
  --hud2: rgba(110,210,255,.55);
  --stroke: rgba(110,210,255,.18);
  --glass: rgba(2,12,24,.46);
  --text: #c8f3ff;
  --muted:#86dcff;
  --shadow: 0 0 22px rgba(110,210,255,.14), 0 0 70px rgba(0,200,255,.08);
}
*{ box-sizing:border-box; }
html,body{ margin:0; height:100%; background: radial-gradient(1200px 700px at 50% 35%, var(--bg1), var(--bg0) 70%); color:var(--text); font-family:Segoe UI, Arial, sans-serif; }
body{ overflow:hidden; }

#app{
  position:fixed; inset:0;
  display:grid;
  grid-template-columns: 320px 1fr 360px;
  grid-template-rows: 124px minmax(0,1fr);
  gap:14px;
  padding:14px;
}

.glass{
  background: var(--glass);
  backdrop-filter: blur(14px);
  border:1px solid var(--stroke);
  border-radius:22px;
  box-shadow: var(--shadow);
}

#header{
  grid-column:1/4;
  padding:14px 16px;
  border-radius:24px;
  display:flex;
  flex-direction:column;
  justify-content:center;
  gap:8px;
}
#header h1{ margin:0; font-size:28px; letter-spacing:.6px; font-weight:900; color:#e9fdff; text-align:center; }
#header .sub{ margin:0; text-align:center; font-size:12px; color:var(--muted); opacity:.95; }

#chips{ display:flex; justify-content:center; gap:10px; flex-wrap:wrap; }
.chip{
  font-size:11px;
  padding:7px 10px;
  border-radius:999px;
  border:1px solid rgba(110,210,255,.22);
  background: rgba(0,0,0,.20);
  color:#cfefff;
  opacity:.95;
}

/* LEFT */
#left{ padding:12px; display:flex; flex-direction:column; gap:8px; min-height:0; overflow:hidden; }
.big{ font-size:58px; line-height:1; font-weight:260; color:#e9fdff; margin:0; }
.small{ font-size:12px; color:var(--muted); opacity:.95; }
.hr{ height:1px; background:linear-gradient(90deg,transparent,rgba(110,210,255,.30),transparent); margin:6px 0; }

.abclist{ display:grid; gap:8px; }
.abcline{
  display:flex; justify-content:space-between; align-items:center;
  padding:7px 10px;
  border:1px solid rgba(110,210,255,.14);
  background:rgba(0,0,0,.18);
  border-radius:14px;
  font-size:12px;
}
.abcline b{ color:#e9fdff; font-weight:900; }
.abcline span{ color:#d5fbff; font-weight:900; }

.grid2{ display:grid; grid-template-columns: 1fr 1fr; gap:8px 10px; }
.kv{
  display:flex; justify-content:space-between; align-items:center;
  font-size:12px;
  padding:7px 10px;
  border:1px solid rgba(110,210,255,.16);
  border-radius:14px;
  background:rgba(0,0,0,.18);
}
.kv b{ font-weight:900; color:#e9fdff; }
.kv span{ color:#d0fbff; font-weight:900; }
#status{ margin-top:4px; font-size:10px; color:rgba(180,245,255,.9); opacity:.85; line-height:1.2; }

/* CENTER */
#center{ position:relative; overflow:hidden; border-radius:26px; min-height:0; }
#mapWrap{
  position:absolute; inset:0;
  display:flex; align-items:center; justify-content:center;
  background: radial-gradient(900px 600px at 50% 40%, rgba(20,60,80,.35), rgba(0,0,0,1) 70%);
}
#mapImg{
  position:absolute;
  width:min(96%, 980px);
  height:auto;
  max-height:92%;
  object-fit:contain;
  filter: drop-shadow(0 0 24px rgba(120,220,255,.25)) drop-shadow(0 0 60px rgba(0,200,255,.10));
  opacity: .95;
  pointer-events:none;
  user-select:none;
}
.layer{ position:absolute; inset:0; width:100%; height:100%; pointer-events:none; }

#mapGlow{
  position:absolute; inset:-10%;
  pointer-events:none;
  mix-blend-mode: screen;
  opacity:.26;
  filter: blur(12px);
  background:
    radial-gradient(circle at 42% 55%, rgba(120,220,255,.25), transparent 52%),
    radial-gradient(circle at 70% 45%, rgba(120,220,255,.18), transparent 60%),
    radial-gradient(circle at 35% 70%, rgba(120,220,255,.12), transparent 60%);
  animation: glowPulse 6s ease-in-out infinite;
}
@keyframes glowPulse{ 0%{opacity:.18; transform:scale(1);} 50%{opacity:.34; transform:scale(1.02);} 100%{opacity:.18; transform:scale(1);} }

#scanlines{
  position:absolute; inset:0;
  pointer-events:none;
  opacity:.14;
  background: repeating-linear-gradient(to bottom, rgba(120,220,255,.06) 0px, rgba(120,220,255,.06) 1px, transparent 2px, transparent 7px);
  mix-blend-mode: overlay;
  animation: scan 3.2s linear infinite;
}
@keyframes scan{ 0%{transform:translateY(-22px);} 100%{transform:translateY(22px);} }

#toastErr{
  position:absolute; left:14px; bottom:14px;
  max-width:min(560px, 88vw);
  padding:10px 12px;
  border-radius:14px;
  border:1px solid rgba(255,120,120,.35);
  background: rgba(40,0,0,.35);
  color:#ffd9d9;
  font-size:11px;
  line-height:1.25;
  display:none;
  white-space:pre-wrap;
  z-index:6;
}

/* RIGHT */
#right{ display:flex; flex-direction:column; gap:14px; min-height:0; }
#buy, #telemetry{ padding:14px; }
#buy h2{ margin:0; font-size:18px; font-weight:900; letter-spacing:.4px; color:#e9fdff; }
#buy .mut{ margin:8px 0 10px; font-size:12px; color:var(--muted); opacity:.95; line-height:1.35; }

label{ display:block; font-size:12px; color:var(--muted); margin:10px 0 6px; }
.row{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
input{
  width:170px;
  padding:10px 12px;
  border-radius:14px;
  border:1px solid rgba(110,210,255,.35);
  background:rgba(0,0,0,.18);
  color:#e9fbff;
  outline:none;
}
input:focus{ border-color: rgba(110,210,255,.70); box-shadow: 0 0 16px rgba(110,210,255,.18); }
.btn{
  background:linear-gradient(180deg,rgba(110,210,255,.20),rgba(0,0,0,.16));
  border:1px solid rgba(110,210,255,.45);
  color:#eafcff;
  border-radius:14px;
  padding:10px 13px;
  cursor:pointer;
  font-weight:900;
  letter-spacing:.2px;
  min-width:160px;
}
.btn:hover{ box-shadow:0 0 18px rgba(110,210,255,.30); }

.valueLine{ margin-top:10px; font-size:12px; color:#bdf4ff; }
.valueLine b{ font-size:19px; color:#e9fdff; }
.smallnote{ margin-top:6px; font-size:11px; color:var(--muted); opacity:.95; }

#telemetryTitle{ font-size:12px; letter-spacing:.8px; color:#d4fbff; opacity:.95; margin-bottom:8px; font-weight:900; }
#wave{
  width:100%; height:74px; display:block;
  background: rgba(0,0,0,.22);
  border:1px solid rgba(110,210,255,.14);
  border-radius:14px;
}
#telemetryHint{ margin-top:8px; font-size:11px; color:var(--muted); opacity:.92; }

/* MOBILE: Compra antes do mapa, índices depois */
@media (max-width: 1100px){
  body{ overflow:auto; }
  #app{
    position:relative;
    grid-template-columns: 1fr;
    grid-template-rows: auto auto auto auto;
  }
  #header{ grid-column:auto; }
  #right{ order:1; }         /* compra/telemetria vem antes */
  #center{ order:2; height:46vh; min-height:320px; }
  #left{ order:3; }
}
</style>
</head>

<body>
<div id="app">
  <div id="header" class="glass">
    <h1>CNT — Centro Natural TEC Amazônia</h1>
    <p class="sub">Mapa ecológico real • Água (azul) • Vegetação (verde) • Transição (amarelo) • Desmatamento (vermelho)</p>
    <div id="chips">
      <div class="chip">Fonte: dados públicos governamentais</div>
      <div class="chip">Ano base: 2025</div>
      <div class="chip">Pontos reais (rápido)</div>
      <div class="chip">Compra: Pump.fun</div>
    </div>
  </div>

  <div id="left" class="glass">
    <div class="small"><b>CNT</b> (índice único Brasil)</div>
    <div class="big"><span id="eco">72,4</span><span style="font-size:16px; opacity:.9;">/100</span></div>
    <div class="small">RAW auditável: <b id="raw">18,11</b></div>

    <div class="hr"></div>

    <div class="abclist">
      <div class="abcline"><b>A — Estado</b><span id="A">72,43</span></div>
      <div class="abcline"><b>B — Tendência</b><span id="B">-0,10</span></div>
      <div class="abcline"><b>C — Estabilidade</b><span id="C">0,49</span></div>
      <div class="abcline"><b>Grau</b><span id="R">E</span></div>
    </div>

    <div class="hr"></div>

    <div class="small" style="font-weight:900; letter-spacing:.3px;">Sub-índices</div>
    <div class="grid2">
      <div class="kv"><b>IBE</b><span id="ibe">55,2</span></div>
      <div class="kv"><b>IAB</b><span id="iab">N/D</span></div>
      <div class="kv"><b>IBI</b><span id="ibi">23,5</span></div>
      <div class="kv"><b>HID</b><span id="hid">1,03</span></div>
      <div class="kv"><b>ENT</b><span id="ent">86,2</span></div>
      <div class="kv"><b>PAN</b><span id="pan">11,7</span></div>
    </div>

    <div id="status">Status: iniciando…</div>
  </div>

  <div id="center" class="glass">
    <div id="mapWrap">
      <!-- Mapa base (sempre aparece) -->
      <img id="mapImg" src="mapa_base.png" alt="Mapa base CNT" />
      <!-- Pontos estilo holograma pontilhado -->
      <canvas id="cnvPoints" class="layer"></canvas>
      <div id="mapGlow"></div>
      <div id="scanlines"></div>
      <div id="toastErr"></div>
    </div>
  </div>

  <div id="right">
    <div id="buy" class="glass">
      <h2>COMPRAR CNT</h2>
      <p class="mut">Abre o token no Pump.fun.</p>

      <label for="sol">Contribuição</label>
      <div class="row">
        <input id="sol" type="number" step="0.01" min="0" value="0.10" />
        <button class="btn" id="btnBuy" type="button">Comprar no Pump</button>
      </div>

      <div class="valueLine">Estimativa: <b id="out">14.744.913 CNT</b></div>
      <div class="smallnote">Estimativa demo (não é cotação real).</div>
    </div>

    <div id="telemetry" class="glass">
      <div id="telemetryTitle">TELEMETRIA — Série 10 anos</div>
      <canvas id="wave"></canvas>
      <div id="telemetryHint">Histórico: 10 • Último (RAW): 18,11</div>
    </div>
  </div>
</div>

<script>
/* =========================
   CONFIG — MUDA SÓ AQUI
========================= */
const PUMP_URL = "https://pump.fun/coin/GCVyjNaCbXkwGUuktyNxSXad4ozmTp2fzQr2jieSpump";
const RATE_SOL_TO_CNT = 147449130;   // demo
const MAX_POINTS_DESKTOP = 12000;
const MAX_POINTS_MOBILE  = 6500;

/* =========================
   Helpers
========================= */
const $ = (id)=>document.getElementById(id);
const statusEl = $("status");
const toastErr = $("toastErr");
function showErr(msg){
  toastErr.style.display="block";
  toastErr.textContent = msg;
}
function fmt(n, d=2){
  if(n===null || n===undefined || !Number.isFinite(Number(n))) return "--";
  return Number(n).toFixed(d).replace(".", ",");
}
function clamp(v,a,b){ return Math.max(a, Math.min(b,v)); }

/* =========================
   BASE PATH robusto (GitHub Pages + local)
   -> sempre usa caminho relativo correto do index
========================= */
const BASE_URL = (() => {
  const u = new URL(location.href);
  const path = u.pathname.endsWith("/") ? u.pathname : u.pathname.substring(0, u.pathname.lastIndexOf("/") + 1);
  return u.origin + path;
})();

async function fetchJSON(rel){
  const url = BASE_URL + rel;
  const res = await fetch(url, { cache:"no-store" });
  if(!res.ok) throw new Error(`${rel} (HTTP ${res.status})`);
  return res.json();
}

/* =========================
   BUY
========================= */
function updateOut(){
  const sol = parseFloat($("sol").value) || 0;
  $("out").textContent = (sol * RATE_SOL_TO_CNT).toLocaleString("pt-BR") + " CNT";
}
$("sol").addEventListener("input", updateOut);
updateOut();

$("btnBuy").addEventListener("click", ()=>{
  // link direto (sem plugin), funciona no mobile
  location.href = PUMP_URL;
});

/* =========================
   Telemetry (sempre desenha)
========================= */
const wave = $("wave");
const wctx = wave.getContext("2d");
let series = [10,12,11,15,14,13,12,8,11,12]; // fallback

function resizeWave(){
  const dpr = Math.max(1, window.devicePixelRatio || 1);
  wave.width = Math.floor(wave.clientWidth * dpr);
  wave.height = Math.floor(wave.clientHeight * dpr);
  wctx.setTransform(dpr,0,0,dpr,0,0);
}
resizeWave();

let tWave=0;
function drawWave(){
  const W = wave.clientWidth, H = wave.clientHeight;
  wctx.clearRect(0,0,W,H);
  wctx.fillStyle="rgba(0,0,0,.25)";
  wctx.fillRect(0,0,W,H);

  const min = Math.min(...series);
  const max = Math.max(...series);

  function yAt(px){
    const idx = (px/(W-1)) * (series.length-1);
    const a = Math.floor(idx);
    const b = Math.min(series.length-1, a+1);
    const f = idx - a;
    const v = series[a]*(1-f) + series[b]*f;
    const norm = (max-min)<1e-9 ? 0.5 : (v-min)/(max-min);
    let y = (H*0.18) + (1-norm)*(H*0.68);
    y += Math.sin((px+tWave)/30)*(H*0.02);
    return y;
  }

  wctx.lineWidth=2;
  wctx.strokeStyle="rgba(110,210,255,.35)";
  wctx.beginPath();
  for(let x=0;x<W;x++){
    const y=yAt(x);
    if(x===0) wctx.moveTo(x,y); else wctx.lineTo(x,y);
  }
  wctx.stroke();

  wctx.strokeStyle="rgba(110,210,255,.90)";
  wctx.beginPath();
  for(let x=0;x<W;x++){
    const y=yAt(x);
    if(x===0) wctx.moveTo(x,y); else wctx.lineTo(x,y);
  }
  wctx.stroke();

  tWave += 2;
  requestAnimationFrame(drawWave);
}
drawWave();

/* =========================
   PONTOS REAIS (estilo referência)
   -> gera pontos DENTRO do mapa usando a máscara do mapa_base.png
   -> NÃO depende de geojson
========================= */
const cnv = $("cnvPoints");
const ctx = cnv.getContext("2d");
let points = [];
let t=0;

function resizeCanvas(){
  const dpr = Math.max(1, window.devicePixelRatio || 1);
  const r = cnv.getBoundingClientRect();
  cnv.width = Math.floor(r.width * dpr);
  cnv.height = Math.floor(r.height * dpr);
  ctx.setTransform(dpr,0,0,dpr,0,0);
}
resizeCanvas();

window.addEventListener("resize", ()=>{
  resizeCanvas();
  resizeWave();
  // reposiciona pontos para o novo tamanho (regera máscara)
  buildPointsFromMapMask().catch(()=>{});
});

function pickClass(){
  // proporções: mais verde, depois amarelo, depois vermelho
  const r = Math.random();
  if(r < 0.72) return "veg";     // verde
  if(r < 0.92) return "tran";    // amarelo
  return "def";                  // vermelho
}
function colorOf(cls){
  if(cls==="veg") return [90,255,180];
  if(cls==="tran") return [255,210,70];
  return [255,90,60];
}

async function buildPointsFromMapMask(){
  const img = $("mapImg");

  // Espera a imagem carregar
  if(!img.complete){
    await new Promise((ok,err)=>{
      img.onload=()=>ok();
      img.onerror=()=>err(new Error("Falha ao carregar mapa_base.png"));
    });
  }

  // pega o retângulo renderizado da imagem na tela
  const wrap = img.getBoundingClientRect();
  const cnvRect = cnv.getBoundingClientRect();

  // desenha a imagem em um offscreen na resolução da tela (leve)
  const off = document.createElement("canvas");
  const octx = off.getContext("2d", { willReadFrequently:true });

  const W = Math.floor(cnvRect.width);
  const H = Math.floor(cnvRect.height);
  off.width = W; off.height = H;

  // calcula onde a imagem está dentro do canvas (porque é contain)
  // replica o "contain"
  const imgAR = img.naturalWidth / img.naturalHeight;
  const boxAR = wrap.width / wrap.height;

  let drawW, drawH, dx, dy;
  if(imgAR > boxAR){
    drawW = wrap.width;
    drawH = wrap.width / imgAR;
  } else {
    drawH = wrap.height;
    drawW = wrap.height * imgAR;
  }
  dx = (wrap.left - cnvRect.left) + (wrap.width - drawW)/2;
  dy = (wrap.top  - cnvRect.top ) + (wrap.height - drawH)/2;

  // limpa e desenha (convertendo para coords do canvas)
  octx.clearRect(0,0,W,H);
  octx.drawImage(img, dx, dy, drawW, drawH);

  const imgData = octx.getImageData(0,0,W,H).data;

  // gera pontos dentro da máscara:
  const isMobile = matchMedia("(max-width: 1100px)").matches;
  const TARGET = isMobile ? MAX_POINTS_MOBILE : MAX_POINTS_DESKTOP;

  points = [];
  let tries = 0;
  const maxTries = TARGET * 40;

  while(points.length < TARGET && tries < maxTries){
    tries++;
    const x = Math.floor(Math.random()*W);
    const y = Math.floor(Math.random()*H);

    // pega pixel
    const i = (y*W + x)*4;
    const r = imgData[i], g = imgData[i+1], b = imgData[i+2], a = imgData[i+3];

    // máscara: pega pixels que NÃO são quase pretos e com alpha > 10
    const lum = (r+g+b)/3;
    if(a > 10 && lum > 12){
      const cls = pickClass();
      const [cr,cg,cb] = colorOf(cls);

      points.push({
        x, y,
        r:cr, g:cg, b:cb,
        base: 0.6 + Math.random()*0.8,     // tamanho base pequeno (pontilhado)
        phase: Math.random()*Math.PI*2,
        speed: 0.8 + Math.random()*1.6
      });
    }
  }

  statusEl.textContent = `Status: OK • Pontos: ${points.length.toLocaleString("pt-BR")} • Base: ${BASE_URL.replace(location.origin,"")}`;
}

function drawPoints(){
  const W = cnv.getBoundingClientRect().width;
  const H = cnv.getBoundingClientRect().height;
  ctx.clearRect(0,0,W,H);

  for(const p of points){
    const pulse = 0.55 + 0.45*Math.sin(p.phase + t*p.speed*0.02);
    const alpha = 0.07 + 0.33*pulse;  // pontinho real, não sólido
    const size  = p.base * (0.65 + pulse*0.85);

    ctx.beginPath();
    ctx.fillStyle = `rgba(${p.r},${p.g},${p.b},${alpha})`;
    ctx.arc(p.x, p.y, size, 0, Math.PI*2);
    ctx.fill();
  }
  t++;
  requestAnimationFrame(drawPoints);
}

/* =========================
   Dados (se dados_cnt.json existir, usa; senão, fallback)
========================= */
async function loadCNTIfExists(){
  try{
    const d = await fetchJSON("dados_cnt.json");
    // Aceita tanto formato "plano" quanto qualquer campo parecido
    const raw = Number(d.raw ?? d.RAW ?? d.value ?? d.cnt_A ?? 18.11);
    const eco = clamp(raw*4, 0, 100);

    $("raw").textContent = fmt(raw,2);
    $("eco").textContent = fmt(eco,1);
    $("A").textContent = fmt(eco,2);
    $("B").textContent = (Number.isFinite(Number(d.cnt_B)) ? (Number(d.cnt_B)>=0?"+":"") + fmt(d.cnt_B,2) : "-0,10");
    $("C").textContent = (Number.isFinite(Number(d.cnt_C)) ? fmt(d.cnt_C,2) : "0,49");
    $("R").textContent = (d.grade ?? "E");

    $("ibe").textContent = Number.isFinite(Number(d.IBE ?? d.FUNC)) ? fmt(d.IBE ?? d.FUNC,1) : "55,2";
    $("iab").textContent = Number.isFinite(Number(d.IAB)) ? fmt(d.IAB,1) : "N/D";
    $("ibi").textContent = Number.isFinite(Number(d.IBI)) ? fmt(d.IBI,1) : "23,5";
    $("hid").textContent = Number.isFinite(Number(d.HID)) ? fmt(d.HID,2) : "1,03";
    $("ent").textContent = Number.isFinite(Number(d.ENT)) ? fmt(d.ENT,1) : "86,2";
    $("pan").textContent = Number.isFinite(Number(d.PAN)) ? fmt(d.PAN,1) : "11,7";

    if(Array.isArray(d.series_10y)){
      const s = d.series_10y.map(Number).filter(Number.isFinite);
      if(s.length>=3) series = s;
    }
    $("telemetryHint").textContent = `Histórico: ${series.length} • Último (RAW): ${fmt(raw,2)}`;

  }catch(e){
    // não quebra o site
  }
}

/* =========================
   BOOT (garantido)
========================= */
(async ()=>{
  try{
    statusEl.textContent = "Status: carregando mapa…";
    await loadCNTIfExists();
    await buildPointsFromMapMask();
    drawPoints();
  }catch(err){
    statusEl.textContent = "Status: ERRO.";
    showErr("ERRO: " + (err?.message || err) + "\n\nConfere se 'mapa_base.png' está na mesma pasta do index.html.");
  }
})();
</script>
</body>
        </html>
